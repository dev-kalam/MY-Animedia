<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My-Animedia â€” TV Series Collection</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>

/* Container for search and filter in header */
.header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Adjusting the search box for the header */
.header-search {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(138, 43, 226, 0.2); /* Neon border */
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.3s ease;
    width: 260px; /* Fixed width for header stability */
}

.header-search:focus-within {
    border-color: var(--neon);
    box-shadow: 0 0 10px rgba(138, 43, 226, 0.2);
    background: rgba(0, 0, 0, 0.4);
}

.header-search input {
    font-size: 0.9rem;
    padding: 4px 8px;
    min-width: unset; /* Override previous min-width */
    width: 100%;
}

/* Filter button in header */
.header-filter {
    padding: 8px 16px;
    background: linear-gradient(90deg, rgba(138, 43, 226, 0.1), rgba(138, 43, 226, 0.05));
    border: 1px solid rgba(138, 43, 226, 0.3);
    color: #fff;
    display: flex;
    align-items: center;
    gap: 6px;
    border-radius: 20px;
}

.header-filter:hover {
    background: var(--neon);
    border-color: var(--neon);
    box-shadow: 0 0 15px rgba(43, 189, 226, 0.493);
}

/* Responsive adjustments */
@media (max-width: 900px) {
    /* Hide nav links on small screens to give space to search */
    .nav-links {
        display: none;
    }
    
    .header-actions {
        flex: 1;
        justify-content: flex-end;
    }
    
    .header-search {
        width: 100%;
        max-width: 200px;
    }
}

@media (max-width: 600px) {
    /* On mobile, stack or shrink */
    .brand span {
        display: none; /* Hide brand text, keep logo */
    }
    
    .header-search {
        max-width: 160px;
    }
    
    .header-filter span {
        display: none; /* Hide 'Filter' text, show icon only */
    }
}

        :root {
            --bg-1: #000000;
            --bg-2: #0b0b0b;
            --neon: #00d1c1;
            --accent: #ff6b6b;
            --muted: #9e9e9e;
            --glass-border: rgba(255, 255, 255, 0.04);
            --radius: 14px;
            --transition: 300ms cubic-bezier(.2, .9, .3, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: Inter, 'Segoe UI', Roboto, system-ui, -apple-system;
            background: linear-gradient(180deg, var(--bg-1), var(--bg-2));
            color: #e6eef8;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            line-height: 1.4;
        }

        a {
            color: inherit;
            text-decoration: none
        }

        /* Header */
        /* --------- Header --------- */
        header {
            position: sticky;
            top: 12px; /* a little offset so 3D rim shows */
            z-index: 2000;
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }

        /* Glassy 3D nav container */
        .nav {
            width: calc(100% - 40px);
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px 18px;
            border-radius: 16px;
            background: linear-gradient(180deg,#3a3a3a,#2f2f2f);
            backdrop-filter: blur(6px) saturate(100%);
            -webkit-backdrop-filter: blur(6px) saturate(100%);
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
            transform-style: preserve-3d;
            position: relative;
        }

        /* faux 3D rim (top highlight + bottom shadow) */
        .nav::before {
            content: '';
            position: absolute;
            inset: -8px -14px auto -14px;
            height: 8px;
            border-radius: 10px 10px 0 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            filter: blur(6px);
            pointer-events: none;
            transform: translateZ(-8px) rotateX(6deg);
        }
        .nav::after {
            content: '';
            position: absolute;
            inset: auto -18px -10px -18px;
            height: 20px;
            border-radius: 0 0 12px 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.15));
            filter: blur(10px);
            pointer-events: none;
            transform: translateZ(-18px) rotateX(8deg);
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--neon)
        }

        .brand i {
            font-size: 1.6rem;
            color: var(--accent);
            text-shadow: 0 6px 22px rgba(138, 43, 226, 0.25)
        }

        .nav-links {
            display: flex;
            gap: 14px;
            align-items: center
        }

        .nav-links a {
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 600;
            color: var(--muted);
            transition: var(--transition)
        }

        .nav-links a:hover {
            color: #fff;
            background: linear-gradient(90deg, rgba(138, 43, 226, 0.08), rgba(255, 107, 107, 0.03));
            transform: translateY(-3px)
        }

                /* --------- Nav Search Styles (copied from index.html) --------- */
                .nav-search-box {
                    display: flex;
                    align-items: center;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 20px;
                    padding: 4px 12px;
                    margin: 0 16px;
                    transition: all 0.3s ease;
                    max-width: 300px;
                }

                .nav-search-box:focus-within {
                    background: rgba(255, 255, 255, 0.1);
                    border-color: var(--neon);
                    box-shadow: 0 0 15px rgba(138, 43, 226, 0.2);
                }

                .nav-scope-select {
                    background: transparent;
                    border: none;
                    color: var(--muted);
                    font-size: 0.85rem;
                    outline: none;
                    cursor: pointer;
                    border-right: 1px solid rgba(255, 255, 255, 0.15);
                    margin-right: 8px;
                    padding-right: 8px;
                    font-weight: 600;
                }

                .nav-search-input {
                    background: transparent;
                    border: none;
                    color: #fff;
                    outline: none;
                    font-size: 0.9rem;
                    width: 140px; /* Adjust based on space */
                }

                .nav-search-input::placeholder {
                    color: rgba(255, 255, 255, 0.4);
                }

                .nav-search-btn {
                    background: transparent;
                    border: none;
                    color: var(--neon);
                    cursor: pointer;
                    padding: 4px;
                    display: flex;
                    align-items: center;
                    transition: transform 0.2s;
                }

                .nav-search-btn:hover {
                    transform: scale(1.1);
                    color: #fff;
                }

                @media (max-width: 900px) {
                    .nav-search-box { display: none; }
                }

        .auth {
            display: flex;
            gap: 10px
        }

        .btn {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition)
        }

        .btn.primary {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            box-shadow: 0 8px 30px rgba(138, 43, 226, 0.25)
        }

/* Hero Section */
.hero{
    height:650px;
    position:relative;
    border-radius:0 0 28px 28px;
    overflow:hidden;
    margin-bottom:40px;
}

.hero-backdrop{
    position:absolute;
    inset:0;
    background-size:cover;
    background-position:center;
    z-index:1;
    transition: opacity 0.35s ease, transform 0.35s ease;
}

.hero-overlay{
    position:absolute;inset:0;
    background:linear-gradient(90deg,rgba(0,0,0,.85) 25%,rgba(0,0,0,.2) 70%);
    z-index:2;
}

.hero-content{
    position:absolute;left:120px;bottom:120px;color:#fff;max-width:520px;z-index:3;
    transition: opacity 0.35s ease, transform 0.35s ease;
}

.badge{
    font-size:12px;letter-spacing:1px;opacity:.8;
    background:rgba(255,64,129,0.9);
    display:inline-block;padding:4px 12px;border-radius:4px;margin-bottom:10px;
}

.title{
    font-size:52px;font-weight:700;margin:10px 0;line-height:1.1;
}

.meta{
    display:flex;gap:16px;font-size:14px;opacity:.85;margin-bottom:14px;flex-wrap:wrap;
}

.rating{
    background:#ff4081;color:#000;padding:2px 8px;border-radius:6px;font-weight:600;
    display:flex;align-items:center;gap:5px;
}

.desc{
    font-size:14px;line-height:1.6;opacity:.85;margin-bottom:22px;max-height:80px;overflow:hidden;
}

.tags{
    display:flex;gap:10px;margin-bottom:26px;flex-wrap:wrap;
}

.tag{
    padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.2);
    font-size:12px;cursor:pointer;transition:all 0.2s ease;
}

.tag:hover{
    background:rgba(255,255,255,.3);
}

.actions{
    display:flex;gap:14px;
}

.btn{
    padding:12px 22px;border-radius:999px;border:none;font-weight:600;cursor:pointer;
    transition:all 0.2s ease;display:flex;align-items:center;gap:8px;
}

.btn:hover{
    transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

.primary{
    background:#fff;color:#000;
}

.primary:hover{
    background:#f0f0f0;
}

.secondary{
    background:rgba(255,255,255,.2);color:#fff;
}

.secondary:hover{
    background:rgba(255,255,255,.3);
}

.hero-poster{
    position:absolute;right:70px;bottom:150px;
    width:160px;height:240px;border-radius:18px;
    background-size:cover;background-position:center;
    box-shadow:0 20px 50px rgba(0,0,0,.6);z-index:3;
    cursor:pointer;transition:all 0.3s ease;
}

/* Hero fade state */
.hero.fading .hero-backdrop,
.hero.fading .hero-content,
.hero.fading .hero-poster {
    opacity: 0;
    transform: translateY(10px);
}

.hero-poster:hover{
    transform:scale(1.05);box-shadow:0 25px 60px rgba(0,0,0,.8);
}

.hero-card {
            pointer-events: auto;
            background: linear-gradient(180deg, rgba(4, 6, 14, 0.25), rgba(4, 6, 14, 0.35));
            border-radius: 12px;
            padding: 14px 18px;
            border: 1px solid var(--glass-border);
            display: flex;
            gap: 12px;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            backdrop-filter: blur(3px);
            box-shadow: 0 12px 40px rgba(2, 6, 23, 0.45);
        }

        .hero-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .hero-left .title {
            font-size: 1.25rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--neon), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent
        }

        .hero-left .sub {
            color: var(--muted);
            font-size: 0.95rem
        }

        .hero-actions {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .search-compact {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding-left: 12px
        }

        .search-compact input {
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-weight: 700;
            padding: 8px;
            min-width: 260px
        }

        .small-btn {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--muted);
            font-weight: 700;
            cursor: pointer
        }

        /* Filter buttons, grid, cards */
        .filters {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 22px auto;
            flex-wrap: wrap;
            max-width: 1200px;
            padding: 0 20px
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition)
        }

        .filter-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.25)
        }

        .filter-btn:hover:not(.active) {
            background: rgba(138, 43, 226, 0.1);
            color: #fff
        }

        .section {
            max-width: 1200px;
            margin: 36px auto;
            padding: 0 16px
        }

        .section h2 {
            font-size: 1.4rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .series-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 3rem
        }

        .content-card {
            border-radius: var(--radius);
            overflow: hidden;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            border: 1px solid rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(6px);
            transition: var(--transition);
            cursor: pointer;
            position: relative
        }

        .content-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(2, 6, 23, 0.6);
            border-color: rgba(138, 43, 226, 0.2)
        }

        .art {
            height: 320px;
            background-size: cover;
            background-position: center;
            position: relative
        }

        .body {
            padding: 14px
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: flex-start;
            margin-bottom: 8px
        }

        .meta {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 8px;
            line-height: 1.4
        }

        .badge {
            position: absolute;
            left: 12px;
            top: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            font-weight: 800;
            color: #fff;
            font-size: 0.8rem;
            box-shadow: 0 8px 22px rgba(138, 43, 226, 0.18)
        }

        .status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600
        }

        .status.airing {
            background: rgba(76, 175, 80, 0.16);
            color: #4caf50
        }

        .status.ended {
            background: rgba(33, 150, 243, 0.14);
            color: #2196f3
        }

        .status.returning {
            background: rgba(156, 39, 176, 0.14);
            color: #9c27b0
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 2.2rem 0
        }

        .page-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center
        }

        .page-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.25)
        }

        .page-btn.disabled {
            opacity: 0.45;
            cursor: not-allowed
        }

        /* Modal - Updated for better organization */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1500;
            padding: 20px
        }

        .modal.active {
            display: flex
        }

        .modal .box {
            width: 98%;
            height: 96vh;
            max-width: none;
            max-height: 96vh;
            overflow-y: auto;
            background: linear-gradient(180deg, #041027, #081228);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            padding: 24px;
            position: relative
        }

        .modal .close {
            position: fixed;
            right: 30px;
            top: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center
        }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .modal-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
            font-weight: 600;
        }

        .modal-tab.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
        }

        .modal-tab:hover:not(.active) {
            background: rgba(138, 43, 226, 0.1);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Info Grid - Updated to 60/40 split */
        .info-grid {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 24px;
            margin-bottom: 24px;
        }

        .info-sidebar {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
        }

        .info-sidebar img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-main {
            padding: 10px 0;
        }

        /* Character Details Modal */
        .character-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 20px;
        }

        .character-modal.active {
            display: flex;
        }

        .character-modal .box {
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            background: linear-gradient(180deg, #041027, #081228);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            padding: 24px;
            position: relative;
        }

        .character-modal .close-char {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .character-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        .character-content img {
            width: 100%;
            border-radius: 10px;
            object-fit: cover;
            height: 250px;
        }

        .character-info h2 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1.8rem;
        }

        .character-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .character-detail-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 12px;
            border-radius: 8px;
        }

        .character-detail-item .label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .character-detail-item .value {
            font-weight: 600;
        }

        .character-loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .character-loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(138, 43, 226, 0.18);
            border-bottom-color: var(--neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Cast Grid */
        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .cast-card {
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .cast-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(138, 43, 226, 0.2);
        }

        .cast-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid var(--neon);
        }

        .cast-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .cast-role {
            font-size: 0.8rem;
            color: var(--muted);
        }

        /* Additional Info Sections */
        .additional-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-section h4 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .info-section p {
            color: var(--muted);
            line-height: 1.6;
        }

        /* Seasons Section */
        .seasons-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .seasons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .season-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .season-card:hover {
            transform: translateY(-4px);
            border-color: rgba(138, 43, 226, 0.3);
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.4);
        }

        .season-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .season-info {
            padding: 10px;
        }

        .season-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .season-episodes {
            font-size: 0.75rem;
            color: var(--neon);
            background: rgba(138, 43, 226, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .season-year {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 4px;
        }

        /* Similar Series Section */
        .similar-series-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .similar-series-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .similar-series-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .similar-series-card:hover {
            transform: translateY(-4px);
            border-color: rgba(138, 43, 226, 0.3);
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.4);
        }

        .similar-series-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .similar-series-info {
            padding: 10px;
        }

        .similar-series-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .similar-series-type {
            font-size: 0.75rem;
            color: var(--neon);
            background: rgba(138, 43, 226, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .similar-series-relation {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 4px;
        }

        /* Actor's Top Works Grid */
        .top-works-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .top-work-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .top-work-card:hover {
            transform: translateY(-2px);
            border-color: rgba(138, 43, 226, 0.3);
        }

        .top-work-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .top-work-info {
            padding: 8px;
        }

        .top-work-title {
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.3;
            text-align: center;
        }

        .top-work-rating {
            font-size: 0.7rem;
            color: var(--neon);
            text-align: center;
            margin-top: 4px;
        }

        /* Streaming Buttons */
        .streaming-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .streaming-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .streaming-btn:hover {
            background: rgba(138, 43, 226, 0.1);
            border-color: rgba(138, 43, 226, 0.3);
            color: #fff;
        }

        /* Reviews - Enhanced */
        .reviews-container {
            margin-top: 20px;
        }

        .review-form-expanded {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 24px;
        }

        .review-input,
        .review-text {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
            margin-bottom: 12px;
        }

        .review-rating-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 16px 0;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
        }

        .rating-star {
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s;
            font-size: 1.2rem;
        }

        .rating-star.active {
            color: gold;
        }

        .review-options {
            display: flex;
            gap: 10px;
            margin: 16px 0;
        }

        .review-option-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            text-align: center;
        }

        .review-option-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            border-color: transparent;
        }

        .review-item {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            margin-bottom: 12px
        }

        /* Advanced Search Page */
        .search-page {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-page.active {
            display: block;
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--muted);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-title {
            color: var(--neon);
            font-size: 1.8rem;
        }

        .search-filters-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .filters-sidebar {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .filter-group {
            margin-bottom: 24px;
        }

        .filter-group h3 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-group h3 .clear-btn {
            font-size: 0.8rem;
            color: var(--accent);
            cursor: pointer;
            opacity: 0.7;
        }

        .filter-group h3 .clear-btn:hover {
            opacity: 1;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .filter-options::-webkit-scrollbar {
            width: 6px;
        }

        .filter-options::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 3px;
        }

        .filter-options::-webkit-scrollbar-thumb {
            background: var(--neon);
            border-radius: 3px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .filter-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--neon);
        }

        .filter-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-option .count {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .year-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .year-group select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .year-group select:hover {
            border-color: rgba(138, 43, 226, 0.3);
        }

        .year-group select option {
            background: var(--bg-1);
            color: #fff;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            color: var(--muted);
        }

        .sort-select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
        }

        /* Search Results */
        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .search-result-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: var(--transition);
            cursor: pointer;
        }

        .search-result-card:hover {
            transform: translateY(-5px);
            border-color: rgba(138, 43, 226, 0.2);
            box-shadow: 0 15px 40px rgba(2, 6, 23, 0.5);
        }

        .search-result-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .search-result-info {
            padding: 16px;
        }

        .search-result-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .search-result-meta {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .search-result-desc {
            color: var(--muted);
            font-size: 0.85rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Add to List Modal - UPDATED with review features */
        .add-to-list-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 20px;
        }

        .add-to-list-modal.active {
            display: flex;
        }

        .add-to-list-modal .box {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            background: linear-gradient(180deg, #041027, #081228);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            padding: 24px;
            position: relative;
        }

        .add-to-list-modal .close-list-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .list-option {
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .list-option:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(138, 43, 226, 0.2);
        }

        .list-option.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
        }

        .list-option i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .list-option span {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Review rating in add-to-list modal */
        .list-rating-section {
            margin: 20px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .list-rating-section h4 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .list-rating-stars {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .list-rating-star {
            font-size: 1.8rem;
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s;
        }

        .list-rating-star.active {
            color: gold;
        }

        .list-custom-notes {
            margin-top: 20px;
        }

        .list-custom-notes textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Review Categories */
        .review-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .review-category-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .review-category-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            border-color: transparent;
        }

        .review-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-stats-item {
            text-align: center;
        }

        .review-stats-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neon);
        }

        .review-stats-item .label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 4px;
        }

        /* My List Section */
        .my-list-section {
            display: none;
            max-width: 1200px;
            margin: 36px auto;
            padding: 0 16px;
        }

        .my-list-section.active {
            display: block;
        }

        .list-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .list-tab {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .list-tab.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            border-color: transparent;
        }

        .list-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .list-empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .list-item-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* FIXED: More visible buttons in modal */
        .modal .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(138, 43, 226, 0.4);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .modal .btn:hover {
            background: rgba(138, 43, 226, 0.2);
            border-color: var(--neon);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
        }

        .modal .btn.primary {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            border: 2px solid rgba(138, 43, 226, 0.6);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .modal .btn.primary:hover {
            background: linear-gradient(90deg, #9c4dff, #8a2be2);
            border-color: var(--neon);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.4);
        }

        /* Footer */
        footer {
            margin-top: 40px;
            padding: 28px 16px;
            background: linear-gradient(180deg, rgba(3, 6, 18, 0.3), transparent);
            border-top: 1px solid rgba(255, 255, 255, 0.02)
        }

        .foot-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between
        }

        .small {
            color: var(--muted);
            font-size: 0.9rem
        }

        /* Responsive */
        @media (max-width:900px) {
            .nav-links {
                display: none
            }

            .hero {
                height: 50vh
            }

            .strip .slide {
                height: 88%
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .search-filters-container {
                grid-template-columns: 1fr;
            }

            .filters-sidebar {
                position: static;
            }

            .character-content {
                grid-template-columns: 1fr;
            }

            .additional-info {
                grid-template-columns: 1fr;
            }

            .similar-series-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }

            .seasons-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }

            .list-options-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .review-stats {
                flex-wrap: wrap;
                gap: 15px;
            }

            .top-works-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        @media (max-width:600px) {
            .hero {
                height: 44vh
            }

            .strip .slide {
                height: 80%
            }

            .hero-card {
                flex-direction: column;
                gap: 16px;
            }

            .search-compact input {
                min-width: 200px;
            }

            .review-rating-grid {
                grid-template-columns: 1fr;
            }

            .cast-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .search-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .year-group {
                grid-template-columns: 1fr;
            }

            .character-details-grid {
                grid-template-columns: 1fr;
            }

            .similar-series-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }

            .seasons-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }

            .list-options-grid {
                grid-template-columns: 1fr;
            }

            .review-categories {
                justify-content: center;
            }

            .top-works-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .streaming-buttons {
                justify-content: center;
            }
        }
    </style>
    <style>
    /* Page transition: fade-in on load, fade-out on navigation */
    body { opacity: 0; transition: opacity 260ms ease; }
    body.page-visible { opacity: 1; }
    a.no-transition { transition: none !important; }

    /* Filter button adjustments when placed next to nav search */
    #filter-btn {
        background: transparent;
        border: none;
        color: var(--neon);
        padding: 6px 10px;
        border-radius: 0px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 120ms ease, background 160ms ease, color 160ms ease;
    }

    #filter-btn:hover { transform: scale(1.05); color: #fff; background: rgba(0, 0, 0, 0); }

    @media (max-width: 900px) {
        /* On small screens keep the icon compact */
        #filter-btn { padding: 6px; font-size: 0.95rem; }
    }
    </style>
</head>

<body>
    <header>
        <div class="nav">
            <div class="brand">
                <i class="fas fa-play-circle"></i>My-Animedia 
            </div>

            <nav class="nav-links">
                <a href="index.html">Home</a>
                <a href="anime.html">Anime</a>
                <a href="movie.html">Movies</a>
                <a href="#" class="active">Series</a>
                <a href="manhwa.html">Manhwa</a>
            </nav>

            <div class="nav-search-box">
                
                
                <input type="text" class="nav-search-input" id="search-input" placeholder="Search..." autocomplete="off">
                
                <button class="nav-search-btn" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <button id="filter-btn" class="header-filter" title="Advanced Filter" style="margin-left:0px;padding:-10px 40px;border-radius:999px;font-size:0.9rem;display:flex;align-items:center;gap:8px;">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>

            <div class="auth">
        <div id="auth-buttons" style="display: flex; gap: 10px;">
            <button id="signin-btn" class="btn" onclick="window.location.href='auth.html'">Log in</button>
            <button id="signup-btn" class="btn primary" onclick="window.location.href='auth.html'">Sign up</button>
        </div>

        <div id="profile-buttons" style="display: none; gap: 10px; align-items: center;">
            <button id="profile-btn" class="btn" onclick="window.location.href='profile.html'">
                <i class="fas fa-user-circle"></i> <span id="user-name">Profile</span>
            </button>
            <button id="logout-btn" class="btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>
    </header>

    <!-- Main Content -->
    <div id="main-content">
        <div class="hero" id="heroSection">
            <div class="hero-backdrop" id="heroBackdrop" style="background-image: url('https://images.unsplash.com/photo-1601758123927-1c7a1f2d4a7a?auto=format&fit=crop&w=1400&q=80');"></div>
            <div class="hero-overlay"></div>

            <div class="hero-content" id="heroContent">
                
                <div class="title" id="heroTitle">Sample Series Title</div>
                <div class="meta" id="heroMeta">
                    <div class="rating"><i class="fas fa-star"></i> 0.0</div>
                    <div id="heroType">TV Series</div>
                    <div id="heroRuntime">â€” seasons</div>
                    <div id="heroStatus">Airing</div>
                </div>
                <div class="desc" id="heroDesc">A short sample description for the featured series. Replace via JS as needed.</div>
                <div class="tags" id="heroTags"></div>
                <div class="actions">
                    <button class="btn primary" id="watchBtn">
                        <i class="fas fa-play"></i> View Details
                    </button>
                    <button class="btn secondary" id="addWatchlistBtn">
                        <i class="fas fa-plus"></i> Add to Watchlist
                    </button>
                </div>
            </div>

            <div class="hero-poster" id="heroPoster" style="background-image: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=600&q=80');"></div>
        </div>

        <!-- Hidden strips used by existing script (kept hidden to avoid visual change) -->
        <div id="strip1" class="strip strip-1" style="display:none" aria-hidden="true"></div>
        <div id="strip2" class="strip strip-2" style="display:none" aria-hidden="true"></div>

        <div class="filters">
            <button class="filter-btn active" data-filter="popular">Popular</button>
            <button class="filter-btn" data-filter="airing_today">Airing Today</button>
            <button class="filter-btn" data-filter="on_the_air">On The Air</button>
            <button class="filter-btn" data-filter="top_rated">Top Rated</button>
            <button class="filter-btn" data-filter="10759">Action</button>
            <button class="filter-btn" data-filter="18">Drama</button>
            <button class="filter-btn" data-filter="35">Comedy</button>
            <button class="filter-btn" data-filter="80">Crime</button>
            <button class="filter-btn" data-filter="10765">Sci-Fi</button>
        </div>

        <!-- My List Section -->
        <div class="my-list-section" id="my-list-section">
            <h2><i class="fas fa-bookmark"></i> My Series List</h2>
            <div class="list-tabs">
                <button class="list-tab active" data-list-type="watching">Currently Watching</button>
                <button class="list-tab" data-list-type="planned">Plan to Watch</button>
                <button class="list-tab" data-list-type="completed">Completed</button>
                <button class="list-tab" data-list-type="onhold">On Hold</button>
                <button class="list-tab" data-list-type="favorites">Favorites</button>
            </div>
            <div class="series-grid" id="my-list-grid">
                <!-- List items will be loaded here -->
            </div>
            <div id="list-empty-state" class="list-empty-state" style="display: none;">
                <i class="fas fa-book-open"></i>
                <h3>Your list is empty</h3>
                <p>Add series to your list by clicking "Add to List" in any series's details.</p>
            </div>
        </div>

        <section class="section">
            <h2><i class="fas fa-tv"></i> TV Series Collection</h2>
            <div class="series-grid" id="series-grid">
                <div class="loader"
                    style="grid-column:1/-1;margin:24px auto;width:48px;height:48px;border:5px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite">
                </div>
            </div>
        </section>

        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Advanced Search Page -->
    <div class="search-page" id="search-page">
        <div class="search-header">
            <button class="back-btn" id="back-to-main">
                <i class="fas fa-arrow-left"></i> Back to Browse
            </button>
            <h1 class="search-title">Advanced Series Search</h1>
        </div>

        <div class="search-filters-container">
            <div class="filters-sidebar">
                <div class="filter-group">
                    <h3>Search</h3>
                    <div class="search-compact" style="border:none;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="adv-search-input" placeholder="Search series..." style="background:transparent;border:none;width:100%;">
                    </div>
                </div>

                <div class="filter-group">
                    <h3>Genres <span style="color:var(--muted);font-size:0.8rem;">(Scroll down for more)</span></h3>
                    <div class="filter-options" id="genres-filter" style="max-height: 400px; overflow-y: auto;">
                        <!-- Filled dynamically from TMDb API -->
                    </div>
                </div>

                <div class="filter-group">
                    <h3>First Air Year</h3>
                    <div class="year-group">
                        <select id="year-from">
                            <option value="">From Year</option>
                            <!-- Filled by JavaScript -->
                        </select>
                        <select id="year-to">
                            <option value="">To Year</option>
                            <!-- Filled by JavaScript -->
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>Language</h3>
                    <div class="filter-options" id="language-filter">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <div class="filter-group">
                    <h3>Rating</h3>
                    <div class="filter-options" id="rating-filter">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <div class="filter-group">
                    <h3>Sort By</h3>
                    <select class="sort-select" id="sort-select" style="width:100%;">
                        <option value="popularity.desc">Most Popular</option>
                        <option value="vote_average.desc">Highest Rated</option>
                        <option value="first_air_date.desc">Newest Releases</option>
                        <option value="vote_count.desc">Most Votes</option>
                        <option value="original_name.asc">Title A-Z</option>
                    </select>
                </div>
            </div>

            <div class="search-results-container">
                <div class="search-results-header">
                    <div class="results-count" id="results-count">Select a category to search</div>
                    <select class="sort-select" id="results-sort-select">
                        <option value="popularity.desc">Most Popular</option>
                        <option value="vote_average.desc">Highest Rated</option>
                        <option value="first_air_date.desc">Newest Releases</option>
                        <option value="vote_count.desc">Most Votes</option>
                        <option value="original_name.asc">Title A-Z</option>
                    </select>
                </div>

                <div class="search-results-grid" id="search-results-grid">
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Select a Category</h3>
                        <p>Click on any category to view series</p>
                    </div>
                </div>

                <div class="pagination" id="search-pagination"></div>
            </div>
        </div>
    </div>

    <!-- Modal: details + reviews + watch link - FULL SCREEN -->
    <div class="modal" id="series-modal" aria-hidden="true">
        <div class="box" role="dialog" aria-modal="true"
            aria-labelledby="modal-title">
            <button class="close" id="close-modal" aria-label="Close"><i
                    class="fas fa-times"></i></button>

            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="overview">Overview</button>
                <button class="modal-tab" data-tab="cast">Cast</button>
                <button class="modal-tab" data-tab="seasons">Seasons</button>
                <button class="modal-tab" data-tab="reviews">Reviews</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="overview-tab">
                <div class="info-grid">
                    <div class="info-sidebar">
                        <img id="modal-poster" src alt="poster">
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                                <div class="rating" style="display:flex;align-items:center;gap:6px;">
                                    <i class="fas fa-star" style="color:gold;"></i>
                                    <span id="modal-rating" style="font-weight:bold;font-size:1.3rem;">â€”</span>
                                    <span style="color:var(--muted);">/10</span>
                                </div>
                            </div>
                            
                            <div style="display:grid;gap:10px;">
                                <div><strong>Seasons:</strong> <span id="modal-seasons" style="float:right;">â€”</span></div>
                                <div><strong>Episodes:</strong> <span id="modal-episodes" style="float:right;">â€”</span></div>
                                <div><strong>Status:</strong> <span id="modal-status" style="float:right;">â€”</span></div>
                                <div><strong>First Air:</strong> <span id="modal-first-air" style="float:right;">â€”</span></div>
                                <div><strong>Last Air:</strong> <span id="modal-last-air" style="float:right;">â€”</span></div>
                                <div><strong>Episode Runtime:</strong> <span id="modal-runtime" style="float:right;">â€”</span></div>
                                <div><strong>Language:</strong> <span id="modal-language" style="float:right;">â€”</span></div>
                                <div><strong>Tagline:</strong> <span id="modal-tagline" style="float:right;color:var(--muted);font-style:italic;">â€”</span></div>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <h4 style="color:var(--neon);margin-bottom:10px;">Genres</h4>
                            <div id="modal-genres" style="display:flex;flex-wrap:wrap;gap:6px;">
                                <!-- Genres will be added here -->
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn primary" id="trailer-btn" style="flex:1;">
                                <i class="fab fa-youtube"></i> Watch Trailer
                            </button>
                            <button class="btn" id="add-to-list-btn" style="flex:1;">
                                <i class="fas fa-plus"></i> Add to List
                            </button>
                        </div>
                    </div>

                    <div class="info-main">
                        <h2 id="modal-title" style="margin-bottom:8px;color:var(--neon);font-size:2rem;"></h2>
                        <div id="modal-tagline-full" style="color:var(--accent);font-style:italic;margin-bottom:16px;font-size:1.1rem;">â€”</div>
                        
                        <div style="margin-bottom: 24px;">
                            <h4 style="color:var(--neon);margin-bottom:8px;">Overview</h4>
                            <p id="modal-overview" style="color:var(--muted);line-height:1.7;text-align:justify;">
                                Loading...
                            </p>
                        </div>

                        <div class="additional-info">
                            <div class="info-section">
                                <h4>Production Details</h4>
                                <div id="modal-production" style="color:var(--muted);">
                                    <div style="margin-bottom:8px;"><strong>Networks:</strong> <span id="modal-networks">â€”</span></div>
                                    <div style="margin-bottom:8px;"><strong>Production Companies:</strong> <span id="modal-companies">â€”</span></div>
                                    <div style="margin-bottom:8px;"><strong>Production Countries:</strong> <span id="modal-countries">â€”</span></div>
                                    <div style="margin-bottom:8px;"><strong>Original Title:</strong> <span id="modal-original-title">â€”</span></div>
                                    <div><strong>Homepage:</strong> <a id="modal-homepage" href="#" style="color:var(--neon);">â€”</a></div>
                                </div>
                            </div>
                            
                            <div class="info-section">
                                <h4>Crew</h4>
                                <div id="modal-crew" style="color:var(--muted);">
                                    <div style="margin-bottom:8px;"><strong>Creators:</strong> <span id="modal-creators">â€”</span></div>
                                    <div style="margin-bottom:8px;"><strong>Executive Producers:</strong> <span id="modal-producers">â€”</span></div>
                                    <div style="margin-bottom:8px;"><strong>Writers:</strong> <span id="modal-writers">â€”</span></div>
                                    <div><strong>Directors:</strong> <span id="modal-directors">â€”</span></div>
                                </div>
                            </div>
                            
                            <div class="info-section">
                                <h4>Statistics</h4>
                                <div style="display:grid;gap:6px;">
                                    <div style="display:flex;justify-content:space-between;">
                                        <span>Vote Count:</span>
                                        <span id="modal-vote-count" style="font-weight:bold;">â€”</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;">
                                        <span>Popularity:</span>
                                        <span id="modal-popularity" style="font-weight:bold;">â€”</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;">
                                        <span>Episode Runtime:</span>
                                        <span id="modal-runtime-detail" style="font-weight:bold;">â€”</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;">
                                        <span>Type:</span>
                                        <span id="modal-type" style="font-weight:bold;">â€”</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-section">
                                <h4>Streaming Platforms</h4>
                                <div class="streaming-buttons">
                                    <button class="streaming-btn" data-platform="arc018">
                                        <i class="fas fa-external-link-alt"></i> ARC018
                                    </button>
                                    <button class="streaming-btn" data-platform="seriesbox">
                                        <i class="fas fa-external-link-alt"></i> SeriesBox
                                    </button>
                                    <button class="streaming-btn" data-platform="tvhub">
                                        <i class="fas fa-external-link-alt"></i> TVHub
                                    </button>
                                    <button class="streaming-btn" data-platform="discoveryftp">
                                        <i class="fas fa-external-link-alt"></i> DiscoveryFTP
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Seasons Section -->
                        <div class="seasons-section" id="seasons-section">
                            <h4 style="color:var(--neon);margin-bottom:12px;">
                                <i class="fas fa-layer-group"></i> Series Seasons
                            </h4>
                            <div class="seasons-grid" id="seasons-grid">
                                <!-- Seasons will be loaded here -->
                            </div>
                        </div>

                        <!-- Similar Series Section -->
                        <div class="similar-series-section" id="similar-series-section">
                            <h4 style="color:var(--neon);margin-bottom:12px;">
                                <i class="fas fa-link"></i> Similar Series
                            </h4>
                            <div class="similar-series-grid" id="similar-series-grid">
                                <!-- Similar series cards will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cast Tab -->
            <div class="tab-content" id="cast-tab">
                <h3 style="color:var(--neon);margin-bottom:20px;">Cast & Crew</h3>
                <div class="cast-grid" id="cast-grid">
                    <!-- Cast will be loaded here -->
                </div>
            </div>

            <!-- Seasons Tab -->
            <div class="tab-content" id="seasons-tab">
                <h3 style="color:var(--neon);margin-bottom:20px;">Seasons</h3>
                <div id="seasons-list">
                    <!-- Seasons list will be loaded here -->
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-content" id="reviews-tab">
                <div class="reviews-container">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="color:var(--neon);">User Reviews</h3>
                        <button class="btn" id="open-review-form-btn">
                            <i class="fas fa-pen"></i> Write Review
                        </button>
                    </div>

                    <!-- Review Stats -->
                    <div class="review-stats" id="review-stats">
                        <div class="review-stats-item">
                            <div class="value" id="avg-rating">â€”</div>
                            <div class="label">Average Rating</div>
                        </div>
                        <div class="review-stats-item">
                            <div class="value" id="total-reviews">0</div>
                            <div class="label">Total Reviews</div>
                        </div>
                        <div class="review-stats-item">
                            <div class="value" id="positive-reviews">0%</div>
                            <div class="label">Positive</div>
                        </div>
                        <div class="review-stats-item">
                            <div class="value" id="helpful-reviews">0</div>
                            <div class="label">Helpful</div>
                        </div>
                    </div>

                    <!-- Review Categories -->
                    <div class="review-categories">
                        <button class="review-category-btn active" data-category="all">All Reviews</button>
                        <button class="review-category-btn" data-category="positive">Positive</button>
                        <button class="review-category-btn" data-category="negative">Critical</button>
                        <button class="review-category-btn" data-category="recent">Most Recent</button>
                        <button class="review-category-btn" data-category="helpful">Most Helpful</button>
                        <button class="review-category-btn" data-category="detailed">Detailed</button>
                    </div>

                    <!-- Enhanced Review Form -->
                    <div id="review-form-expanded" style="display:none">
                        <div class="review-form-expanded">
                            <h4 style="color:var(--neon);margin-bottom:16px;">Share Your Detailed Review</h4>
                            
                            <input id="review-title" class="review-input"
                                placeholder="Review title (optional)" />
                            
                            <input id="review-name" class="review-input"
                                placeholder="Your name (optional)" />
                            
                            <div class="review-rating-grid">
                                <div class="rating-item">
                                    <span>Overall Rating</span>
                                    <div class="rating-stars" id="overall-rating">
                                        <!-- Stars will be added by JS -->
                                    </div>
                                </div>
                                <div class="rating-item">
                                    <span>Story</span>
                                    <div class="rating-stars" id="story-rating">
                                        <!-- Stars will be added by JS -->
                                    </div>
                                </div>
                                <div class="rating-item">
                                    <span>Acting</span>
                                    <div class="rating-stars" id="acting-rating">
                                        <!-- Stars will be added by JS -->
                                    </div>
                                </div>
                                <div class="rating-item">
                                    <span>Direction</span>
                                    <div class="rating-stars" id="direction-rating">
                                        <!-- Stars will be added by JS -->
                                    </div>
                                </div>
                                <div class="rating-item">
                                    <span>Cinematography</span>
                                    <div class="rating-stars" id="cinematography-rating">
                                        <!-- Stars will be added by JS -->
                                    </div>
                                </div>
                                <div class="rating-item">
                                    <span>Enjoyment</span>
                                    <div class="rating-stars" id="enjoyment-rating">
                                        <!-- Stars will be added by JS -->
                                    </div>
                                </div>
                            </div>

                            <div class="review-options">
                                <div class="review-option-btn" data-option="recommended">âœ“ Recommended</div>
                                <div class="review-option-btn" data-option="mixed">Mixed Feelings</div>
                                <div class="review-option-btn" data-option="not-recommended">Not Recommended</div>
                            </div>

                            <div style="margin: 16px 0;">
                                <label style="color:var(--muted);font-size:0.9rem;margin-bottom:8px;display:block;">Spoiler Warning</label>
                                <div style="display:flex;gap:12px;">
                                    <label style="display:flex;align-items:center;gap:6px;color:var(--muted);">
                                        <input type="checkbox" id="spoiler-checkbox" style="accent-color:var(--neon);">
                                        Contains Spoilers
                                    </label>
                                </div>
                            </div>

                            <textarea id="review-text" class="review-text"
                                rows="6"
                                placeholder="Share your detailed thoughts... What did you like or dislike about this series? What moments stood out? Who were your favorite actors?"></textarea>
                            
                            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:16px">
                                <button class="btn"
                                    id="review-cancel">Cancel</button>
                                <button class="btn primary"
                                    id="review-submit">Submit Review</button>
                            </div>
                        </div>
                    </div>

                    <div id="reviews-list">
                        <!-- Reviews will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Details Modal with Top Works -->
    <div class="character-modal" id="character-modal">
        <div class="box">
            <button class="close-char" id="close-char-modal"><i class="fas fa-times"></i></button>
            <div id="character-content">
                <!-- Character details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add to List Modal - UPDATED with review features -->
    <div class="add-to-list-modal" id="add-to-list-modal">
        <div class="box">
            <button class="close-list-modal" id="close-list-modal"><i class="fas fa-times"></i></button>
            <h2 style="color:var(--neon);margin-bottom:20px;">Add to My List</h2>
            <p style="color:var(--muted);margin-bottom:24px;">Select a category for <span id="list-series-title" style="color:#fff;font-weight:600;"></span></p>
            
            <div class="list-options-grid">
                <div class="list-option" data-list-type="watching">
                    <i class="fas fa-play-circle"></i>
                    <span>Currently Watching</span>
                </div>
                <div class="list-option" data-list-type="planned">
                    <i class="fas fa-clock"></i>
                    <span>Plan to Watch</span>
                </div>
                <div class="list-option" data-list-type="completed">
                    <i class="fas fa-check-circle"></i>
                    <span>Completed</span>
                </div>
                <div class="list-option" data-list-type="onhold">
                    <i class="fas fa-pause-circle"></i>
                    <span>On Hold</span>
                </div>
                <div class="list-option" data-list-type="favorites">
                    <i class="fas fa-heart"></i>
                    <span>Favorites</span>
                </div>
            </div>

            <!-- Review rating section -->
            <div class="list-rating-section">
                <h4>Quick Review (Optional)</h4>
                <div class="list-rating-stars" id="list-rating-stars">
                    <span class="list-rating-star" data-value="1">â˜…</span>
                    <span class="list-rating-star" data-value="2">â˜…</span>
                    <span class="list-rating-star" data-value="3">â˜…</span>
                    <span class="list-rating-star" data-value="4">â˜…</span>
                    <span class="list-rating-star" data-value="5">â˜…</span>
                </div>
                <div style="text-align:center;color:var(--muted);font-size:0.9rem;margin-top:8px;">
                    <span id="list-rating-text">No rating</span>
                </div>
            </div>

            <div class="list-custom-notes">
                <label style="color:var(--muted);font-size:0.9rem;margin-bottom:8px;display:block;">Personal Notes & Review (Optional)</label>
                <textarea id="list-notes" placeholder="Add your personal notes, thoughts, or a quick review..."></textarea>
            </div>

            <div style="display:flex;gap:12px;margin-top:24px;">
                <button class="btn" id="cancel-add-to-list" style="flex:1;">Cancel</button>
                <button class="btn primary" id="confirm-add-to-list" style="flex:1;">Add to List</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="foot-inner">
            <div>
                <div style="font-weight:800;color:var(--neon)">My-Animedia</div>
                <div class="small">TV Series picks â€¢ Anime neon â€¢ Reviews & community</div>
            </div>
            <div class="small">Â© 2025 My-Animedia â€” Crafted with glow & passion</div>
        </div>
    </footer>

    <script>
        // TMDb API Configuration
        const API_KEY = '19e5492dc0311070d714f456eb6fb05f';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const BACKDROP_BASE_URL = 'https://image.tmdb.org/t/p/w1280';

        /* ---------------- DOM Elements ---------------- */
        const mainContent = document.getElementById('main-content');
        const searchPage = document.getElementById('search-page');
        const myListSection = document.getElementById('my-list-section');
        
        const strip1 = document.getElementById('strip1');
        const strip2 = document.getElementById('strip2');
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('filter-btn');
        const seriesGrid = document.getElementById('series-grid');
        const paginationEl = document.getElementById('pagination');

        // My List elements
        const myListGrid = document.getElementById('my-list-grid');
        const listEmptyState = document.getElementById('list-empty-state');
        const listTabs = document.querySelectorAll('.list-tab');

        // Modal elements
        const modal = document.getElementById('series-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalTabs = document.querySelectorAll('.modal-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const modalTitle = document.getElementById('modal-title');
        const modalPoster = document.getElementById('modal-poster');
        const modalOverview = document.getElementById('modal-overview');
        const modalRating = document.getElementById('modal-rating');
        const modalSeasons = document.getElementById('modal-seasons');
        const modalEpisodes = document.getElementById('modal-episodes');
        const modalStatus = document.getElementById('modal-status');
        const modalFirstAir = document.getElementById('modal-first-air');
        const modalLastAir = document.getElementById('modal-last-air');
        const modalRuntime = document.getElementById('modal-runtime');
        const modalLanguage = document.getElementById('modal-language');
        const modalTagline = document.getElementById('modal-tagline');
        const modalTaglineFull = document.getElementById('modal-tagline-full');
        const modalOriginalTitle = document.getElementById('modal-original-title');
        const modalGenres = document.getElementById('modal-genres');
        const modalNetworks = document.getElementById('modal-networks');
        const modalCompanies = document.getElementById('modal-companies');
        const modalCountries = document.getElementById('modal-countries');
        const modalHomepage = document.getElementById('modal-homepage');
        const modalCreators = document.getElementById('modal-creators');
        const modalWriters = document.getElementById('modal-writers');
        const modalProducers = document.getElementById('modal-producers');
        const modalDirectors = document.getElementById('modal-directors');
        const modalVoteCount = document.getElementById('modal-vote-count');
        const modalPopularity = document.getElementById('modal-popularity');
        const modalRuntimeDetail = document.getElementById('modal-runtime-detail');
        const modalType = document.getElementById('modal-type');
        
        const trailerBtn = document.getElementById('trailer-btn');
        const addToListBtn = document.getElementById('add-to-list-btn');
        const castGrid = document.getElementById('cast-grid');
        const reviewsList = document.getElementById('reviews-list');
        const reviewFormExpanded = document.getElementById('review-form-expanded');
        const openReviewFormBtn = document.getElementById('open-review-form-btn');
        const reviewCancelBtn = document.getElementById('review-cancel');
        const reviewSubmitBtn = document.getElementById('review-submit');
        const reviewName = document.getElementById('review-name');
        const reviewTitle = document.getElementById('review-title');
        const reviewText = document.getElementById('review-text');
        const reviewOptions = document.querySelectorAll('.review-option-btn');
        const spoilerCheckbox = document.getElementById('spoiler-checkbox');
        const reviewCategories = document.querySelectorAll('.review-category-btn');

        // Review stats
        const avgRatingEl = document.getElementById('avg-rating');
        const totalReviewsEl = document.getElementById('total-reviews');
        const positiveReviewsEl = document.getElementById('positive-reviews');
        const helpfulReviewsEl = document.getElementById('helpful-reviews');

        // Character modal elements
        const characterModal = document.getElementById('character-modal');
        const closeCharModalBtn = document.getElementById('close-char-modal');
        const characterContent = document.getElementById('character-content');

        // Add to List modal elements
        const addToListModal = document.getElementById('add-to-list-modal');
        const closeListModalBtn = document.getElementById('close-list-modal');
        const cancelAddToListBtn = document.getElementById('cancel-add-to-list');
        const confirmAddToListBtn = document.getElementById('confirm-add-to-list');
        const listSeriesTitle = document.getElementById('list-series-title');
        const listNotes = document.getElementById('list-notes');
        const listOptions = document.querySelectorAll('.list-option');
        const listRatingStars = document.querySelectorAll('.list-rating-star');
        const listRatingText = document.getElementById('list-rating-text');

        // Seasons and similar series elements
        const seasonsSection = document.getElementById('seasons-section');
        const seasonsGrid = document.getElementById('seasons-grid');
        const similarSeriesSection = document.getElementById('similar-series-section');
        const similarSeriesGrid = document.getElementById('similar-series-grid');

        // Advanced Search elements
        const backToMainBtn = document.getElementById('back-to-main');
        const advSearchInput = document.getElementById('adv-search-input');
        const genresFilter = document.getElementById('genres-filter');
        const yearFromSelect = document.getElementById('year-from');
        const yearToSelect = document.getElementById('year-to');
        const languageFilter = document.getElementById('language-filter');
        const ratingFilter = document.getElementById('rating-filter');
        const sortSelect = document.getElementById('sort-select');
        const resultsSortSelect = document.getElementById('results-sort-select');
        const searchResultsGrid = document.getElementById('search-results-grid');
        const searchPagination = document.getElementById('search-pagination');
        const resultsCount = document.getElementById('results-count');

        // Streaming buttons
        const streamingBtns = document.querySelectorAll('.streaming-btn');

        /* ---------------- State ---------------- */
        let heroItems = [];
        let posterItems = [];
        let currentFilter = 'popular';
        let currentPage = 1;
        let currentSearch = '';
        let isLoading = false;
        let activeSeries = null;
        let lastPagination = null;
        let characterCache = {};
        let selectedListType = 'watching';
        let selectedListOption = 'watching';
        let currentReviewCategory = 'all';
        let listRating = 0;
        
        // Advanced search state
        let currentSearchType = null;
        let currentSearchValue = null;
        let currentSearchPage = 1;
        let currentSearchSort = 'popularity.desc';
        
        // TMDb filter data - TV series genres
        let tmdbGenres = [];
        let tmdbLanguages = [
            { code: 'en', name: 'English' },
            { code: 'ja', name: 'Japanese' },
            { code: 'ko', name: 'Korean' },
            { code: 'zh', name: 'Chinese' },
            { code: 'es', name: 'Spanish' },
            { code: 'fr', name: 'French' },
            { code: 'de', name: 'German' },
            { code: 'it', name: 'Italian' },
            { code: 'hi', name: 'Hindi' },
            { code: 'bn', name: 'Bangla' },
            { code: 'ru', name: 'Russian' },
            { code: 'pt', name: 'Portuguese' },
            { code: 'ar', name: 'Arabic' },
            { code: 'tr', name: 'Turkish' },
            { code: 'th', name: 'Thai' },
            { code: 'vi', name: 'Vietnamese' },
            { code: 'pl', name: 'Polish' },
            { code: 'nl', name: 'Dutch' },
            { code: 'sv', name: 'Swedish' },
            { code: 'da', name: 'Danish' }
        ];

        // Genre mapping for filter buttons
        const genreMap = {
            'action': 10759, // Action & Adventure
            'drama': 18,
            'comedy': 35,
            'crime': 80,
            'sci_fi': 10765 // Sci-Fi & Fantasy
        };

        const filterData = {
            rating: [
                { id: '9', name: '9+ Masterpiece', count: 200 },
                { id: '8', name: '8+ Excellent', count: 500 },
                { id: '7', name: '7+ Very Good', count: 1200 },
                { id: '6', name: '6+ Good', count: 2500 },
                { id: '5', name: '5+ Average', count: 4000 },
                { id: '4', name: '4+ Below Average', count: 3000 }
            ]
        };

        /* ---------------- Utils ---------------- */
        function escapeHtml(s = '') { 
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;'); 
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        /* ---------------- My List Functions ---------------- */
        function getMyList() {
            try {
                return JSON.parse(localStorage.getItem('ev_my_series_list')) || {};
            } catch (e) {
                return {};
            }
        }

        function saveMyList(list) {
            localStorage.setItem('ev_my_series_list', JSON.stringify(list));
        }


// --- NEW HELPER FUNCTION ---
async function saveToDatabase(category, status, itemData) {
    const token = localStorage.getItem('token');
    if (!token) return; // Only sync if logged in

    const listKey = `${category}:${status}`; // e.g., 'series:watching'

    try {
        await fetch('/api/lists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                list_key: listKey,
                item: itemData
            })
        });
        console.log('Synced to database:', listKey);
    } catch (err) {
        console.error("Failed to sync to database", err);
    }
}

    function addSeriesToList(series, listType, notes = '', rating = 0) {
    const list = getMyList();
    if (!list[listType]) {
        list[listType] = [];
    }
    
    // Create the item object
    const itemEntry = {
        ...series,
        added_date: Date.now(),
        notes: notes,
        rating: rating,
        updated_date: Date.now()
    };
    
    // Check if already in list (using 'id' for TMDB items)
    const existingIndex = list[listType].findIndex(item => item.id === series.id);
    
    if (existingIndex !== -1) {
        // Update existing entry
        list[listType][existingIndex] = itemEntry;
    } else {
        // Add new entry
        list[listType].unshift(itemEntry);
    }
    
    // 1. Save to Local Storage (Keeps your current UI working)
    saveMyList(list);
    renderMyList(selectedListType);

    // 2. NEW: Save to Database (Updates your Profile Statistics)
    saveToDatabase('series', listType, itemEntry);

    return true;
}


        function removeSeriesFromList(seriesId, listType) {
            const list = getMyList();
            if (list[listType]) {
                list[listType] = list[listType].filter(item => item.id !== seriesId);
                saveMyList(list);
                renderMyList(selectedListType);
                return true;
            }
            return false;
        }

        function renderMyList(listType = 'watching') {
            const list = getMyList();
            const seriesList = list[listType] || [];
            
            if (seriesList.length === 0) {
                myListGrid.innerHTML = '';
                listEmptyState.style.display = 'block';
                return;
            }
            
            listEmptyState.style.display = 'none';
            myListGrid.innerHTML = '';
            
            seriesList.forEach(series => {
                const card = document.createElement('div');
                card.className = 'content-card tilt';
                const poster = series.poster_path ? IMAGE_BASE_URL + series.poster_path : '';
                const score = series.vote_average || 'N/A';
                const year = series.first_air_date ? new Date(series.first_air_date).getFullYear() : 'TBA';
                let desc = series.overview || 'No description available';
                if (desc.length > 140) desc = desc.substring(0, 140) + '...';
                
                const ratingHtml = series.rating ? `<div style="margin-top:8px;display:flex;align-items:center;gap:4px;">
                    <span style="color:gold;font-size:0.9rem;">
                        ${'â˜…'.repeat(series.rating)}${'â˜†'.repeat(5 - series.rating)}
                    </span>
                    <span style="color:var(--muted);font-size:0.8rem;">${series.rating}/5</span>
                </div>` : '';

                card.innerHTML = `
          <div class="art" style="background-image:url('${poster}')"></div>
          <div class="badge">${score}</div>
          <div class="body">
            <div class="title-row">
              <div>
                <strong>${escapeHtml(series.name)}</strong>
                <div style='color:var(--muted);font-size:0.85rem;margin-top:4px;'>TV Series â€¢ ${year}</div>
              </div>
              <span class="status ${series.status === 'Returning Series' ? 'returning' : series.status === 'Ended' ? 'ended' : 'airing'}">${series.status === 'Returning Series' ? 'Returning' : series.status === 'Ended' ? 'Ended' : 'Airing'}</span>
            </div>
            <div class="meta">${escapeHtml(desc)}</div>
            ${ratingHtml}
            ${series.notes ? `<div style="margin-top:8px;padding:8px;background:rgba(138,43,226,0.1);border-radius:6px;font-size:0.85rem;color:var(--muted);"><strong>Note:</strong> ${escapeHtml(series.notes.length > 60 ? series.notes.substring(0, 60) + '...' : series.notes)}</div>` : ''}
            <div class="list-item-actions">
                <button class="list-item-action-btn remove-from-list-btn" data-id="${series.id}">
                    <i class="fas fa-trash"></i> Remove
                </button>
                <button class="list-item-action-btn view-details-btn" data-id="${series.id}">
                    <i class="fas fa-eye"></i> Details
                </button>
            </div>
          </div>
        `;
                
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('list-item-action-btn')) {
                        openModal(series);
                    }
                });
                
                const removeBtn = card.querySelector('.remove-from-list-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Remove "${series.name}" from your list?`)) {
                        removeSeriesFromList(series.id, listType);
                    }
                });
                
                myListGrid.appendChild(card);
            });
            initTilt();
        }

        /* ---------------- Hero & Main Page ---------------- */
        async function loadHeroAndStrip() {
            try {
                const res = await fetch(`${BASE_URL}/tv/popular?api_key=${API_KEY}&language=en-US&page=1`);
                const json = await res.json();
                const items = (json.results || []).filter(i => i.backdrop_path);
                heroItems = items.slice(0, 8);
                posterItems = items.concat(items);
                renderHeroStrips();
                if (heroItems && heroItems.length) {
                    populateHero(heroItems[0]);
                    startHeroRotation();
                }
            } catch (err) {
                console.warn('Failed to load hero items', err);
            }
        }

        function renderHeroStrips() {
            if (!strip1 || !strip2) return;
            strip1.innerHTML = '';
            strip2.innerHTML = '';
            const slides = heroItems.length ? heroItems : [{ backdrop_path: '' }];
            
            const createSlide = (series) => {
                const d = document.createElement('div');
                d.className = 'slide';
                d.style.backgroundImage = `url('${BACKDROP_BASE_URL + series.backdrop_path}')`;
                d.title = series.name || '';
                d.addEventListener('click', () => openModal(series));
                return d;
            };

            const group = [];
            slides.forEach(s => group.push(createSlide(s)));
            
            for (let i = 0; i < 2; i++) {
                group.forEach(el => strip1.appendChild(el.cloneNode(true)));
                group.forEach(el => strip2.appendChild(el.cloneNode(true)));
            }
        }

        /* ---------------- Populate Hero ---------------- */
        function populateHero(series) {
            try {
                const backdrop = document.getElementById('heroBackdrop');
                const poster = document.getElementById('heroPoster');
                const title = document.getElementById('heroTitle');
                const badge = document.getElementById('heroBadge');
                const meta = document.getElementById('heroMeta');
                const desc = document.getElementById('heroDesc');
                const tags = document.getElementById('heroTags');
                const watch = document.getElementById('watchBtn');
                const addWatch = document.getElementById('addWatchlistBtn');

                if (backdrop) backdrop.style.backgroundImage = `url('${BACKDROP_BASE_URL + series.backdrop_path}')`;
                if (poster) poster.style.backgroundImage = `url('${BACKDROP_BASE_URL + series.backdrop_path}')`;
                if (title) title.textContent = series.name || 'Unknown Title';
                if (badge) badge.textContent = series.popularity ? `â˜… ${series.vote_average || 'â€”'}` : 'TRENDING';

                if (meta) {
                    meta.innerHTML = '';
                    const r = document.createElement('div'); r.className = 'rating'; r.innerHTML = `<i class="fas fa-star"></i> ${series.vote_average ? series.vote_average.toFixed(1) : 'â€”'}`;
                    const t = document.createElement('div'); t.textContent = 'TV Series';
                    const e = document.createElement('div'); e.textContent = series.number_of_seasons ? `${series.number_of_seasons} seasons` : (series.first_air_date ? new Date(series.first_air_date).getFullYear() : 'â€”');
                    const s = document.createElement('div'); s.textContent = series.first_air_date ? 'Airing' : 'TBA';
                    meta.appendChild(r); meta.appendChild(t); meta.appendChild(e); meta.appendChild(s);
                }

                if (desc) desc.textContent = series.overview ? (series.overview.length > 240 ? series.overview.substring(0, 240) + '...' : series.overview) : 'No description available.';

                if (tags) {
                    tags.innerHTML = '';
                    (series.genres || []).slice(0,5).forEach(g => {
                        const tg = document.createElement('div'); tg.className = 'tag'; tg.textContent = g.name || g; tags.appendChild(tg);
                    });
                }

                if (watch) watch.onclick = () => openModal(series);
                if (addWatch) addWatch.onclick = () => { activeSeries = series; openAddToListModal(series); };
            } catch (e) {
                console.warn('populateHero error', e);
            }
        }

        /* ---------------- Hero Rotation (auto-change) ---------------- */
        let heroRotationInterval = null;
        let heroRotationIndex = 0;

        function rotateToIndex(index) {
            if (!heroItems || !heroItems.length) return;
            heroRotationIndex = ((index % heroItems.length) + heroItems.length) % heroItems.length;
            const item = heroItems[heroRotationIndex];
            const heroEl = document.getElementById('heroSection');
            if (!heroEl) return;
            heroEl.classList.add('fading');
            setTimeout(() => {
                populateHero(item);
                heroEl.classList.remove('fading');
            }, 350);
        }

        function startHeroRotation(intervalMs = 3500) {
            stopHeroRotation();
            if (!heroItems || heroItems.length <= 1) return;
            heroRotationInterval = setInterval(() => {
                heroRotationIndex = (heroRotationIndex + 1) % heroItems.length;
                rotateToIndex(heroRotationIndex);
            }, intervalMs);
            const heroEl = document.getElementById('heroSection');
            if (heroEl) {
                heroEl.addEventListener('mouseenter', stopHeroRotation);
                heroEl.addEventListener('mouseleave', () => startHeroRotation(intervalMs));
            }
        }

        function stopHeroRotation() {
            if (heroRotationInterval) { clearInterval(heroRotationInterval); heroRotationInterval = null; }
        }

        async function fetchSeries(filter = 'popular', page = 1, q = '') {
            if (isLoading) return;
            isLoading = true;
            seriesGrid.innerHTML = `<div class="loader" style="grid-column:1/-1;margin:24px auto;width:48px;height:48px;border:5px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite"></div>`;

            try {
                let url;
                if (q) {
                    url = `${BASE_URL}/search/tv?api_key=${API_KEY}&query=${encodeURIComponent(q)}&page=${page}&language=en-US`;
                } else if (['popular', 'airing_today', 'on_the_air', 'top_rated'].includes(filter)) {
                    url = `${BASE_URL}/tv/${filter}?api_key=${API_KEY}&page=${page}&language=en-US`;
                } else {
                    // Assume it's a genre ID and use discover endpoint
                    url = `${BASE_URL}/discover/tv?api_key=${API_KEY}&with_genres=${filter}&page=${page}&language=en-US`;
                }
                const res = await fetch(url);
                const data = await res.json();
                if (data.results && data.results.length) {
                    renderGrid(data.results);
                    setupPagination(data.total_pages, data.page);
                } else {
                    seriesGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted)">No results found</p>`;
                    paginationEl.innerHTML = '';
                }
            } catch (e) {
                console.error('Failed fetch series', e);
                seriesGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted)">Failed to load series.</p>`;
            } finally {
                isLoading = false;
            }
        }

        function renderGrid(list) {
            seriesGrid.innerHTML = '';
            list.forEach(series => {
                const card = document.createElement('div');
                card.className = 'content-card tilt';
                const poster = series.poster_path ? IMAGE_BASE_URL + series.poster_path : '';
                const score = series.vote_average || 'N/A';
                const year = series.first_air_date ? new Date(series.first_air_date).getFullYear() : 'TBA';
                let desc = series.overview || 'No description available';
                if (desc.length > 140) desc = desc.substring(0, 140) + '...';

                let status = 'airing';
                let statusText = 'Airing';
                if (series.status === 'Ended') {
                    status = 'ended';
                    statusText = 'Ended';
                } else if (series.status === 'Returning Series') {
                    status = 'returning';
                    statusText = 'Returning';
                }

                card.innerHTML = `
          <div class="art" style="background-image:url('${poster}')"></div>
          <div class="badge">${score}</div>
          <div class="body">
            <div class="title-row">
              <div>
                <strong>${escapeHtml(series.name)}</strong>
                <div style='color:var(--muted);font-size:0.85rem;margin-top:4px;'>TV Series â€¢ ${year}</div>
              </div>
              <span class="status ${status}">${escapeHtml(statusText)}</span>
            </div>
            <div class="meta">${escapeHtml(desc)}</div>
          </div>
        `;
                card.dataset.series = JSON.stringify(series);
                
                card.addEventListener('click', () => {
                    const seriesData = JSON.parse(card.dataset.series);
                    openModal(seriesData);
                });
                seriesGrid.appendChild(card);
            });
            initTilt();
        }

        /* ---------------- Pagination ---------------- */
        function setupPagination(totalPages, currentPageNum) {
            if (!totalPages || totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            paginationEl.innerHTML = '';

            const prev = document.createElement('button');
            prev.className = `page-btn ${currentPageNum === 1 ? 'disabled' : ''}`;
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.addEventListener('click', () => { 
                if (currentPageNum > 1) changePage(currentPageNum - 1);
            });
            paginationEl.appendChild(prev);

            const start = Math.max(1, currentPageNum - 2);
            const end = Math.min(totalPages, currentPageNum + 2);
            for (let i = start; i <= end; i++) {
                const b = document.createElement('button');
                b.className = `page-btn ${i === currentPageNum ? 'active' : ''}`;
                b.textContent = i;
                b.addEventListener('click', () => changePage(i));
                paginationEl.appendChild(b);
            }

            const next = document.createElement('button');
            next.className = `page-btn ${currentPageNum === totalPages ? 'disabled' : ''}`;
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.addEventListener('click', () => { 
                if (currentPageNum < totalPages) changePage(currentPageNum + 1);
            });
            paginationEl.appendChild(next);
        }

        function changePage(page) {
            currentPage = page;
            fetchSeries(currentFilter, currentPage, currentSearch);
            window.scrollTo({ top: seriesGrid.offsetTop - 100, behavior: 'smooth' });
        }

        /* ---------------- Tilt effect ---------------- */
        function initTilt() {
            document.querySelectorAll('.tilt').forEach(el => {
                el.addEventListener('mousemove', e => {
                    const r = el.getBoundingClientRect();
                    const x = (e.clientX - r.left) / r.width - 0.5;
                    const y = (e.clientY - r.top) / r.height - 0.5;
                    el.style.transform = `perspective(900px) rotateX(${(-y * 6)}deg) rotateY(${x * 8}deg) translateZ(6px)`;
                });
                el.addEventListener('mouseleave', () => el.style.transform = 'translateZ(0)');
            });
        }

        /* ---------------- Modal ---------------- */
        async function openModal(series) {
            activeSeries = series;
            
            // Set tab to overview
            switchTab('overview');
            
            // Basic info
            modalTitle.textContent = series.name;
            modalPoster.src = series.poster_path ? IMAGE_BASE_URL + series.poster_path : '';
            modalPoster.onerror = function() {
                this.src = 'https://via.placeholder.com/300x400/8a2be2/ffffff?text=No+Image';
            };
            
            modalOverview.textContent = series.overview || 'No overview available.';
            modalRating.textContent = series.vote_average ? series.vote_average.toFixed(1) : 'N/A';
            
            // Fetch full series details with additional data
            try {
                const res = await fetch(`${BASE_URL}/tv/${series.id}?api_key=${API_KEY}&language=en-US&append_to_response=videos,credits,similar,season`);
                const seriesDetails = await res.json();
                activeSeries = seriesDetails;
                
                // Update modal with detailed info
                modalSeasons.textContent = seriesDetails.number_of_seasons || 'Unknown';
                modalEpisodes.textContent = seriesDetails.number_of_episodes || 'Unknown';
                modalStatus.textContent = seriesDetails.status || 'Unknown';
                modalFirstAir.textContent = seriesDetails.first_air_date || 'Unknown';
                modalLastAir.textContent = seriesDetails.last_air_date || 'Unknown';
                modalRuntime.textContent = seriesDetails.episode_run_time ? `${seriesDetails.episode_run_time[0]} min` : 'Unknown';
                modalLanguage.textContent = seriesDetails.original_language ? seriesDetails.original_language.toUpperCase() : 'Unknown';
                
                // Tagline
                const tagline = seriesDetails.tagline || '';
                modalTagline.textContent = tagline;
                modalTaglineFull.textContent = tagline;
                modalTaglineFull.style.display = tagline ? 'block' : 'none';
                
                // Original title
                modalOriginalTitle.textContent = seriesDetails.original_name || series.name;
                
                // Genres
                modalGenres.innerHTML = '';
                if (seriesDetails.genres && seriesDetails.genres.length > 0) {
                    seriesDetails.genres.forEach(genre => {
                        const genreBadge = document.createElement('span');
                        genreBadge.textContent = genre.name;
                        genreBadge.style.cssText = 'padding:4px 8px;background:rgba(138,43,226,0.2);border-radius:4px;font-size:0.8rem;';
                        modalGenres.appendChild(genreBadge);
                    });
                } else {
                    modalGenres.innerHTML = '<span style="color:var(--muted);">No genres listed</span>';
                }
                
                // Networks
                modalNetworks.textContent = seriesDetails.networks?.map(n => n.name).join(', ') || 'Unknown';
                
                // Production companies
                modalCompanies.textContent = seriesDetails.production_companies?.map(c => c.name).join(', ') || 'Unknown';
                
                // Production countries
                modalCountries.textContent = seriesDetails.production_countries?.map(c => c.name).join(', ') || 'Unknown';
                
                // Homepage
                if (seriesDetails.homepage) {
                    modalHomepage.href = seriesDetails.homepage;
                    modalHomepage.textContent = 'Visit Official Site';
                    modalHomepage.target = '_blank';
                } else {
                    modalHomepage.href = '#';
                    modalHomepage.textContent = 'Not available';
                }
                
                // Crew - find creators, producers, writers, directors
                if (seriesDetails.created_by && seriesDetails.created_by.length > 0) {
                    modalCreators.textContent = seriesDetails.created_by.map(c => c.name).join(', ');
                } else {
                    modalCreators.textContent = 'Unknown';
                }
                
                // Get crew from credits
                if (seriesDetails.credits && seriesDetails.credits.crew) {
                    const producers = seriesDetails.credits.crew.filter(person => 
                        person.job === 'Executive Producer' || person.job === 'Producer');
                    const writers = seriesDetails.credits.crew.filter(person => 
                        person.job === 'Writer' || person.job === 'Screenplay');
                    const directors = seriesDetails.credits.crew.filter(person => 
                        person.job === 'Director');
                    
                    modalProducers.textContent = producers.length > 0 ? producers.map(p => p.name).slice(0, 3).join(', ') : 'Unknown';
                    modalWriters.textContent = writers.length > 0 ? writers.map(w => w.name).slice(0, 3).join(', ') : 'Unknown';
                    modalDirectors.textContent = directors.length > 0 ? directors.map(d => d.name).slice(0, 3).join(', ') : 'Unknown';
                }
                
                // Statistics
                modalVoteCount.textContent = formatNumber(seriesDetails.vote_count || 0);
                modalPopularity.textContent = seriesDetails.popularity ? seriesDetails.popularity.toFixed(0) : '0';
                modalRuntimeDetail.textContent = seriesDetails.episode_run_time ? `${seriesDetails.episode_run_time[0]} min` : 'Unknown';
                modalType.textContent = seriesDetails.type || 'TV Series';
                
                // Trailer button
                trailerBtn.onclick = () => {
                    if (seriesDetails.videos && seriesDetails.videos.results && seriesDetails.videos.results.length > 0) {
                        const trailer = seriesDetails.videos.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
                        if (trailer) {
                            window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
                        } else {
                            alert('No trailer available for this series');
                        }
                    } else {
                        alert('No trailer available for this series');
                    }
                };
                
                // Streaming platform buttons
                streamingBtns.forEach(btn => {
                    btn.onclick = () => {
                        const platform = btn.dataset.platform;
                        const seriesTitle = encodeURIComponent(series.name);
                        let url = '';
                        
                        switch(platform) {
                            case 'arc018':
                                url = `https://arc018.to/home?search=${seriesTitle}`;
                                break;
                            case 'seriesbox':
                                url = `https://seriesbox.tv/search?q=${seriesTitle}`;
                                break;
                            case 'tvhub':
                                url = `https://tvhub.stream/search/${seriesTitle}`;
                                break;
                            case 'discoveryftp':
                                url = `http://series.discoveryftp.net/?s=${seriesTitle}`;
                                break;
                        }
                        
                        if (url) window.open(url, '_blank');
                    };
                });

                // Load cast
                await loadCast(series.id);
                
                // Load seasons - FIXED: Now properly loads seasons
                await loadSeasons(seriesDetails);
                
                // Load similar series
                await loadSimilarSeries(series.id);
                
            } catch (error) {
                console.error('Error fetching series details:', error);
            }
            
            // Add to List button
            addToListBtn.onclick = () => {
                openAddToListModal(activeSeries);
            };
            
            // Setup review form
            setupReviewForm();
            renderReviews(activeSeries.id, currentReviewCategory);
            reviewFormExpanded.style.display = 'none';
            openReviewFormBtn.style.display = 'inline-flex';
            
            modal.classList.add('active');
        }

        function switchTab(tabName) {
            modalTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        modalTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        /* ---------------- Cast Section ---------------- */
        async function loadCast(seriesId) {
            try {
                const res = await fetch(`${BASE_URL}/tv/${seriesId}/credits?api_key=${API_KEY}`);
                const data = await res.json();
                castGrid.innerHTML = '';
                
                if (data.cast && data.cast.length > 0) {
                    data.cast.slice(0, 20).forEach(person => {
                        const castCard = document.createElement('div');
                        castCard.className = 'cast-card';
                        const profilePath = person.profile_path ? `https://image.tmdb.org/t/p/w200${person.profile_path}` : 'https://via.placeholder.com/80x80/8a2be2/ffffff?text=?';
                        
                        castCard.innerHTML = `
                            <img src="${profilePath}" 
                                 alt="${person.name}" 
                                 class="cast-img"
                                 onerror="this.src='https://via.placeholder.com/80x80/8a2be2/ffffff?text=?'" />
                            <div class="cast-name">${escapeHtml(person.name)}</div>
                            <div class="cast-role">${escapeHtml(person.character)}</div>
                        `;
                        
                        castCard.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showActorDetails(person);
                        });
                        
                        castGrid.appendChild(castCard);
                    });
                } else {
                    castGrid.innerHTML = '<p style="color:var(--muted);grid-column:1/-1;text-align:center;">No cast information available</p>';
                }
            } catch (error) {
                console.error('Failed to load cast:', error);
                castGrid.innerHTML = '<p style="color:var(--muted);grid-column:1/-1;text-align:center;">Failed to load cast</p>';
            }
        }

        /* ---------------- Load Seasons - FIXED ---------------- */
        async function loadSeasons(seriesDetails) {
            try {
                seasonsGrid.innerHTML = '';
                
                if (seriesDetails.seasons && seriesDetails.seasons.length > 0) {
                    // Filter out special seasons (season 0) and sort by season_number in chronological order
                    const regularSeasons = seriesDetails.seasons
                        .filter(season => season.season_number > 0)
                        .sort((a, b) => a.season_number - b.season_number);
                    
                    if (regularSeasons.length > 0) {
                        renderSeasons(regularSeasons, seriesDetails.id);
                    } else {
                        seasonsSection.style.display = 'none';
                    }
                } else {
                    seasonsSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load seasons:', error);
                seasonsSection.style.display = 'none';
            }
        }

        function renderSeasons(seasons, seriesId) {
            seasonsGrid.innerHTML = '';
            
            if (!seasons || seasons.length === 0) {
                seasonsSection.style.display = 'none';
                return;
            }
            
            seasonsSection.style.display = 'block';
            
            seasons.forEach(season => {
                const card = document.createElement('div');
                card.className = 'season-card';
                
                const imageUrl = season.poster_path ? `https://image.tmdb.org/t/p/w200${season.poster_path}` : 'https://via.placeholder.com/150x120/8a2be2/ffffff?text=Season';
                const year = season.air_date ? new Date(season.air_date).getFullYear() : '';
                
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${season.name}" 
                         onerror="this.src='https://via.placeholder.com/150x120/8a2be2/ffffff?text=Season'">
                    <div class="season-info">
                        <div class="season-title">${escapeHtml(season.name.length > 40 ? season.name.substring(0, 40) + '...' : season.name)}</div>
                        <div class="season-episodes">${season.episode_count} episodes</div>
                        <div class="season-year">${year}</div>
                    </div>
                `;
                
                card.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Load season details
                    try {
                        const response = await fetch(`${BASE_URL}/tv/${seriesId}/season/${season.season_number}?api_key=${API_KEY}&language=en-US`);
                        const seasonData = await response.json();
                        
                        if (seasonData) {
                            // Show season details in a simple alert or could be enhanced to show in a modal
                            const episodeList = seasonData.episodes.slice(0, 5).map(ep => 
                                `â€¢ ${ep.episode_number}. "${ep.name}" (${ep.runtime || '??'} min)`
                            ).join('\n');
                            
                            alert(`Season ${season.season_number}: ${seasonData.name}\n\nEpisodes: ${seasonData.episodes.length}\nFirst aired: ${seasonData.air_date || 'Unknown'}\n\nFirst 5 episodes:\n${episodeList}${seasonData.episodes.length > 5 ? '\n...and ' + (seasonData.episodes.length - 5) + ' more' : ''}`);
                        }
                    } catch (error) {
                        console.error('Failed to load season details:', error);
                        alert('Failed to load season details. Please try again.');
                    }
                });
                
                seasonsGrid.appendChild(card);
            });
            
            // Also render seasons in the Seasons tab
            renderSeasonsTab(seasons, seriesId);
        }

        function renderSeasonsTab(seasons, seriesId) {
            const seasonsList = document.getElementById('seasons-list');
            if (!seasonsList) return;
            
            seasonsList.innerHTML = '';
            
            if (!seasons || seasons.length === 0) {
                seasonsList.innerHTML = '<p style="color:var(--muted);text-align:center;">No seasons information available</p>';
                return;
            }
            
            seasons.forEach(season => {
                const seasonDiv = document.createElement('div');
                seasonDiv.className = 'season-card';
                seasonDiv.style.marginBottom = '15px';
                
                const imageUrl = season.poster_path ? `https://image.tmdb.org/t/p/w200${season.poster_path}` : 'https://via.placeholder.com/150x120/8a2be2/ffffff?text=Season';
                const year = season.air_date ? new Date(season.air_date).getFullYear() : '';
                
                seasonDiv.innerHTML = `
                    <div style="display:flex;gap:15px;padding:15px;">
                        <img src="${imageUrl}" alt="${season.name}" style="width:100px;height:150px;object-fit:cover;border-radius:8px;"
                             onerror="this.src='https://via.placeholder.com/100x150/8a2be2/ffffff?text=Season'">
                        <div style="flex:1;">
                            <h4 style="color:var(--neon);margin-bottom:8px;">${escapeHtml(season.name)}</h4>
                            <div style="display:flex;gap:15px;margin-bottom:10px;">
                                <span style="background:rgba(138,43,226,0.1);padding:4px 8px;border-radius:4px;font-size:0.8rem;">
                                    Season ${season.season_number}
                                </span>
                                <span style="color:var(--muted);font-size:0.8rem;">
                                    ${season.episode_count} episodes
                                </span>
                                <span style="color:var(--muted);font-size:0.8rem;">
                                    ${year}
                                </span>
                            </div>
                            <p style="color:var(--muted);font-size:0.9rem;line-height:1.5;">
                                ${escapeHtml(season.overview || 'No description available for this season.')}
                            </p>
                        </div>
                    </div>
                `;
                
                seasonDiv.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    try {
                        const response = await fetch(`${BASE_URL}/tv/${seriesId}/season/${season.season_number}?api_key=${API_KEY}&language=en-US`);
                        const seasonData = await response.json();
                        
                        if (seasonData) {
                            const episodeList = seasonData.episodes.map(ep => 
                                `<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);">
                                    <div style="display:flex;justify-content:space-between;">
                                        <span style="color:#fff;">${ep.episode_number}. "${ep.name}"</span>
                                        <span style="color:var(--muted);font-size:0.8rem;">${ep.runtime || '??'} min</span>
                                    </div>
                                    <div style="color:var(--muted);font-size:0.85rem;margin-top:5px;">${ep.overview || 'No description'}</div>
                                    <div style="color:var(--muted);font-size:0.8rem;margin-top:5px;">Air date: ${ep.air_date || 'Unknown'}</div>
                                </div>`
                            ).join('');
                            
                            alert(`Season ${season.season_number}: ${seasonData.name}\n\nClick OK to view ${seasonData.episodes.length} episodes in console.`);
                            console.log(`Season ${season.season_number} episodes:`, seasonData.episodes);
                        }
                    } catch (error) {
                        console.error('Failed to load season details:', error);
                        alert('Failed to load season details. Please try again.');
                    }
                });
                
                seasonsList.appendChild(seasonDiv);
            });
        }

        /* ---------------- Load Similar Series ---------------- */
        async function loadSimilarSeries(seriesId) {
            try {
                similarSeriesSection.style.display = 'none';
                similarSeriesGrid.innerHTML = '';
                
                const response = await fetch(`${BASE_URL}/tv/${seriesId}/similar?api_key=${API_KEY}&language=en-US&page=1`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const similarSeries = data.results.slice(0, 8);
                    renderSimilarSeries(similarSeries);
                } else {
                    similarSeriesSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load similar series:', error);
                similarSeriesSection.style.display = 'none';
            }
        }

        function renderSimilarSeries(seriesList) {
            similarSeriesGrid.innerHTML = '';
            
            if (!seriesList || seriesList.length === 0) {
                similarSeriesSection.style.display = 'none';
                return;
            }
            
            similarSeriesSection.style.display = 'block';
            
            seriesList.forEach(series => {
                const card = document.createElement('div');
                card.className = 'similar-series-card';
                
                const imageUrl = series.poster_path ? `https://image.tmdb.org/t/p/w200${series.poster_path}` : 'https://via.placeholder.com/150x120/8a2be2/ffffff?text=Series';
                const year = series.first_air_date ? new Date(series.first_air_date).getFullYear() : '';
                
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${series.name}" 
                         onerror="this.src='https://via.placeholder.com/150x120/8a2be2/ffffff?text=Series'">
                    <div class="similar-series-info">
                        <div class="similar-series-title">${escapeHtml(series.name.length > 40 ? series.name.substring(0, 40) + '...' : series.name)}</div>
                        <div class="similar-series-type">${year}</div>
                        <div class="similar-series-relation">${series.vote_average ? `â˜… ${series.vote_average.toFixed(1)}` : 'No rating'}</div>
                    </div>
                `;
                
                card.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    modalTitle.textContent = 'Loading...';
                    modalOverview.textContent = 'Loading series details...';
                    modalPoster.src = '';
                    
                    try {
                        const response = await fetch(`${BASE_URL}/tv/${series.id}?api_key=${API_KEY}&language=en-US&append_to_response=videos,credits,similar,season`);
                        const seriesData = await response.json();
                        
                        if (seriesData) {
                            openModal(seriesData);
                        }
                    } catch (error) {
                        console.error('Failed to load series details:', error);
                        alert('Failed to load series details. Please try again.');
                    }
                });
                
                similarSeriesGrid.appendChild(card);
            });
        }

        /* ---------------- Actor Details Modal with Top Works ---------------- */
        async function showActorDetails(actor) {
            characterContent.innerHTML = `
                <div class="character-loading">
                    <div class="spinner"></div>
                    <div>Loading actor details...</div>
                </div>
            `;
            
            characterModal.classList.add('active');
            
            try {
                const actorId = actor.id;
                
                if (characterCache[actorId]) {
                    renderActorDetails(characterCache[actorId]);
                    return;
                }
                
                // Fetch actor details and their TV credits
                const response = await fetch(`${BASE_URL}/person/${actorId}?api_key=${API_KEY}&language=en-US&append_to_response=tv_credits`);
                const data = await response.json();
                
                if (data) {
                    characterCache[actorId] = data;
                    renderActorDetails(data);
                } else {
                    throw new Error('No actor data found');
                }
            } catch (error) {
                console.error('Failed to load actor details:', error);
                renderActorDetails({
                    name: actor.name,
                    profile_path: actor.profile_path,
                    biography: 'Actor details could not be loaded. Please try again later.',
                    birthday: null,
                    place_of_birth: null,
                    known_for_department: actor.known_for_department || 'Acting'
                });
            }
        }

        function renderActorDetails(actorData) {
            const biography = actorData.biography || 'No biography available.';
            const birthday = actorData.birthday || 'N/A';
            const placeOfBirth = actorData.place_of_birth || 'N/A';
            const knownFor = actorData.known_for_department || 'Acting';
            const image = actorData.profile_path ? `https://image.tmdb.org/t/p/w300${actorData.profile_path}` : 'https://via.placeholder.com/200x250/8a2be2/ffffff?text=Actor';
            
            // Get top TV shows (sorted by popularity or vote average)
            let topShows = [];
            if (actorData.tv_credits && actorData.tv_credits.cast) {
                topShows = actorData.tv_credits.cast
                    .filter(show => show.vote_count > 100) // Filter shows with enough votes
                    .sort((a, b) => (b.popularity || 0) - (a.popularity || 0))
                    .slice(0, 6); // Top 6 shows
            }
            
            characterContent.innerHTML = `
                <h2 style="color:var(--neon);margin-bottom:20px;text-align:center;">${escapeHtml(actorData.name)}</h2>
                <div class="character-content">
                    <div>
                        <img src="${image}" alt="${actorData.name}" 
                             onerror="this.src='https://via.placeholder.com/200x250/8a2be2/ffffff?text=Actor'">
                    </div>
                    <div class="character-info">
                        <h3 style="color:var(--accent);margin-bottom:12px;">Actor Details</h3>
                        <p style="color:var(--muted);line-height:1.6;margin-bottom:20px;">${escapeHtml(biography.substring(0, 500))}${biography.length > 500 ? '...' : ''}</p>
                        
                        <div class="character-details-grid">
                            <div class="character-detail-item">
                                <div class="label">Known For</div>
                                <div class="value">${escapeHtml(knownFor)}</div>
                            </div>
                            
                            <div class="character-detail-item">
                                <div class="label">Birthday</div>
                                <div class="value">${escapeHtml(birthday)}</div>
                            </div>
                            
                            <div class="character-detail-item">
                                <div class="label">Place of Birth</div>
                                <div class="value">${escapeHtml(placeOfBirth)}</div>
                            </div>
                        </div>
                        
                        ${topShows.length > 0 ? `
                        <div style="margin-top:24px;">
                            <h4 style="color:var(--neon);margin-bottom:12px;">Top TV Shows</h4>
                            <div class="top-works-grid" id="top-works-grid">
                                ${topShows.map(show => `
                                    <div class="top-work-card" data-series-id="${show.id}">
                                        <img src="${show.poster_path ? `https://image.tmdb.org/t/p/w200${show.poster_path}` : 'https://via.placeholder.com/120x100/8a2be2/ffffff?text=TV'}" 
                                             alt="${show.name}"
                                             onerror="this.src='https://via.placeholder.com/120x100/8a2be2/ffffff?text=TV'">
                                        <div class="top-work-info">
                                            <div class="top-work-title">${escapeHtml(show.name.length > 25 ? show.name.substring(0, 25) + '...' : show.name)}</div>
                                            <div class="top-work-rating">â˜… ${show.vote_average ? show.vote_average.toFixed(1) : 'N/A'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top:24px;text-align:center;">
                            <button class="btn" id="add-to-favorites-btn"style="color:white">
                                <i class="fas fa-heart"></i> Add to Favorites
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to top works
            document.querySelectorAll('.top-work-card').forEach(card => {
                card.addEventListener('click', async () => {
                    const seriesId = card.dataset.seriesId;
                    
                    characterModal.classList.remove('active');
                    
                    try {
                        const response = await fetch(`${BASE_URL}/tv/${seriesId}?api_key=${API_KEY}&language=en-US&append_to_response=videos,credits,similar,season`);
                        const seriesData = await response.json();
                        
                        if (seriesData) {
                            openModal(seriesData);
                        }
                    } catch (error) {
                        console.error('Failed to load series details:', error);
                        alert('Failed to load series details. Please try again.');
                    }
                });
            });
            
                    document.getElementById('add-to-favorites-btn')?.addEventListener('click', async () => {
        const favorite = {
                id: actorData.id,
                name: actorData.name,
                profile_path: actorData.profile_path,
                known_for_department: actorData.known_for_department || 'Acting',
                source: 'series',
                added_date: Date.now()
        };

        const token = localStorage.getItem('token');
        if (token) {
            try {
                const res = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ item_id: String(favorite.id), item_type: 'series', meta: favorite })
                });
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Failed to add favorite'); return; }
                // Optionally update local cache used by UI
                let favs = JSON.parse(localStorage.getItem('ev_favorite_characters')) || [];
                if (!favs.some(f => String(f.id) === String(favorite.id))) {
                    favs.unshift(favorite);
                    localStorage.setItem('ev_favorite_characters', JSON.stringify(favs));
                }
                alert(`${actorData.name} added to favorites!`);
                return;
            } catch (e) {
                console.error('Failed to add favorite', e);
                alert('Network error while adding favorite');
                return;
            }
        }

        // Guest fallback: localStorage only
        let favorites = JSON.parse(localStorage.getItem('ev_favorite_characters')) || [];
        if (!favorites.some(f => f.id === favorite.id)) {
                favorites.unshift(favorite);
                localStorage.setItem('ev_favorite_characters', JSON.stringify(favorites));
                alert(`${actorData.name} added to favorites!`);
        } else {
                alert(`${actorData.name} is already in your favorites.`);
        }
});
        }

        closeCharModalBtn.addEventListener('click', () => {
            characterModal.classList.remove('active');
        });

        characterModal.addEventListener('click', (e) => {
            if (e.target === characterModal) {
                characterModal.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && characterModal.classList.contains('active')) {
                characterModal.classList.remove('active');
            }
        });

        /* ---------------- Add to List Modal ---------------- */
        function openAddToListModal(series) {
            listSeriesTitle.textContent = series.name;
            listNotes.value = '';
            listRating = 0;
            
            listOptions.forEach(option => option.classList.remove('active'));
            listOptions[0].classList.add('active');
            selectedListOption = 'watching';
            
            listRatingStars.forEach(star => star.classList.remove('active'));
            listRatingText.textContent = 'No rating';
            
            addToListModal.classList.add('active');
        }

        listOptions.forEach(option => {
            option.addEventListener('click', () => {
                listOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedListOption = option.dataset.listType;
            });
        });

        listRatingStars.forEach(star => {
            star.addEventListener('click', () => {
                const value = parseInt(star.dataset.value);
                listRating = value;
                
                listRatingStars.forEach((s, index) => {
                    if (index < value) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
                
                const ratingTexts = ['No rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                listRatingText.textContent = `${ratingTexts[value]} (${value}/5)`;
            });
        });

        closeListModalBtn.addEventListener('click', () => {
            addToListModal.classList.remove('active');
        });

        cancelAddToListBtn.addEventListener('click', () => {
            addToListModal.classList.remove('active');
        });

        confirmAddToListBtn.addEventListener('click', () => {
            if (activeSeries) {
                const notes = listNotes.value.trim();
                addSeriesToList(activeSeries, selectedListOption, notes, listRating);
                addToListModal.classList.remove('active');
                alert(`${activeSeries.name} added to your ${selectedListOption} list!`);
            }
        });

        addToListModal.addEventListener('click', (e) => {
            if (e.target === addToListModal) {
                addToListModal.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && addToListModal.classList.contains('active')) {
                addToListModal.classList.remove('active');
            }
        });

        /* ---------------- Enhanced Review Functions ---------------- */
        function setupReviewForm() {
            ['overall-rating', 'story-rating', 'acting-rating', 'direction-rating', 'cinematography-rating', 'enjoyment-rating'].forEach(id => {
                const container = document.getElementById(id);
                container.innerHTML = '';
                for (let i = 1; i <= 10; i++) {
                    const star = document.createElement('span');
                    star.className = 'rating-star';
                    star.innerHTML = 'â˜…';
                    star.dataset.value = i;
                    star.addEventListener('click', () => {
                        const stars = container.querySelectorAll('.rating-star');
                        stars.forEach((s, index) => {
                            s.classList.toggle('active', index < i);
                        });
                    });
                    container.appendChild(star);
                }
            });

            reviewOptions.forEach(option => {
                option.addEventListener('click', () => {
                    reviewOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });

            reviewCategories.forEach(category => {
                category.addEventListener('click', () => {
                    reviewCategories.forEach(cat => cat.classList.remove('active'));
                    category.classList.add('active');
                    currentReviewCategory = category.dataset.category;
                    if (activeSeries) {
                        renderReviews(activeSeries.id, currentReviewCategory);
                    }
                });
            });

            reviewName.value = '';
            reviewTitle.value = '';
            reviewText.value = '';
            spoilerCheckbox.checked = false;
        }

        closeModalBtn.addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active') });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modal.classList.remove('active') });

        /* ---------------- Reviews Storage ---------------- */
        function reviewsKey(id) { return `ev_series_reviews_${id}`; }
        function getReviews(id) { 
            try { 
                return JSON.parse(localStorage.getItem(reviewsKey(id)) || '[]');
            } catch (e) { 
                return []; 
            } 
        }
        
        function saveReviews(id, arr) { 
            localStorage.setItem(reviewsKey(id), JSON.stringify(arr)); 
        }
        
        function updateReviewStats(reviews) {
            if (!reviews || reviews.length === 0) {
                avgRatingEl.textContent = 'â€”';
                totalReviewsEl.textContent = '0';
                positiveReviewsEl.textContent = '0%';
                helpfulReviewsEl.textContent = '0';
                return;
            }
            
            const ratings = reviews.filter(r => r.overallRating).map(r => r.overallRating);
            const avgRating = ratings.length > 0 ? 
                (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 'â€”';
            avgRatingEl.textContent = avgRating;
            
            totalReviewsEl.textContent = reviews.length;
            
            const positiveCount = reviews.filter(r => r.recommendation === 'recommended').length;
            const positivePercentage = ((positiveCount / reviews.length) * 100).toFixed(0);
            positiveReviewsEl.textContent = `${positivePercentage}%`;
            
            const helpfulCount = reviews.filter(r => r.text && r.text.length > 100).length;
            helpfulReviewsEl.textContent = helpfulCount;
        }

        function renderReviews(id, category = 'all') {
            let arr = getReviews(id);
            
            updateReviewStats(arr);
            
            let filteredReviews = [...arr];
            switch (category) {
                case 'positive':
                    filteredReviews = arr.filter(r => r.recommendation === 'recommended');
                    break;
                case 'negative':
                    filteredReviews = arr.filter(r => r.recommendation === 'not-recommended');
                    break;
                case 'recent':
                    filteredReviews = [...arr].sort((a, b) => b.ts - a.ts);
                    break;
                case 'helpful':
                    filteredReviews = arr.filter(r => r.helpfulVotes > 0).sort((a, b) => (b.helpfulVotes || 0) - (a.helpfulVotes || 0));
                    break;
                case 'detailed':
                    filteredReviews = arr.filter(r => r.text && r.text.length > 200);
                    break;
                default:
                    filteredReviews = [...arr].sort((a, b) => b.ts - a.ts);
            }
            
            reviewsList.innerHTML = '';
            if (!filteredReviews.length) {
                let message = 'No reviews yet. Be the first to review!';
                if (category !== 'all') {
                    message = `No ${category} reviews found.`;
                }
                reviewsList.innerHTML = `<p style="color:var(--muted);text-align:center;padding:40px 20px;">${message}</p>`;
                return;
            }
            
            const frag = document.createDocumentFragment();
            filteredReviews.forEach(r => {
                const d = document.createElement('div');
                d.className = 'review-item';
                
                const ratings = [r.overallRating, r.storyRating, r.actingRating, r.directionRating, r.cinematographyRating, r.enjoymentRating].filter(v => v);
                const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : null;
                
                let ratingsHtml = '';
                if (ratings.length > 0) {
                    ratingsHtml = `<div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                        ${avgRating ? `<span style="color:gold;font-weight:bold;display:flex;align-items:center;gap:4px;"><i class="fas fa-star"></i> ${avgRating}/10</span>` : ''}
                        ${r.overallRating ? `<span style="color:var(--muted);font-size:0.9rem;">Overall: ${r.overallRating}/10</span>` : ''}
                        ${r.storyRating ? `<span style="color:var(--muted);font-size:0.9rem;">Story: ${r.storyRating}/10</span>` : ''}
                        ${r.actingRating ? `<span style="color:var(--muted);font-size:0.9rem;">Acting: ${r.actingRating}/10</span>` : ''}
                        ${r.directionRating ? `<span style="color:var(--muted);font-size:0.9rem;">Direction: ${r.directionRating}/10</span>` : ''}
                        ${r.cinematographyRating ? `<span style="color:var(--muted);font-size:0.9rem;">Cinematography: ${r.cinematographyRating}/10</span>` : ''}
                        ${r.enjoymentRating ? `<span style="color:var(--muted);font-size:0.9rem;">Enjoyment: ${r.enjoymentRating}/10</span>` : ''}
                    </div>`;
                }
                
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div>
                            <strong>${escapeHtml(r.name || 'Anonymous')}</strong>
                            ${r.title ? `<div style="color:#fff;font-size:1.1rem;margin-top:4px;">${escapeHtml(r.title)}</div>` : ''}
                        </div>
                        ${r.recommendation ? `<span style="padding:6px 12px;border-radius:20px;background:${r.recommendation === 'recommended' ? 'rgba(76,175,80,0.2)' : r.recommendation === 'not-recommended' ? 'rgba(244,67,54,0.2)' : 'rgba(255,193,7,0.2)'};color:${r.recommendation === 'recommended' ? '#4caf50' : r.recommendation === 'not-recommended' ? '#f44336' : '#ffc107'};font-size:0.8rem;">${r.recommendation === 'recommended' ? 'âœ“ Recommended' : r.recommendation === 'not-recommended' ? 'Not Recommended' : 'Mixed Feelings'}</span>` : ''}
                    </div>
                    ${r.spoiler ? `<div style="background:rgba(255,107,107,0.1);padding:8px 12px;border-radius:6px;margin-bottom:12px;color:var(--accent);font-size:0.9rem;"><i class="fas fa-exclamation-triangle"></i> Contains Spoilers</div>` : ''}
                    ${ratingsHtml}
                    <div style="color:var(--muted);line-height:1.5">${escapeHtml(r.text)}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
                        <div style="color:var(--muted);font-size:0.75rem">â€” ${new Date(r.ts).toLocaleString()}</div>
                        <div style="display:flex;gap:8px;">
                            <button class="list-item-action-btn helpful-btn" data-id="${r.ts}">
                                <i class="fas fa-thumbs-up"></i> Helpful (${r.helpfulVotes || 0})
                            </button>
                        </div>
                    </div>`;
                frag.appendChild(d);
            });
            reviewsList.appendChild(frag);
            
            document.querySelectorAll('.helpful-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reviewId = this.dataset.id;
                    const reviews = getReviews(id);
                    const reviewIndex = reviews.findIndex(r => r.ts == reviewId);
                    
                    if (reviewIndex !== -1) {
                        if (!reviews[reviewIndex].helpfulVotes) {
                            reviews[reviewIndex].helpfulVotes = 0;
                        }
                        reviews[reviewIndex].helpfulVotes += 1;
                        saveReviews(id, reviews);
                        renderReviews(id, currentReviewCategory);
                    }
                });
            });
        }

        openReviewFormBtn.addEventListener('click', () => { 
            reviewFormExpanded.style.display = 'block'; 
            openReviewFormBtn.style.display = 'none'; 
        });

        reviewCancelBtn.addEventListener('click', () => { 
            reviewFormExpanded.style.display = 'none'; 
            openReviewFormBtn.style.display = 'inline-flex'; 
        });

      // --- SERIES.HTML REVIEW LOGIC ---
reviewSubmitBtn.addEventListener('click', () => {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        alert("You must be logged in to write a review!");
        return;
    }

    if (!activeSeries) return; // Uses activeSeries

    const text = reviewText.value.trim();
    const getRatingCount = (id) => document.querySelectorAll(`#${id} .rating-star.active`).length;
    const overallRating = getRatingCount('overall-rating');

    if (!text && overallRating === 0) { 
        alert('Please provide a rating or write a review.'); 
        return; 
    }

    const newReview = {
        id: Date.now().toString(),
        userId: currentUser.id,
        userName: currentUser.name || 'User',
        itemId: activeSeries.id,          // TMDB ID
        itemTitle: activeSeries.name,     // TV Series use .name
        category: 'series',               // Category is 'series'
        rating: overallRating,
        text: text,
        spoiler: spoilerCheckbox.checked,
        date: new Date().toISOString()
    };

    const token = localStorage.getItem('token');
    if (token) {
        (async () => {
            try {
                const res = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ item_id: String(activeSeries.id), item_type: 'series', rating: overallRating, title: reviewTitle.value || null, body: text })
                });
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Failed to post review'); return; }
                // reload reviews from server for this item and render
                try {
                    const r = await fetch(`/api/reviews?item_id=${encodeURIComponent(activeSeries.id)}`);
                    if (r.ok) {
                        const list = await r.json();
                        // map server rows to local format expected by renderReviews
                        const mapped = list.map(it => ({
                            id: it.id,
                            userId: it.user_id,
                            userName: it.user_name || it.name || 'User',
                            itemId: it.item_id,
                            itemTitle: it.title || it.item_id,
                            category: it.item_type,
                            overallRating: it.rating,
                            text: it.body,
                            spoiler: false,
                            ts: Date.parse(it.created_at) || Date.now()
                        }));
                        saveReviews(activeSeries.id, mapped);
                        renderReviews(activeSeries.id, currentReviewCategory);
                    }
                } catch (e) { console.warn('Failed to refresh reviews from server', e); }

                document.getElementById('review-form-expanded').style.display = 'none';
                document.getElementById('open-review-form-btn').style.display = 'inline-flex';
                reviewText.value = '';
                reviewTitle.value = '';
                alert('Review published!');
            } catch (e) {
                console.error('Failed to post review', e);
                alert('Network error while posting review');
            }
        })();
        return;
    }

    // Save to Global Storage (guest fallback)
    const allReviews = JSON.parse(localStorage.getItem('ev_all_reviews')) || [];
    allReviews.unshift(newReview);
    localStorage.setItem('ev_all_reviews', JSON.stringify(allReviews));

    // Update UI
    if(typeof renderReviews === 'function') {
        renderReviews(activeSeries.id, currentReviewCategory);
    }
    
    document.getElementById('review-form-expanded').style.display = 'none';
    document.getElementById('open-review-form-btn').style.display = 'inline-flex';
    reviewText.value = '';
    reviewTitle.value = '';
    alert('Review published! (stored locally)');
});
        /* ---------------- Advanced Search Page ---------------- */
        async function fetchGenresFromTMDb() {
            try {
                const response = await fetch(`${BASE_URL}/genre/tv/list?api_key=${API_KEY}&language=en-US`);
                const data = await response.json();
                if (data.genres) {
                    return data.genres.map(genre => ({
                        id: genre.id,
                        name: genre.name,
                        count: Math.floor(Math.random() * 5000) + 100
                    }));
                }
                return [];
            } catch (error) {
                console.error('Failed to fetch genres:', error);
                // TV series genre list
                return [
                    { id: 10759, name: 'Action & Adventure', count: 1769 },
                    { id: 16, name: 'Animation', count: 3781 },
                    { id: 35, name: 'Comedy', count: 7781 },
                    { id: 80, name: 'Crime', count: 3116 },
                    { id: 99, name: 'Documentary', count: 1998 },
                    { id: 18, name: 'Drama', count: 5116 },
                    { id: 10751, name: 'Family', count: 2998 },
                    { id: 10762, name: 'Kids', count: 2116 },
                    { id: 9648, name: 'Mystery', count: 2015 },
                    { id: 10763, name: 'News', count: 253 },
                    { id: 10764, name: 'Reality', count: 1498 },
                    { id: 10765, name: 'Sci-Fi & Fantasy', count: 3523 },
                    { id: 10766, name: 'Soap', count: 824 },
                    { id: 10767, name: 'Talk', count: 498 },
                    { id: 10768, name: 'War & Politics', count: 253 },
                    { id: 37, name: 'Western', count: 1498 }
                ];
            }
        }

        async function setupAdvancedSearchPage() {
            // Setup year dropdowns
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1900; year--) {
                const optionFrom = document.createElement('option');
                optionFrom.value = year;
                optionFrom.textContent = year;
                yearFromSelect.appendChild(optionFrom.cloneNode(true));
                
                const optionTo = document.createElement('option');
                optionTo.value = year;
                optionTo.textContent = year;
                yearToSelect.appendChild(optionTo);
            }

            // Fetch genres from TMDb API
            tmdbGenres = await fetchGenresFromTMDb();
            
            // Setup genres
            genresFilter.innerHTML = '';
            tmdbGenres.forEach(genre => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="genre-${genre.id}" value="${genre.id}">
                    <label for="genre-${genre.id}">${genre.name}</label>
                    <span class="count">${genre.count}</span>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'genre';
                        currentSearchValue = genre.id;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                genresFilter.appendChild(option);
            });

            // Setup language
            languageFilter.innerHTML = '';
            tmdbLanguages.forEach(lang => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="lang-${lang.code}" value="${lang.code}">
                    <label for="lang-${lang.code}">${lang.name}</label>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'language';
                        currentSearchValue = lang.code;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                languageFilter.appendChild(option);
            });

            // Setup rating
            ratingFilter.innerHTML = '';
            filterData.rating.forEach(rating => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="rating-${rating.id}" value="${rating.id}">
                    <label for="rating-${rating.id}">${rating.name}</label>
                    <span class="count">${rating.count}</span>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'rating';
                        currentSearchValue = rating.id;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                ratingFilter.appendChild(option);
            });

            // Setup sort
            sortSelect.value = currentSearchSort;
            sortSelect.addEventListener('change', () => {
                currentSearchSort = sortSelect.value;
                if (currentSearchType && currentSearchValue) {
                    performCategorySearch();
                }
            });

            resultsSortSelect.value = currentSearchSort;
            resultsSortSelect.addEventListener('change', () => {
                currentSearchSort = resultsSortSelect.value;
                if (currentSearchType && currentSearchValue) {
                    performCategorySearch();
                }
            });

            // Year selects
            yearFromSelect.addEventListener('change', () => {
                if (yearFromSelect.value && yearToSelect.value) {
                    clearActiveFilters();
                    currentSearchType = 'year';
                    currentSearchValue = `${yearFromSelect.value}-${yearToSelect.value}`;
                    currentSearchPage = 1;
                    performCategorySearch();
                }
            });

            yearToSelect.addEventListener('change', () => {
                if (yearFromSelect.value && yearToSelect.value) {
                    clearActiveFilters();
                    currentSearchType = 'year';
                    currentSearchValue = `${yearFromSelect.value}-${yearToSelect.value}`;
                    currentSearchPage = 1;
                    performCategorySearch();
                }
            });

            // Search input
            advSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = advSearchInput.value.trim();
                    if (query) {
                        clearActiveFilters();
                        currentSearchType = 'search';
                        currentSearchValue = query;
                        currentSearchPage = 1;
                        performCategorySearch();
                    }
                }
            });
        }

        function clearActiveFilters() {
            document.querySelectorAll('.filter-option input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        async function performCategorySearch() {
            if (!currentSearchType || !currentSearchValue) return;
            
            isLoading = true;
            searchResultsGrid.innerHTML = `
                <div class="loader" style="grid-column:1/-1;margin:60px auto;width:60px;height:60px;border:5px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite"></div>
            `;
            
            try {
                let url;
                
                if (currentSearchType === 'search') {
                    url = `${BASE_URL}/search/tv?api_key=${API_KEY}&query=${encodeURIComponent(currentSearchValue)}&page=${currentSearchPage}&sort_by=${currentSearchSort}`;
                } else if (currentSearchType === 'genre') {
                    url = `${BASE_URL}/discover/tv?api_key=${API_KEY}&with_genres=${currentSearchValue}&page=${currentSearchPage}&sort_by=${currentSearchSort}`;
                } else if (currentSearchType === 'language') {
                    url = `${BASE_URL}/discover/tv?api_key=${API_KEY}&with_original_language=${currentSearchValue}&page=${currentSearchPage}&sort_by=${currentSearchSort}`;
                } else if (currentSearchType === 'rating') {
                    const minRating = parseFloat(currentSearchValue);
                    url = `${BASE_URL}/discover/tv?api_key=${API_KEY}&vote_average.gte=${minRating}&page=${currentSearchPage}&sort_by=${currentSearchSort}`;
                } else if (currentSearchType === 'year') {
                    const [yearFrom, yearTo] = currentSearchValue.split('-');
                    url = `${BASE_URL}/discover/tv?api_key=${API_KEY}&first_air_date.gte=${yearFrom}-01-01&first_air_date.lte=${yearTo}-12-31&page=${currentSearchPage}&sort_by=${currentSearchSort}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    renderSearchResults(data.results, data.total_pages, data.page);
                } else {
                    searchResultsGrid.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <h3>No results found</h3>
                            <p>Try selecting a different category</p>
                        </div>
                    `;
                    searchPagination.innerHTML = '';
                    resultsCount.textContent = '0 results found';
                }
            } catch (error) {
                console.error('Search error:', error);
                searchResultsGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Search failed</h3>
                        <p>Please try again later</p>
                    </div>
                `;
                searchPagination.innerHTML = '';
                resultsCount.textContent = 'Search failed';
            } finally {
                isLoading = false;
            }
        }

        function renderSearchResults(results, totalPages, currentPageNum) {
            searchResultsGrid.innerHTML = '';
            
            if (!results || results.length === 0) {
                searchResultsGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>No results found</h3>
                        <p>Try selecting a different category</p>
                </div>
                `;
                resultsCount.textContent = '0 results found';
                return;
            }
            
            resultsCount.textContent = `${results.length} results found`;
            
            results.forEach(series => {
                const card = document.createElement('div');
                card.className = 'search-result-card';
                card.dataset.series = JSON.stringify(series);
                
                const poster = series.poster_path ? IMAGE_BASE_URL + series.poster_path : '';
                const score = series.vote_average || 'N/A';
                const year = series.first_air_date ? new Date(series.first_air_date).getFullYear() : 'TBA';
                
                let desc = series.overview || '';
                if (desc.length > 150) desc = desc.substring(0, 150) + '...';
                
                card.innerHTML = `
                    <img src="${poster}" alt="${series.name}" class="search-result-img"
                         onerror="this.src='https://via.placeholder.com/300x200/8a2be2/ffffff?text=No+Image'">
                    <div class="search-result-info">
                        <div class="search-result-title">${escapeHtml(series.name)}</div>
                        <div class="search-result-meta">
                            <span><i class="fas fa-star" style="color:gold;"></i> ${score}</span>
                            <span>${year}</span>
                        </div>
                        <div class="search-result-desc">${escapeHtml(desc)}</div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    const seriesData = JSON.parse(card.dataset.series);
                    openModal(seriesData);
                });
                
                searchResultsGrid.appendChild(card);
            });
            
            if (totalPages > 1) {
                setupSearchPagination(totalPages, currentPageNum);
            } else {
                searchPagination.innerHTML = '';
            }
        }

        function setupSearchPagination(totalPages, currentPageNum) {
            searchPagination.innerHTML = '';

            const prev = document.createElement('button');
            prev.className = `page-btn ${currentPageNum === 1 ? 'disabled' : ''}`;
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.addEventListener('click', () => { 
                if (currentPageNum > 1) changeSearchPage(currentPageNum - 1);
            });
            searchPagination.appendChild(prev);

            const start = Math.max(1, currentPageNum - 2);
            const end = Math.min(totalPages, currentPageNum + 2);
            for (let i = start; i <= end; i++) {
                const b = document.createElement('button');
                b.className = `page-btn ${i === currentPageNum ? 'active' : ''}`;
                b.textContent = i;
                b.addEventListener('click', () => changeSearchPage(i));
                searchPagination.appendChild(b);
            }

            const next = document.createElement('button');
            next.className = `page-btn ${currentPageNum === totalPages ? 'disabled' : ''}`;
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.addEventListener('click', () => { 
                if (currentPageNum < totalPages) changeSearchPage(currentPageNum + 1);
            });
            searchPagination.appendChild(next);
        }

        function changeSearchPage(page) {
            currentSearchPage = page;
            performCategorySearch();
            window.scrollTo({ top: searchResultsGrid.offsetTop - 100, behavior: 'smooth' });
        }

        /* ---------------- Page Navigation ---------------- */
        if (filterBtn) {
            filterBtn.addEventListener('click', () => {
                mainContent.style.display = 'none';
                myListSection.classList.remove('active');
                searchPage.classList.add('active');
                currentSearchType = null;
                currentSearchValue = null;
                currentSearchPage = 1;
                clearActiveFilters();
            });
        }

        backToMainBtn.addEventListener('click', () => {
            mainContent.style.display = 'block';
            myListSection.classList.remove('active');
            searchPage.classList.remove('active');
        });

        /* ---------------- My List Tab Navigation ---------------- */
        listTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                listTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                selectedListType = tab.dataset.listType;
                renderMyList(selectedListType);
            });
        });

        /* ---------------- Main Page Filters - FIXED: Now properly handles genre filters ---------------- */
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                currentFilter = e.currentTarget.dataset.filter;
                currentPage = 1;
                currentSearch = '';
                searchInput.value = '';
                fetchSeries(currentFilter, currentPage);
                window.scrollTo({ top: document.querySelector('.section').offsetTop - 80, behavior: 'smooth' });
            });
        });

        searchInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') { 
                const q = searchInput.value.trim(); 
                if (!q) return; 
                currentSearch = q; 
                currentPage = 1; 
                fetchSeries('popular', 1, q); 
            } 
        });

        /* ---------------- Initialize ---------------- */
        try {
            console.log('series page script loaded');
            (async function init() {
                loadHeroAndStrip();
                await setupAdvancedSearchPage();

                // CHECK FOR URL PARAMETERS (SEARCH REDIRECT)
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q');

                if (query) {
                    // If there is a search query from index.html
                    searchInput.value = query; // Show term in box
                    currentSearch = query;
                    fetchSeries('popular', 1, query); // Trigger search API
                    
                    // Smooth scroll to results area
                    setTimeout(() => {
                        window.scrollTo({ top: document.getElementById('series-grid').offsetTop - 100, behavior: 'smooth' });
                    }, 500);
                } else {
                    // Otherwise load default popular series
                    fetchSeries('popular', 1);
                }

                renderMyList(selectedListType);
                setTimeout(() => { loadHeroAndStrip(); }, 1200);

                const style = document.createElement('style');
                style.textContent = '@keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }';
                document.head.appendChild(style);
            })();
        } catch (err) {
            console.error('Initialization error (series):', err);
            const g = document.getElementById('series-grid');
            if (g) g.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted)">Initialization error: ${err?.message || err}</p>`;
        }
    </script>
    <script src="auth.js"></script>
        <script>
        (function(){
            const FADE_MS = 260;
            document.addEventListener('DOMContentLoaded', ()=> setTimeout(()=> document.body.classList.add('page-visible'), 20));
            document.addEventListener('click', function(e){
                const a = e.target.closest('a');
                if(!a) return;
                const href = a.getAttribute('href');
                if(!href || href.startsWith('http') || href.startsWith('#') || a.target === '_blank' || a.classList.contains('no-transition')) return;
                e.preventDefault();
                document.body.classList.remove('page-visible');
                setTimeout(()=> { window.location = href; }, FADE_MS);
            }, true);
        })();
        </script>
        <script>
        (function(){
            document.addEventListener('DOMContentLoaded', ()=>{
                const filterBtn = document.getElementById('filter-btn');
                const searchPage = document.getElementById('search-page');
                const mainContent = document.getElementById('main-content');
                const backToMain = document.getElementById('back-to-main');
                if(!filterBtn || !searchPage) return;
                filterBtn.addEventListener('click', ()=>{
                    if(mainContent) mainContent.style.display = 'none';
                    searchPage.classList.add('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                if(backToMain) backToMain.addEventListener('click', ()=>{
                    if(mainContent) mainContent.style.display = '';
                    searchPage.classList.remove('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        })();
        </script>
</body>
</html>