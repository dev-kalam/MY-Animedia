<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>My-Animedia â€” Anime Collection</title>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <style>

/* Container for search and filter in header */
.header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Adjusting the search box for the header */
.header-search {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(138, 43, 226, 0.2); /* Neon border */
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.3s ease;
    width: 260px; /* Fixed width for header stability */
}

.header-search:focus-within {
    border-color: var(--neon);
    box-shadow: 0 0 10px rgba(138, 43, 226, 0.2);
    background: rgba(0, 0, 0, 0.4);
}

.header-search input {
    font-size: 0.9rem;
    padding: 4px 8px;
    min-width: unset; /* Override previous min-width */
    width: 100%;
}

/* Filter button in header */
.header-filter {
    padding: 8px 16px;
    background: linear-gradient(90deg, rgba(138, 43, 226, 0.1), rgba(138, 43, 226, 0.05));
    border: 1px solid rgba(138, 43, 226, 0.3);
    color: #fff;
    display: flex;
    align-items: center;
    gap: 6px;
    border-radius: 20px;
}

.header-filter:hover {
    background: var(--neon);
    border-color: var(--neon);
    box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);
}

/* Responsive adjustments */
@media (max-width: 900px) {
    /* Hide nav links on small screens to give space to search */
    .nav-links {
        display: none;
    }
    
    .header-actions {
        flex: 1;
        justify-content: flex-end;
    }
    
    .header-search {
        width: 100%;
        max-width: 200px;
    }
}

@media (max-width: 600px) {
    /* On mobile, stack or shrink */
    .brand span {
        display: none; /* Hide brand text, keep logo */
    }
    
    .header-search {
        max-width: 160px;
    }
    
    .header-filter span {
        display: none; /* Hide 'Filter' text, show icon only */
    }
}

        :root {
            --bg-1: #000000;
            --bg-2: #0b0b0b;
            --neon: #00d1c1;
            --accent: #ff6b6b;
            --muted: #9e9e9e;
            --glass-border: rgba(255, 255, 255, 0.04);
            --radius: 14px;
            --transition: 300ms cubic-bezier(.2, .9, .3, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: Inter, 'Segoe UI', Roboto, system-ui, -apple-system;
            background: linear-gradient(180deg, var(--bg-1), var(--bg-2));
            color: #e6eef8;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            line-height: 1.4;
        }

        a {
            color: inherit;
            text-decoration: none
        }

        /* --------- Header --------- */
        header {
            position: sticky;
            top: 12px; /* a little offset so 3D rim shows */
            z-index: 2000;
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }

        /* Glassy 3D nav container */
        .nav {
            width: calc(100% - 40px);
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px 18px;
            border-radius: 16px;
            background: linear-gradient(180deg,#3a3a3a,#2f2f2f);
            backdrop-filter: blur(6px) saturate(100%);
            -webkit-backdrop-filter: blur(6px) saturate(100%);
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
            transform-style: preserve-3d;
            position: relative;
        }

        /* faux 3D rim (top highlight + bottom shadow) */
        .nav::before {
            content: '';
            position: absolute;
            inset: -8px -14px auto -14px;
            height: 8px;
            border-radius: 10px 10px 0 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            filter: blur(6px);
            pointer-events: none;
            transform: translateZ(-8px) rotateX(6deg);
        }
        .nav::after {
            content: '';
            position: absolute;
            inset: auto -18px -10px -18px;
            height: 20px;
            border-radius: 0 0 12px 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.15));
            filter: blur(10px);
            pointer-events: none;
            transform: translateZ(-18px) rotateX(8deg);
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.25rem;
            color: yellow
        }

        .brand i {
            font-size: 1.6rem;
            color: var(--accent);
            text-shadow: 0 6px 22px rgba(138, 43, 226, 0.25)
        }

        .nav-links {
            display: flex;
            gap: 14px;
            align-items: center
        }

        .nav-links a {
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 600;
            color: var(--muted);
            transition: var(--transition)
        }

        .nav-links a:hover {
            color: #fff;
            background: linear-gradient(90deg, rgba(138, 43, 226, 0.08), rgba(255, 107, 107, 0.03));
            transform: translateY(-3px)
        }

                /* --------- Nav Search Styles (copied from index.html) --------- */
                .nav-search-box {
                    display: flex;
                    align-items: center;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 20px;
                    padding: 4px 12px;
                    margin: 0 16px;
                    transition: all 0.3s ease;
                    max-width: 300px;
                }

                .nav-search-box:focus-within {
                    background: rgba(255, 255, 255, 0.1);
                    border-color: var(--neon);
                    box-shadow: 0 0 15px rgba(138, 43, 226, 0.2);
                }

                .nav-scope-select {
                    background: transparent;
                    border: none;
                    color: var(--muted);
                    font-size: 0.85rem;
                    outline: none;
                    cursor: pointer;
                    border-right: 1px solid rgba(255, 255, 255, 0.15);
                    margin-right: 8px;
                    padding-right: 8px;
                    font-weight: 600;
                }

                .nav-search-input {
                    background: transparent;
                    border: none;
                    color: #fff;
                    outline: none;
                    font-size: 0.9rem;
                    width: 140px; /* Adjust based on space */
                }

                .nav-search-input::placeholder {
                    color: rgba(255, 255, 255, 0.4);
                }

                /* Small nav filter buttons (visual scope shortcuts) */
                .nav-filters { display:flex; gap:8px; align-items:center; margin-left:8px }
                .nav-filters .nav-filter-btn { padding:6px 10px; border-radius:999px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); cursor:pointer; font-weight:700; transition:var(--transition); }
                .nav-filters .nav-filter-btn.active { background: linear-gradient(90deg,var(--neon),#6e23d9); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.4); }

                .nav-search-btn {
                    background: transparent;
                    border: none;
                    color: var(--neon);
                    cursor: pointer;
                    padding: 4px;
                    display: flex;
                    align-items: center;
                    transition: transform 0.2s;
                }

                .nav-search-btn:hover {
                    transform: scale(1.1);
                    color: #fff;
                }

                @media (max-width: 900px) {
                    .nav-search-box { display: none; }
                }

        .auth {
            display: flex;
            gap: 10px;
            align-items: center; /* ensure vertical alignment */
        }

        /* Ensure header/nav buttons share the same height and padding */
        .auth .btn,
        #auth-buttons button,
        #profile-buttons button,
        .nav-search-btn,
        #filter-btn {
            height: 40px;
            padding: 8px 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            vertical-align: middle;
        }

        /* Slightly increase signup button padding for presence */
        #signup-btn {
            padding-left: 18px;
            padding-right: 18px;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition)
        }

        .btn.primary {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            box-shadow: 0 8px 30px rgba(138, 43, 226, 0.25)
        }

/* Hero Section */
.hero{
    height:650px;
    position:relative;
    border-radius:0 0 28px 28px;
    overflow:hidden;
    margin-bottom:40px;
}

.hero-backdrop{
    position:absolute;
    inset:0;
    background-size:cover;
    background-position:center;
    z-index:1;
    transition: opacity 0.35s ease, transform 0.35s ease;
}

.hero-overlay{
    position:absolute;inset:0;
    background:linear-gradient(90deg,rgba(0,0,0,.85) 25%,rgba(0,0,0,.2) 70%);
    z-index:2;
}

.hero-content{
    position:absolute;left:120px;bottom:120px;color:#fff;max-width:520px;z-index:3;
    transition: opacity 0.35s ease, transform 0.35s ease;
}

.badge{
    font-size:12px;letter-spacing:1px;opacity:.8;
    background:rgba(255,64,129,0.9);
    display:inline-block;padding:4px 12px;border-radius:4px;margin-bottom:10px;
}

.title{
    font-size:52px;font-weight:700;margin:10px 0;line-height:1.1;
}

.meta{
    display:flex;gap:16px;font-size:14px;opacity:.85;margin-bottom:14px;flex-wrap:wrap;
}

.rating{
    background:#ff4081;color:#000;padding:2px 8px;border-radius:6px;font-weight:600;
    display:flex;align-items:center;gap:5px;
}

.desc{
    font-size:14px;line-height:1.6;opacity:.85;margin-bottom:22px;max-height:80px;overflow:hidden;
}

.tags{
    display:flex;gap:10px;margin-bottom:26px;flex-wrap:wrap;
}

.tag{
    padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.2);
    font-size:12px;cursor:pointer;transition:all 0.2s ease;
}

.tag:hover{
    background:rgba(255,255,255,.3);
}

.actions{
    display:flex;gap:14px;
}

.btn{
    padding:12px 22px;border-radius:999px;border:none;font-weight:600;cursor:pointer;
    transition:all 0.2s ease;display:flex;align-items:center;gap:8px;
}

.btn:hover{
    transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

.primary{
    background:#fff;color:#000;
}

.primary:hover{
    background:#f0f0f0;
}

.secondary{
    background:rgba(255,255,255,.2);color:#fff;
}

.secondary:hover{
    background:rgba(255,255,255,.3);
}

.hero-poster{
    position:absolute;right:70px;bottom:150px;
    width:160px;height:240px;border-radius:18px;
    background-size:cover;background-position:center;
    box-shadow:0 20px 50px rgba(0,0,0,.6);z-index:3;
    cursor:pointer;transition:all 0.3s ease;
}

/* Hero fade state */
.hero.fading .hero-backdrop,
.hero.fading .hero-content,
.hero.fading .hero-poster {
    opacity: 0;
    transform: translateY(10px);
}

.hero-poster:hover{
    transform:scale(1.05);box-shadow:0 25px 60px rgba(0,0,0,.8);
}
       {
            pointer-events: auto;
            background: linear-gradient(180deg, rgba(4, 6, 14, 0.25), rgba(4, 6, 14, 0.35));
            border-radius: 12px;
            padding: 14px 18px;
            border: 1px solid var(--glass-border);
            display: flex;
            gap: 12px;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            backdrop-filter: blur(3px);
            box-shadow: 0 12px 40px rgba(2, 6, 23, 0.45);
        }

        .hero-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .hero-left .title {
            font-size: 1.25rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--neon), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent
        }

        .hero-left .sub {
            color: var(--muted);
            font-size: 0.95rem
        }

        .hero-actions {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .search-compact {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding-left: 12px
        }

        .search-compact input {
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-weight: 700;
            padding: 8px;
            min-width: 260px
        }

        .small-btn {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--muted);
            font-weight: 700;
            cursor: pointer
        }

        /* Filter buttons, grid, cards */
        .filters {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 22px auto;
            flex-wrap: wrap;
            max-width: 1200px;
            padding: 0 20px
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition)
        }

        .filter-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.25)
        }

        .filter-btn:hover:not(.active) {
            background: rgba(138, 43, 226, 0.1);
            color: #fff
        }

        .section {
            max-width: 1200px;
            margin: 36px auto;
            padding: 0 16px
        }

        .section h2 {
            font-size: 1.4rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 3rem
        }

        .content-card {
            border-radius: var(--radius);
            overflow: hidden;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            border: 1px solid rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(6px);
            transition: var(--transition);
            cursor: pointer;
            position: relative
        }

        .content-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(2, 6, 23, 0.6);
            border-color: rgba(138, 43, 226, 0.2)
        }

        .art {
            height: 320px;
            background-size: cover;
            background-position: center;
            position: relative
        }

        .body {
            padding: 14px
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: flex-start;
            margin-bottom: 8px
        }

        .meta {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 8px;
            line-height: 1.4
        }

        .badge {
            position: absolute;
            left: 12px;
            top: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            font-weight: 800;
            color: #fff;
            font-size: 0.8rem;
            box-shadow: 0 8px 22px rgba(138, 43, 226, 0.18)
        }

        .status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600
        }

        .status.airing {
            background: rgba(76, 175, 80, 0.16);
            color: #4caf50
        }

        .status.complete {
            background: rgba(156, 39, 176, 0.14);
            color: #9c27b0
        }

        .status.upcoming {
            background: rgba(33, 150, 243, 0.14);
            color: #2196f3
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 2.2rem 0
        }

        .page-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: transparent;
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center
        }

        .page-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.25)
        }

        .page-btn.disabled {
            opacity: 0.45;
            cursor: not-allowed
        }

        /* Modal - Updated for better organization */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1500;
            padding: 20px
        }

        .modal.active {
            display: flex
        }

        .modal .box {
            width: 98%;
            height: 96vh;
            max-width: none;
            max-height: 96vh;
            overflow-y: auto;
            background: linear-gradient(180deg, #041027, #081228);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            padding: 24px;
            position: relative
        }

        .modal .close {
            position: fixed;
            right: 30px;
            top: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center
        }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .modal-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
            font-weight: 600;
        }

        .modal-tab.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
        }

        .modal-tab:hover:not(.active) {
            background: rgba(138, 43, 226, 0.1);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Info Grid - Updated to 60/40 split */
        .info-grid {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 24px;
            margin-bottom: 24px;
        }

        .info-sidebar {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
        }

        .info-sidebar img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-main {
            padding: 10px 0;
        }

        /* Character Details Modal */
        .character-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 20px;
        }

        .character-modal.active {
            display: flex;
        }

        .character-modal .box {
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            background: linear-gradient(180deg, #041027, #081228);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            padding: 24px;
            position: relative;
        }

        .character-modal .close-char {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .character-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        .character-content img {
            width: 100%;
            border-radius: 10px;
            object-fit: cover;
            height: 250px;
        }

        .character-info h2 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1.8rem;
        }

        .character-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .character-detail-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 12px;
            border-radius: 8px;
        }

        .character-detail-item .label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .character-detail-item .value {
            font-weight: 600;
        }

        .character-loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .character-loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(138, 43, 226, 0.18);
            border-bottom-color: var(--neon);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Cast Grid */
        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .cast-card {
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .cast-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(138, 43, 226, 0.2);
        }

        .cast-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid var(--neon);
        }

        .cast-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .cast-role {
            font-size: 0.8rem;
            color: var(--muted);
        }

        /* Additional Info Sections */
        .additional-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-section h4 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .info-section p {
            color: var(--muted);
            line-height: 1.6;
        }

        /* Related Anime Section */
        .related-anime-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .related-anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .related-anime-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .related-anime-card:hover {
            transform: translateY(-4px);
            border-color: rgba(138, 43, 226, 0.3);
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.4);
        }

        .related-anime-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .related-anime-info {
            padding: 10px;
        }

        .related-anime-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .related-anime-type {
            font-size: 0.75rem;
            color: var(--neon);
            background: rgba(138, 43, 226, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .related-anime-relation {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 4px;
        }

        /* Reviews - Enhanced */
        .reviews-container {
            margin-top: 20px;
        }

        .review-form-expanded {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 24px;
        }

        .review-input,
        .review-text {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
            margin-bottom: 12px;
        }

        .review-rating-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 16px 0;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
        }

        .rating-star {
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s;
            font-size: 1.2rem;
        }

        .rating-star.active {
            color: gold;
        }

        .review-options {
            display: flex;
            gap: 10px;
            margin: 16px 0;
        }

        .review-option-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            text-align: center;
        }

        .review-option-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            border-color: transparent;
        }

        .review-item {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            margin-bottom: 12px
        }

        /* Advanced Search Page */
        .search-page {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-page.active {
            display: block;
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--muted);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-title {
            color: var(--neon);
            font-size: 1.8rem;
        }

        .search-filters-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .filters-sidebar {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .filter-group {
            margin-bottom: 24px;
        }

        .filter-group h3 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-group h3 .clear-btn {
            font-size: 0.8rem;
            color: var(--accent);
            cursor: pointer;
            opacity: 0.7;
        }

        .filter-group h3 .clear-btn:hover {
            opacity: 1;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px; /* Increased height for genres */
            overflow-y: auto;
            padding-right: 8px;
        }

        .filter-options::-webkit-scrollbar {
            width: 6px;
        }

        .filter-options::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 3px;
        }

        .filter-options::-webkit-scrollbar-thumb {
            background: var(--neon);
            border-radius: 3px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .filter-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--neon);
        }

        .filter-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-option .count {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .season-year-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .season-year-group select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .season-year-group select:hover {
            border-color: rgba(138, 43, 226, 0.3);
        }

        .season-year-group select option {
            background: var(--bg-1);
            color: #fff;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            color: var(--muted);
        }

        .sort-select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
        }

        /* Search Results */
        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .search-result-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: var(--transition);
            cursor: pointer;
        }

        .search-result-card:hover {
            transform: translateY(-5px);
            border-color: rgba(138, 43, 226, 0.2);
            box-shadow: 0 15px 40px rgba(2, 6, 23, 0.5);
        }

        .search-result-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .search-result-info {
            padding: 16px;
        }

        .search-result-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .search-result-meta {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .search-result-desc {
            color: var(--muted);
            font-size: 0.85rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Add to List Modal - UPDATED with review features */
        .add-to-list-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 20px;
        }

        .add-to-list-modal.active {
            display: flex;
        }

        .add-to-list-modal .box {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            background: linear-gradient(180deg, #041027, #081228);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            padding: 24px;
            position: relative;
        }

        .add-to-list-modal .close-list-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .list-option {
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .list-option:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(138, 43, 226, 0.2);
        }

        .list-option.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
        }

        .list-option i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .list-option span {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Review rating in add-to-list modal */
        .list-rating-section {
            margin: 20px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .list-rating-section h4 {
            color: var(--neon);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .list-rating-stars {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .list-rating-star {
            font-size: 1.8rem;
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s;
        }

        .list-rating-star.active {
            color: gold;
        }

        .list-custom-notes {
            margin-top: 20px;
        }

        .list-custom-notes textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: #fff;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Review Categories */
        .review-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .review-category-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .review-category-btn.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            border-color: transparent;
        }

        .review-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .review-stats-item {
            text-align: center;
        }

        .review-stats-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neon);
        }

        .review-stats-item .label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 4px;
        }

        /* My List Section */
        .my-list-section {
            display: none;
            max-width: 1200px;
            margin: 36px auto;
            padding: 0 16px;
        }

        .my-list-section.active {
            display: block;
        }

        .list-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .list-tab {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .list-tab.active {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            color: #fff;
            border-color: transparent;
        }

        .list-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .list-empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .list-item-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* FIXED: More visible buttons in modal */
        .modal .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(138, 43, 226, 0.4);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .modal .btn:hover {
            background: rgba(138, 43, 226, 0.2);
            border-color: var(--neon);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
        }

        .modal .btn.primary {
            background: linear-gradient(90deg, var(--neon), #6e23d9);
            border: 2px solid rgba(138, 43, 226, 0.6);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .modal .btn.primary:hover {
            background: linear-gradient(90deg, #9c4dff, #8a2be2);
            border-color: var(--neon);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.4);
        }

        /* Footer */
        footer {
            margin-top: 40px;
            padding: 28px 16px;
            background: linear-gradient(180deg, rgba(3, 6, 18, 0.3), transparent);
            border-top: 1px solid rgba(255, 255, 255, 0.02)
        }

        .foot-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between
        }

        .small {
            color: var(--muted);
            font-size: 0.9rem
        }

        /* Responsive */
        @media (max-width:900px) {
            .nav-links {
                display: none
            }

            .hero {
                height: 50vh
            }

            .strip .slide {
                height: 88%
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .search-filters-container {
                grid-template-columns: 1fr;
            }

            .filters-sidebar {
                position: static;
            }

            .character-content {
                grid-template-columns: 1fr;
            }

            .additional-info {
                grid-template-columns: 1fr;
            }

            .related-anime-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }

            .list-options-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .review-stats {
                flex-wrap: wrap;
                gap: 15px;
            }
        }

        @media (max-width:600px) {
            .hero {
                height: 44vh
            }

            .strip .slide {
                height: 80%
            }

            .hero-card {
                flex-direction: column;
                gap: 16px;
            }

            .search-compact input {
                min-width: 200px;
            }

            .review-rating-grid {
                grid-template-columns: 1fr;
            }

            .cast-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .search-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .season-year-group {
                grid-template-columns: 1fr;
            }

            .character-details-grid {
                grid-template-columns: 1fr;
            }

            .related-anime-grid {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }

            .list-options-grid {
                grid-template-columns: 1fr;
            }

            .review-categories {
                justify-content: center;
            }
        }
    </style>
        <style>
        /* Page transition: fade-in on load, fade-out on navigation */
        body { opacity: 0; transition: opacity 260ms ease; }
        body.page-visible { opacity: 1; }
        a.no-transition { transition: none !important; }

        /* Align filter button inside nav search */
        .nav-search-box { display:flex; align-items:center; gap:8px; }

        /* Filter button sizing and visual parity with search */
        #filter-btn {
            padding: 6px 10px;
            height: 36px;
            border-radius: 999px;
            border: none;
            background: none;
            color: var(--neon);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        #filter-btn i { font-size: 0.95rem; }

        /* Make the search input match vertically */
        .nav-search-input { height: 36px; padding: 6px 8px; }

        /* Hover state to match header-filter style */
        #filter-btn:hover { background: linear-gradient(90deg, rgba(138,43,226,0.12), rgba(138,43,226,0.06)); border-color: rgba(138,43,226,0.25); }

        @media (max-width: 900px) {
            /* On smaller screens keep the icon only */
            #filter-btn { padding:6px; }
            #filter-btn span { display: none; }
            .nav-search-input { width: 120px; }
        }

        @media (max-width: 600px) {
            .nav-search-box { gap:6px; }
            .nav-search-input { width: 100px; }
        }
        </style>
    </head>

    <body>
        <header>
    <div class="nav">
        <div class="brand">
            <i class="fas fa-play-circle"></i>My-Animedia 
        </div>

        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="#" class="active">Anime</a>
            <a href="movie.html">Movies</a>
            <a href="series.html">Series</a>
            <a href="manhwa.html">Manhwa</a>
        </nav>

        <div class="nav-search-box">
            
            
            <input type="text" class="nav-search-input" id="search-input" placeholder="Search..." autocomplete="off">
            
            <button class="nav-search-btn" id="search-btn">
                <i class="fas fa-search"></i>
            </button>
            <!-- Moved filter button beside the search input -->
            <button id="filter-btn" class="header-filter" title="Advanced Filter" style="margin-left:0px;padding:8px 16px;border-radius:999px;font-size:0.9rem;display:flex;align-items:center;gap:8px;">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>

       <div class="auth">
    <div id="auth-buttons" style="display: flex; gap: 10px;">
        <button id="signin-btn" class="btn" onclick="window.location.href='auth.html'">Log in</button>
        <button id="signup-btn" class="btn primary" onclick="window.location.href='auth.html'">Sign up</button>
    </div>

    <div id="profile-buttons" style="display: none; gap: 10px; align-items: center;">
        <button id="profile-btn" class="btn" onclick="window.location.href='profile.html'">
            <i class="fas fa-user-circle"></i> <span id="user-name">Profile</span>
        </button>
        <button id="logout-btn" class="btn" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
    </div>
</header>

                <!-- Main Content -->
                <div id="main-content">
                        <div class="hero" id="heroSection">
                            <div class="hero-backdrop" id="heroBackdrop" style="background-image: url('https://images.unsplash.com/photo-1601758123927-1c7a1f2d4a7a?auto=format&fit=crop&w=1400&q=80');"></div>
                            <div class="hero-overlay"></div>

                            <div class="hero-content" id="heroContent">
                                
                                <div class="title" id="heroTitle">Sample Anime Title</div>
                                <div class="meta" id="heroMeta">
                                    <div class="rating"><i class="fas fa-star"></i> 9.2</div>
                                    <div id="heroType">TV</div>
                                    <div id="heroEpisodes">24 Episodes</div>
                                    <div id="heroStatus">Completed</div>
                                </div>
                                <div class="desc" id="heroDesc">A short sample description for the showcased anime. Replace via JS as needed.</div>
                                <div class="tags" id="heroTags">
                                    <div class="tag">Action</div>
                                    <div class="tag">Adventure</div>
                                    <div class="tag">Fantasy</div>
                                </div>
                                <div class="actions">
                                    <button class="btn primary" id="watchBtn">
                                        <i class="fas fa-play"></i> View Details
                                    </button>
                                    <button class="btn secondary" id="addWatchlistBtn">
                                        <i class="fas fa-plus"></i> Add to Watchlist
                                    </button>
                                </div>
                            </div>

                            <div class="hero-poster" id="heroPoster" style="background-image: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=600&q=80');"></div>
                        </div>

                        <!-- Hidden strips used by existing script (kept hidden to avoid visual change) -->
                        <div id="strip1" class="strip strip-1" style="display:none" aria-hidden="true"></div>
                        <div id="strip2" class="strip strip-2" style="display:none" aria-hidden="true"></div>
                        <div class="filters">
                <button class="filter-btn active" data-filter="all">All
                    Anime</button>
                <button class="filter-btn" data-filter="airing">Currently
                    Airing</button>
                <button class="filter-btn" data-filter="upcoming">Upcoming</button>
                <button class="filter-btn" data-filter="bypopularity">Most
                    Popular</button>
                <button class="filter-btn" data-filter="favorite">Top Rated</button>
            </div>

            <!-- My List Section -->
            <div class="my-list-section" id="my-list-section">
                <h2><i class="fas fa-bookmark"></i> My Anime List</h2>
                <div class="list-tabs">
                    <button class="list-tab active" data-list-type="watching">Currently Watching</button>
                    <button class="list-tab" data-list-type="planned">Plan to Watch</button>
                    <button class="list-tab" data-list-type="completed">Completed</button>
                    <button class="list-tab" data-list-type="onhold">On Hold</button>
                    <button class="list-tab" data-list-type="dropped">Dropped</button>
                </div>
                <div class="anime-grid" id="my-list-grid">
                    <!-- List items will be loaded here -->
                </div>
                <div id="list-empty-state" class="list-empty-state" style="display: none;">
                    <i class="fas fa-book-open"></i>
                    <h3>Your list is empty</h3>
                    <p>Add anime to your list by clicking "Add to List" in any anime's details.</p>
                </div>
            </div>

            <section class="section">
                <h2><i class="fas fa-ghost"></i> Anime Collection</h2>
                <div class="anime-grid" id="anime-grid">
                    <div class="loader"
                        style="grid-column:1/-1;margin:24px auto;width:48px;height:48px;border:5px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite">
                    </div>
                </div>
            </section>

            <div class="pagination" id="pagination"></div>
        </div>

        <!-- Advanced Search Page -->
        <div class="search-page" id="search-page">
            <div class="search-header">
                <button class="back-btn" id="back-to-main">
                    <i class="fas fa-arrow-left"></i> Back to Browse
                </button>
                <h1 class="search-title">Advanced Anime Search</h1>
            </div>

            <div class="search-filters-container">
                <div class="filters-sidebar">
                    <div class="filter-group">
                        <h3>Search</h3>
                        <div class="search-compact" style="border:none;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="adv-search-input" placeholder="Search anime..." style="background:transparent;border:none;width:100%;">
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Genres <span style="color:var(--muted);font-size:0.8rem;">(Scroll down for more)</span></h3>
                        <div class="filter-options" id="genres-filter" style="max-height: 400px; overflow-y: auto;">
                            <!-- Filled dynamically from Jikan API -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Status</h3>
                        <div class="filter-options" id="status-filter">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Rating</h3>
                        <div class="filter-options" id="rating-filter">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Type</h3>
                        <div class="filter-options" id="type-filter">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Season & Year</h3>
                        <div class="season-year-group">
                            <select id="season-select">
                                <option value="">Any Season</option>
                                <option value="winter">Winter</option>
                                <option value="spring">Spring</option>
                                <option value="summer">Summer</option>
                                <option value="fall">Fall</option>
                            </select>
                            <select id="year-select">
                                <option value="">Any Year</option>
                                <!-- Filled by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="search-results-container">
                    <div class="search-results-header">
                        <div class="results-count" id="results-count">Select a category to search</div>
                        <select class="sort-select" id="sort-select">
                            <option value="score">Highest Score</option>
                            <option value="popularity">Most Popular</option>
                            <option value="title">Title A-Z</option>
                            <option value="start_date">Newest</option>
                        </select>
                    </div>

                    <div class="search-results-grid" id="search-results-grid">
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <h3>Select a Category</h3>
                            <p>Click on any category to view anime</p>
                        </div>
                    </div>

                    <div class="pagination" id="search-pagination"></div>
                </div>
            </div>
        </div>

        <!-- Modal: details + reviews + watch link - FULL SCREEN -->
        <div class="modal" id="anime-modal" aria-hidden="true">
            <div class="box" role="dialog" aria-modal="true"
                aria-labelledby="modal-title">
                <button class="close" id="close-modal" aria-label="Close"><i
                        class="fas fa-times"></i></button>

                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="overview">Overview</button>
                    <button class="modal-tab" data-tab="cast">Cast</button>
                    <button class="modal-tab" data-tab="reviews">Reviews</button>
                </div>

                <!-- Overview Tab -->
                <div class="tab-content active" id="overview-tab">
                    <div class="info-grid">
                        <div class="info-sidebar">
                            <img id="modal-poster" src alt="poster">
                            
                            <div style="margin-bottom: 20px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                                    <div class="rating" style="display:flex;align-items:center;gap:6px;">
                                        <i class="fas fa-star" style="color:gold;"></i>
                                        <span id="modal-rating" style="font-weight:bold;font-size:1.3rem;">â€”</span>
                                        <span style="color:var(--muted);">/10</span>
                                    </div>
                                </div>
                                
                                <div style="display:grid;gap:10px;">
                                    <div><strong>Episodes:</strong> <span id="modal-episodes" style="float:right;">â€”</span></div>
                                    <div><strong>Status:</strong> <span id="modal-status" style="float:right;">â€”</span></div>
                                    <div><strong>Type:</strong> <span id="modal-type" style="float:right;">â€”</span></div>
                                    <div><strong>Duration:</strong> <span id="modal-duration" style="float:right;">â€”</span></div>
                                    <div><strong>Aired:</strong> <span id="modal-aired" style="float:right;">â€”</span></div>
                                    <div><strong>Season:</strong> <span id="modal-season" style="float:right;">â€”</span></div>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h4 style="color:var(--neon);margin-bottom:10px;">Genres</h4>
                                <div id="modal-genres" style="display:flex;flex-wrap:wrap;gap:6px;">
                                    <!-- Genres will be added here -->
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn primary" id="watch-btn" style="flex:1;">
                                    <i class="fas fa-external-link-alt"></i> Watch on HiAnime
                                </button>
                                <button class="btn" id="add-to-list-btn" style="flex:1;">
                                    <i class="fas fa-plus"></i> Add to List
                                </button>
                            </div>
                        </div>

                        <div class="info-main">
                            <h2 id="modal-title" style="margin-bottom:16px;color:var(--neon);font-size:2rem;"></h2>
                            
                            <div style="margin-bottom: 24px;">
                                <h4 style="color:var(--neon);margin-bottom:8px;">Synopsis</h4>
                                <p id="modal-synopsis" style="color:var(--muted);line-height:1.7;text-align:justify;">
                                    Loading...
                                </p>
                            </div>

                            <div class="additional-info">
                                <div class="info-section">
                                    <h4>Background</h4>
                                    <p id="modal-background" style="color:var(--muted);">
                                        Loading background information...
                                    </p>
                                </div>
                                
                                <div class="info-section">
                                    <h4>Production Details</h4>
                                    <div id="modal-production" style="color:var(--muted);">
                                        <div style="margin-bottom:8px;"><strong>Studios:</strong> <span id="modal-studios">â€”</span></div>
                                        <div style="margin-bottom:8px;"><strong>Producers:</strong> <span id="modal-producers">â€”</span></div>
                                        <div style="margin-bottom:8px;"><strong>Licensors:</strong> <span id="modal-licensors">â€”</span></div>
                                        <div><strong>Source:</strong> <span id="modal-source">â€”</span></div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h4>Broadcast</h4>
                                    <div id="modal-broadcast" style="color:var(--muted);">
                                        <div style="margin-bottom:8px;"><strong>Premiered:</strong> <span id="modal-premiered">â€”</span></div>
                                        <div style="margin-bottom:8px;"><strong>Broadcast:</strong> <span id="modal-broadcast-time">â€”</span></div>
                                        <div><strong>Rating:</strong> <span id="modal-age-rating">â€”</span></div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h4>Statistics</h4>
                                    <div style="display:grid;gap:6px;">
                                        <div style="display:flex;justify-content:space-between;">
                                            <span>Rank:</span>
                                            <span id="modal-rank" style="font-weight:bold;">â€”</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;">
                                            <span>Popularity:</span>
                                            <span id="modal-popularity" style="font-weight:bold;">â€”</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;">
                                            <span>Members:</span>
                                            <span id="modal-members" style="font-weight:bold;">â€”</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;">
                                            <span>Favorites:</span>
                                            <span id="modal-favorites" style="font-weight:bold;">â€”</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Related Anime Section -->
                            <div class="related-anime-section" id="related-anime-section" style="display: none;">
                                <h4 style="color:var(--neon);margin-bottom:12px;">
                                    <i class="fas fa-link"></i> Related Anime
                                </h4>
                                <div class="related-anime-grid" id="related-anime-grid">
                                    <!-- Related anime cards will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cast Tab -->
                <div class="tab-content" id="cast-tab">
                    <h3 style="color:var(--neon);margin-bottom:20px;">Voice Cast & Characters</h3>
                    <div class="cast-grid" id="cast-grid">
                        <!-- Cast will be loaded here -->
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-content" id="reviews-tab">
                    <div class="reviews-container">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="color:var(--neon);">User Reviews</h3>
                            <button class="btn" id="open-review-form-btn">
                                <i class="fas fa-pen"></i> Write Review
                            </button>
                        </div>

                        <!-- Review Stats -->
                        <div class="review-stats" id="review-stats">
                            <div class="review-stats-item">
                                <div class="value" id="avg-rating">â€”</div>
                                <div class="label">Average Rating</div>
                            </div>
                            <div class="review-stats-item">
                                <div class="value" id="total-reviews">0</div>
                                <div class="label">Total Reviews</div>
                            </div>
                            <div class="review-stats-item">
                                <div class="value" id="positive-reviews">0%</div>
                                <div class="label">Positive</div>
                            </div>
                            <div class="review-stats-item">
                                <div class="value" id="helpful-reviews">0</div>
                                <div class="label">Helpful</div>
                            </div>
                        </div>

                        <!-- Review Categories -->
                        <div class="review-categories">
                            <button class="review-category-btn active" data-category="all">All Reviews</button>
                            <button class="review-category-btn" data-category="positive">Positive</button>
                            <button class="review-category-btn" data-category="negative">Critical</button>
                            <button class="review-category-btn" data-category="recent">Most Recent</button>
                            <button class="review-category-btn" data-category="helpful">Most Helpful</button>
                            <button class="review-category-btn" data-category="detailed">Detailed</button>
                        </div>

                        <!-- Enhanced Review Form -->
                        <div id="review-form-expanded" style="display:none">
                            <div class="review-form-expanded">
                                <h4 style="color:var(--neon);margin-bottom:16px;">Share Your Detailed Review</h4>
                                
                                <input id="review-title" class="review-input"
                                    placeholder="Review title (optional)" />
                                
                                <input id="review-name" class="review-input"
                                    placeholder="Your name (optional)" />
                                
                                <div class="review-rating-grid">
                                    <div class="rating-item">
                                        <span>Overall Rating</span>
                                        <div class="rating-stars" id="overall-rating">
                                            <!-- Stars will be added by JS -->
                                        </div>
                                    </div>
                                    <div class="rating-item">
                                        <span>Story</span>
                                        <div class="rating-stars" id="story-rating">
                                            <!-- Stars will be added by JS -->
                                        </div>
                                    </div>
                                    <div class="rating-item">
                                        <span>Animation</span>
                                        <div class="rating-stars" id="animation-rating">
                                            <!-- Stars will be added by JS -->
                                        </div>
                                    </div>
                                    <div class="rating-item">
                                        <span>Characters</span>
                                        <div class="rating-stars" id="characters-rating">
                                            <!-- Stars will be added by JS -->
                                        </div>
                                    </div>
                                    <div class="rating-item">
                                        <span>Sound</span>
                                        <div class="rating-stars" id="sound-rating">
                                            <!-- Stars will be added by JS -->
                                        </div>
                                    </div>
                                    <div class="rating-item">
                                        <span>Enjoyment</span>
                                        <div class="rating-stars" id="enjoyment-rating">
                                            <!-- Stars will be added by JS -->
                                        </div>
                                    </div>
                                </div>

                                <div class="review-options">
                                    <div class="review-option-btn" data-option="recommended">âœ“ Recommended</div>
                                    <div class="review-option-btn" data-option="mixed">Mixed Feelings</div>
                                    <div class="review-option-btn" data-option="not-recommended">Not Recommended</div>
                                </div>

                                <div style="margin: 16px 0;">
                                    <label style="color:var(--muted);font-size:0.9rem;margin-bottom:8px;display:block;">Spoiler Warning</label>
                                    <div style="display:flex;gap:12px;">
                                        <label style="display:flex;align-items:center;gap:6px;color:var(--muted);">
                                            <input type="checkbox" id="spoiler-checkbox" style="accent-color:var(--neon);">
                                            Contains Spoilers
                                        </label>
                                    </div>
                                </div>

                                <textarea id="review-text" class="review-text"
                                    rows="6"
                                    placeholder="Share your detailed thoughts... What did you like or dislike about this anime? What moments stood out? Who were your favorite characters?"></textarea>
                                
                                <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:16px">
                                    <button class="btn"
                                        id="review-cancel">Cancel</button>
                                    <button class="btn primary"
                                        id="review-submit">Submit Review</button>
                                </div>
                            </div>
                        </div>

                        <div id="reviews-list">
                            <!-- Reviews will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character Details Modal -->
        <div class="character-modal" id="character-modal">
            <div class="box">
                <button class="close-char" id="close-char-modal"><i class="fas fa-times"></i></button>
                <div id="character-content">
                    <!-- Character details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Add to List Modal - UPDATED with review features -->
        <div class="add-to-list-modal" id="add-to-list-modal">
            <div class="box">
                <button class="close-list-modal" id="close-list-modal"><i class="fas fa-times"></i></button>
                <h2 style="color:var(--neon);margin-bottom:20px;">Add to My List</h2>
                <p style="color:var(--muted);margin-bottom:24px;">Select a category for <span id="list-anime-title" style="color:#fff;font-weight:600;"></span></p>
                
                <div class="list-options-grid">
                    <div class="list-option" data-list-type="watching">
                        <i class="fas fa-play-circle"></i>
                        <span>Currently Watching</span>
                    </div>
                    <div class="list-option" data-list-type="planned">
                        <i class="fas fa-clock"></i>
                        <span>Plan to Watch</span>
                    </div>
                    <div class="list-option" data-list-type="completed">
                        <i class="fas fa-check-circle"></i>
                        <span>Completed</span>
                    </div>
                    <div class="list-option" data-list-type="onhold">
                        <i class="fas fa-pause-circle"></i>
                        <span>On Hold</span>
                    </div>
                    <div class="list-option" data-list-type="dropped">
                        <i class="fas fa-times-circle"></i>
                        <span>Dropped</span>
                    </div>
                    <div class="list-option" data-list-type="favorites">
                        <i class="fas fa-heart"></i>
                        <span>Favorites</span>
                    </div>
                </div>

                <!-- Review rating section -->
                <div class="list-rating-section">
                    <h4>Quick Review (Optional)</h4>
                    <div class="list-rating-stars" id="list-rating-stars">
                        <span class="list-rating-star" data-value="1">â˜…</span>
                        <span class="list-rating-star" data-value="2">â˜…</span>
                        <span class="list-rating-star" data-value="3">â˜…</span>
                        <span class="list-rating-star" data-value="4">â˜…</span>
                        <span class="list-rating-star" data-value="5">â˜…</span>
                    </div>
                    <div style="text-align:center;color:var(--muted);font-size:0.9rem;margin-top:8px;">
                        <span id="list-rating-text">No rating</span>
                    </div>
                </div>

                <div class="list-custom-notes">
                    <label style="color:var(--muted);font-size:0.9rem;margin-bottom:8px;display:block;">Personal Notes & Review (Optional)</label>
                    <textarea id="list-notes" placeholder="Add your personal notes, thoughts, episode progress, or a quick review..."></textarea>
                </div>

                <div style="display:flex;gap:12px;margin-top:24px;">
                    <button class="btn" id="cancel-add-to-list" style="flex:1;">Cancel</button>
                    <button class="btn primary" id="confirm-add-to-list" style="flex:1;">Add to List</button>
                </div>
            </div>
        </div>

        <footer>
            <div class="foot-inner">
                <div>
                    <div
                        style="font-weight:800;color:var(--neon)">My-Animedia</div>
                    <div class="small">Cinematic picks â€¢ Anime neon â€¢ Reviews &
                        community</div>
                </div>
                <div class="small">Â© 2025 My-Animedia â€” Crafted with glow
                    & passion</div>
            </div>
        </footer>

        <script>
        /* ---------------- DOM Elements ---------------- */
        const mainContent = document.getElementById('main-content');
        const searchPage = document.getElementById('search-page');
        const myListSection = document.getElementById('my-list-section');
        
        const strip1 = document.getElementById('strip1');
        const strip2 = document.getElementById('strip2');
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('filter-btn');
        const animeGrid = document.getElementById('anime-grid');
        const paginationEl = document.getElementById('pagination');

        // My List elements
        const myListGrid = document.getElementById('my-list-grid');
        const listEmptyState = document.getElementById('list-empty-state');
        const listTabs = document.querySelectorAll('.list-tab');

        // Modal elements
        const modal = document.getElementById('anime-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalTabs = document.querySelectorAll('.modal-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const modalTitle = document.getElementById('modal-title');
        const modalPoster = document.getElementById('modal-poster');
        const modalSynopsis = document.getElementById('modal-synopsis');
        const modalRating = document.getElementById('modal-rating');
        const modalEpisodes = document.getElementById('modal-episodes');
        const modalStatus = document.getElementById('modal-status');
        const modalType = document.getElementById('modal-type');
        const modalDuration = document.getElementById('modal-duration');
        const modalAired = document.getElementById('modal-aired');
        const modalSeason = document.getElementById('modal-season');
        const modalGenres = document.getElementById('modal-genres');
        const modalStudios = document.getElementById('modal-studios');
        const modalRank = document.getElementById('modal-rank');
        const modalPopularity = document.getElementById('modal-popularity');
        const modalMembers = document.getElementById('modal-members');
        const modalFavorites = document.getElementById('modal-favorites');
        const modalBackground = document.getElementById('modal-background');
        const modalProducers = document.getElementById('modal-producers');
        const modalLicensors = document.getElementById('modal-licensors');
        const modalSource = document.getElementById('modal-source');
        const modalPremiered = document.getElementById('modal-premiered');
        const modalBroadcastTime = document.getElementById('modal-broadcast-time');
        const modalAgeRating = document.getElementById('modal-age-rating');
        
        const watchBtn = document.getElementById('watch-btn');
        const addToListBtn = document.getElementById('add-to-list-btn');
        const castGrid = document.getElementById('cast-grid');
        const reviewsList = document.getElementById('reviews-list');
        const reviewFormExpanded = document.getElementById('review-form-expanded');
        const openReviewFormBtn = document.getElementById('open-review-form-btn');
        const reviewCancelBtn = document.getElementById('review-cancel');
        const reviewSubmitBtn = document.getElementById('review-submit');
        const reviewName = document.getElementById('review-name');
        const reviewTitle = document.getElementById('review-title');
        const reviewText = document.getElementById('review-text');
        const reviewOptions = document.querySelectorAll('.review-option-btn');
        const spoilerCheckbox = document.getElementById('spoiler-checkbox');
        const reviewCategories = document.querySelectorAll('.review-category-btn');

        // Review stats
        const avgRatingEl = document.getElementById('avg-rating');
        const totalReviewsEl = document.getElementById('total-reviews');
        const positiveReviewsEl = document.getElementById('positive-reviews');
        const helpfulReviewsEl = document.getElementById('helpful-reviews');

        // Character modal elements
        const characterModal = document.getElementById('character-modal');
        const closeCharModalBtn = document.getElementById('close-char-modal');
        const characterContent = document.getElementById('character-content');

        // Add to List modal elements - UPDATED
        const addToListModal = document.getElementById('add-to-list-modal');
        const closeListModalBtn = document.getElementById('close-list-modal');
        const cancelAddToListBtn = document.getElementById('cancel-add-to-list');
        const confirmAddToListBtn = document.getElementById('confirm-add-to-list');
        const listAnimeTitle = document.getElementById('list-anime-title');
        const listNotes = document.getElementById('list-notes');
        const listOptions = document.querySelectorAll('.list-option');
        const listRatingStars = document.querySelectorAll('.list-rating-star');
        const listRatingText = document.getElementById('list-rating-text');

        // Related anime elements
        const relatedAnimeSection = document.getElementById('related-anime-section');
        const relatedAnimeGrid = document.getElementById('related-anime-grid');

        // Advanced Search elements
        const backToMainBtn = document.getElementById('back-to-main');
        const advSearchInput = document.getElementById('adv-search-input');
        const genresFilter = document.getElementById('genres-filter');
        const statusFilter = document.getElementById('status-filter');
        const ratingFilter = document.getElementById('rating-filter');
        const typeFilter = document.getElementById('type-filter');
        const seasonSelect = document.getElementById('season-select');
        const yearSelect = document.getElementById('year-select');
        const sortSelect = document.getElementById('sort-select');
        const searchResultsGrid = document.getElementById('search-results-grid');
        const searchPagination = document.getElementById('search-pagination');
        const resultsCount = document.getElementById('results-count');

        /* ---------------- State ---------------- */
        let heroItems = [];
        let posterItems = [];
        let currentFilter = 'all';
        let currentPage = 1;
        let currentSearch = '';
        let isLoading = false;
        let activeAnime = null;
        let lastPagination = null;
        let characterCache = {}; // Cache for character details
        let selectedListType = 'watching';
        let selectedListOption = 'watching';
        let currentReviewCategory = 'all';
        let listRating = 0; // Rating for add-to-list modal
        
        // Advanced search state
        let currentSearchType = null;
        let currentSearchValue = null;
        let currentSearchPage = 1;
        let currentSearchSort = 'score';

        // Available statuses, ratings, types
        const filterData = {
            status: [
                { id: 'airing', name: 'Currently Airing', count: 150 },
                { id: 'complete', name: 'Completed', count: 12000 },
                { id: 'upcoming', name: 'Upcoming', count: 200 }
            ],
            rating: [
                { id: 'g', name: 'G - All Ages', count: 1000 },
                { id: 'pg', name: 'PG - Children', count: 3000 },
                { id: 'pg13', name: 'PG-13 - Teens 13+', count: 8000 },
                { id: 'r17', name: 'R - 17+', count: 4000 },
                { id: 'r', name: 'R+ - Mild Nudity', count: 2500 }
            ],
            type: [
                { id: 'tv', name: 'TV Series', count: 10000 },
                { id: 'movie', name: 'Movie', count: 3000 },
                { id: 'ova', name: 'OVA', count: 1500 },
                { id: 'ona', name: 'ONA', count: 800 },
                { id: 'special', name: 'Special', count: 1200 }
            ]
        };

        /* ---------------- Utils ---------------- */
        function escapeHtml(s = '') { 
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;'); 
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        /* ---------------- My List Functions ---------------- */
        function getMyList() {
            try {
                return JSON.parse(localStorage.getItem('ev_my_anime_list')) || {};
            } catch (e) {
                return {};
            }
        }

        function saveMyList(list) {
            localStorage.setItem('ev_my_anime_list', JSON.stringify(list));
        }

// --- NEW HELPER FUNCTION ---
async function saveToDatabase(category, status, itemData) {
    const token = localStorage.getItem('token');
    if (!token) return; // Only sync if logged in

    const listKey = `${category}:${status}`; // e.g., 'anime:watching'

    try {
        await fetch('/api/lists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                list_key: listKey,
                item: itemData
            })
        });
        console.log('Synced to database:', listKey);
    } catch (err) {
        console.error("Failed to sync to database", err);
    }
}


function addAnimeToList(anime, listType, notes = '', rating = 0) {
    const list = getMyList();
    if (!list[listType]) {
        list[listType] = [];
    }
    
    // Create the item object
    const itemEntry = {
        ...anime,
        added_date: Date.now(),
        notes: notes,
        rating: rating,
        updated_date: Date.now()
    };

    // Check if already in list
    const existingIndex = list[listType].findIndex(item => item.mal_id === anime.mal_id);
    
    if (existingIndex !== -1) {
        // Update existing entry
        list[listType][existingIndex] = itemEntry;
    } else {
        // Add new entry
        list[listType].unshift(itemEntry);
    }
    
    // 1. Save to Local Storage (Keep existing logic)
    saveMyList(list);
    renderMyList(selectedListType);

    // 2. NEW: Save to Database for Statistics
    saveToDatabase('anime', listType, itemEntry);

    return true;
}

        function removeAnimeFromList(animeId, listType) {
            const list = getMyList();
            if (list[listType]) {
                list[listType] = list[listType].filter(item => item.mal_id !== animeId);
                saveMyList(list);
                renderMyList(selectedListType);
                return true;
            }
            return false;
        }

        function renderMyList(listType = 'watching') {
            const list = getMyList();
            const animeList = list[listType] || [];
            
            if (animeList.length === 0) {
                myListGrid.innerHTML = '';
                listEmptyState.style.display = 'block';
                return;
            }
            
            listEmptyState.style.display = 'none';
            myListGrid.innerHTML = '';
            
            animeList.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'content-card tilt';
                const poster = anime.images?.jpg?.large_image_url || anime.images?.webp?.large_image_url || '';
                const score = anime.score || 'N/A';
                const status = anime.status || 'Unknown';
                const year = anime.year || anime.aired?.prop?.from?.year || 'TBA';
                const type = anime.type || 'Anime';
                let desc = anime.synopsis || 'No description available';
                if (desc.length > 140) desc = desc.substring(0, 140) + '...';
                
                // Display rating if exists
                const ratingHtml = anime.rating ? `<div style="margin-top:8px;display:flex;align-items:center;gap:4px;">
                    <span style="color:gold;font-size:0.9rem;">
                        ${'â˜…'.repeat(anime.rating)}${'â˜†'.repeat(5 - anime.rating)}
                    </span>
                    <span style="color:var(--muted);font-size:0.8rem;">${anime.rating}/5</span>
                </div>` : '';

                card.innerHTML = `
          <div class="art" style="background-image:url('${poster}')"></div>
          <div class="badge">${score}</div>
          <div class="body">
            <div class="title-row">
              <div>
                <strong>${escapeHtml(anime.title)}</strong>
                <div style='color:var(--muted);font-size:0.85rem;margin-top:4px;'>${type} â€¢ ${year}</div>
              </div>
              <span class="status ${status === 'Currently Airing' ? 'airing' : (status === 'Finished Airing' ? 'complete' : 'upcoming')}">${escapeHtml(status)}</span>
            </div>
            <div class="meta">${escapeHtml(desc)}</div>
            ${ratingHtml}
            ${anime.notes ? `<div style="margin-top:8px;padding:8px;background:rgba(138,43,226,0.1);border-radius:6px;font-size:0.85rem;color:var(--muted);"><strong>Note:</strong> ${escapeHtml(anime.notes.length > 60 ? anime.notes.substring(0, 60) + '...' : anime.notes)}</div>` : ''}
            <div class="list-item-actions">
                <button class="list-item-action-btn remove-from-list-btn" data-id="${anime.mal_id}">
                    <i class="fas fa-trash"></i> Remove
                </button>
                <button class="list-item-action-btn view-details-btn" data-id="${anime.mal_id}">
                    <i class="fas fa-eye"></i> Details
                </button>
            </div>
          </div>
        `;
                
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('list-item-action-btn')) {
                        openModal(anime);
                    }
                });
                
                const removeBtn = card.querySelector('.remove-from-list-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Remove "${anime.title}" from your list?`)) {
                        removeAnimeFromList(anime.mal_id, listType);
                    }
                });
                
                myListGrid.appendChild(card);
            });
            initTilt();
        }

        /* ---------------- Hero & Main Page ---------------- */
        async function loadHeroAndStrip() {
            try {
                const res = await fetch('https://api.jikan.moe/v4/top/anime?limit=12');
                const json = await res.json();
                const items = (json.data || []).filter(i => i.images?.webp?.large_image_url || i.images?.jpg?.large_image_url);
                heroItems = items.slice(0, 8);
                posterItems = items.concat(items);
                renderHeroStrips();
                // Populate the big hero area with the first item
                console.debug('loadHeroAndStrip: found hero items =', heroItems.length);
                if (heroItems && heroItems.length) {
                    populateHero(heroItems[0]);
                    startHeroRotation();
                } else {
                    console.warn('loadHeroAndStrip: not enough hero items to start rotation');
                }
            } catch (err) {
                console.warn('Failed to load hero items', err);
            }
        }

        function renderHeroStrips() {
            if (!strip1 || !strip2) return;
            strip1.innerHTML = '';
            strip2.innerHTML = '';
            const slides = heroItems.length ? heroItems : [{ images: { jpg: { large_image_url: '' } } }];
            
            const createSlide = (anime) => {
                const d = document.createElement('div');
                d.className = 'slide';
                d.style.backgroundImage = `url('${anime.images?.webp?.large_image_url || anime.images?.jpg?.large_image_url || ''}')`;
                d.title = anime.title || '';
                d.addEventListener('click', () => openModal(anime));
                return d;
            };

            const group = [];
            slides.forEach(s => group.push(createSlide(s)));
            
            for (let i = 0; i < 2; i++) {
                group.forEach(el => strip1.appendChild(el.cloneNode(true)));
                group.forEach(el => strip2.appendChild(el.cloneNode(true)));
            }
        }

        /* ---------------- Populate Hero ---------------- */
        function populateHero(anime) {
            try {
                const backdrop = document.getElementById('heroBackdrop');
                const poster = document.getElementById('heroPoster');
                const title = document.getElementById('heroTitle');
                const badge = document.getElementById('heroBadge');
                const meta = document.getElementById('heroMeta');
                const desc = document.getElementById('heroDesc');
                const tags = document.getElementById('heroTags');
                const watch = document.getElementById('watchBtn');
                const addWatch = document.getElementById('addWatchlistBtn');

                if (backdrop) backdrop.style.backgroundImage = `url('${anime.images?.webp?.large_image_url || anime.images?.jpg?.large_image_url || ''}')`;
                if (poster) poster.style.backgroundImage = `url('${anime.images?.webp?.large_image_url || anime.images?.jpg?.large_image_url || ''}')`;
                if (title) title.textContent = anime.title || 'Unknown Title';
                if (badge) badge.textContent = anime.rank ? `#${anime.rank}` : 'TRENDING NOW';

                if (meta) {
                    meta.innerHTML = '';
                    const r = document.createElement('div'); r.className = 'rating'; r.innerHTML = `<i class="fas fa-star"></i> ${anime.score || 'â€”'}`;
                    const t = document.createElement('div'); t.textContent = anime.type || 'TV';
                    const e = document.createElement('div'); e.textContent = (anime.episodes != null) ? `${anime.episodes} Episodes` : 'N/A';
                    const s = document.createElement('div'); s.textContent = anime.status || (anime.airing ? 'Airing' : 'Unknown');
                    meta.appendChild(r); meta.appendChild(t); meta.appendChild(e); meta.appendChild(s);
                }

                if (desc) desc.textContent = anime.synopsis ? (anime.synopsis.length > 240 ? anime.synopsis.substring(0, 240) + '...' : anime.synopsis) : 'No description available.';

                if (tags) {
                    tags.innerHTML = '';
                    const genres = anime.genres || [];
                    genres.slice(0,5).forEach(g => {
                        const tg = document.createElement('div'); tg.className = 'tag'; tg.textContent = g.name; tags.appendChild(tg);
                    });
                }

                if (watch) {
                    watch.onclick = () => {
                        // open modal for details
                        openModal(anime);
                    };
                }

                if (addWatch) {
                    addWatch.onclick = () => {
                        activeAnime = anime;
                        openAddToListModal(anime);
                    };
                }
            } catch (e) {
                console.warn('populateHero error', e);
            }
        }

        /* ---------------- Hero Rotation (auto-change) ---------------- */
        let heroRotationInterval = null;
        let heroRotationIndex = 0;

        function rotateToIndex(index) {
            if (!heroItems || !heroItems.length) return;
            heroRotationIndex = ((index % heroItems.length) + heroItems.length) % heroItems.length;
            const item = heroItems[heroRotationIndex];
            const heroEl = document.getElementById('heroSection');
            if (!heroEl) return;
            console.debug('rotateToIndex ->', heroRotationIndex, item?.title || item);
            heroEl.classList.add('fading');
            setTimeout(() => {
                populateHero(item);
                heroEl.classList.remove('fading');
            }, 350);
        }

        function startHeroRotation(intervalMs = 3500) {
            stopHeroRotation();
            if (!heroItems || heroItems.length <= 1) {
                console.debug('startHeroRotation: insufficient items', (heroItems || []).length);
                return;
            }
            console.debug('startHeroRotation: starting with interval', intervalMs);
            heroRotationInterval = setInterval(() => {
                heroRotationIndex = (heroRotationIndex + 1) % heroItems.length;
                rotateToIndex(heroRotationIndex);
            }, intervalMs);
            const heroEl = document.getElementById('heroSection');
            if (heroEl) {
                // remove previous handlers if present
                try {
                    if (heroEl._heroMouseEnterHandler) heroEl.removeEventListener('mouseenter', heroEl._heroMouseEnterHandler);
                    if (heroEl._heroMouseLeaveHandler) heroEl.removeEventListener('mouseleave', heroEl._heroMouseLeaveHandler);
                } catch (e) { /* ignore */ }

                heroEl._heroMouseEnterHandler = stopHeroRotation;
                heroEl._heroMouseLeaveHandler = () => startHeroRotation(intervalMs);

                heroEl.addEventListener('mouseenter', heroEl._heroMouseEnterHandler);
                heroEl.addEventListener('mouseleave', heroEl._heroMouseLeaveHandler);
            }
        }

        function stopHeroRotation() {
            if (heroRotationInterval) { clearInterval(heroRotationInterval); heroRotationInterval = null; }
        }

        async function fetchAnime(filter = 'all', page = 1, q = '') {
            if (isLoading) return;
            isLoading = true;
            animeGrid.innerHTML = `<div class="loader" style="grid-column:1/-1;margin:24px auto;width:48px;height:48px;border:5px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite"></div>`;

            try {
                let url;
                if (q) {
                    url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(q)}&page=${page}&limit=12`;
                } else {
                    if (filter === 'all') url = `https://api.jikan.moe/v4/top/anime?page=${page}&limit=12`;
                    else url = `https://api.jikan.moe/v4/top/anime?filter=${filter}&page=${page}&limit=12`;
                }
                const res = await fetch(url);
                const data = await res.json();
                if (data.data && data.data.length) {
                    renderGrid(data.data);
                    setupPagination(data.pagination, 'main');
                } else {
                    animeGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted)">No results found</p>`;
                    paginationEl.innerHTML = '';
                }
            } catch (e) {
                console.error('Failed fetch anime', e);
                animeGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted)">Failed to load anime.</p>`;
            } finally {
                isLoading = false;
            }
        }

        function renderGrid(list) {
            animeGrid.innerHTML = '';
            list.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'content-card tilt';
                const poster = anime.images?.jpg?.large_image_url || anime.images?.webp?.large_image_url || '';
                const score = anime.score || 'N/A';
                const status = anime.status || 'Unknown';
                const year = anime.year || anime.aired?.prop?.from?.year || 'TBA';
                const type = anime.type || 'Anime';
                let desc = anime.synopsis || 'No description available';
                if (desc.length > 140) desc = desc.substring(0, 140) + '...';

                card.innerHTML = `
          <div class="art" style="background-image:url('${poster}')"></div>
          <div class="badge">${score}</div>
          <div class="body">
            <div class="title-row">
              <div>
                <strong>${escapeHtml(anime.title)}</strong>
                <div style='color:var(--muted);font-size:0.85rem;margin-top:4px;'>${type} â€¢ ${year}</div>
              </div>
              <span class="status ${status === 'Currently Airing' ? 'airing' : (status === 'Finished Airing' ? 'complete' : 'upcoming')}">${escapeHtml(status)}</span>
            </div>
            <div class="meta">${escapeHtml(desc)}</div>
          </div>
        `;
                card.dataset.anime = JSON.stringify(anime);
                
                card.addEventListener('click', () => {
                    const animeData = JSON.parse(card.dataset.anime);
                    openModal(animeData);
                });
                animeGrid.appendChild(card);
            });
            initTilt();
        }

        /* ---------------- Pagination ---------------- */
        function setupPagination(p, type = 'main') {
            const paginationContainer = type === 'main' ? paginationEl : searchPagination;
            
            if (!p || !p.last_visible_page) { paginationContainer.innerHTML = ''; return; }
            const cur = p.current_page;
            const last = p.last_visible_page;
            paginationContainer.innerHTML = '';

            const prev = document.createElement('button');
            prev.className = `page-btn ${cur === 1 ? 'disabled' : ''}`;
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.addEventListener('click', () => { 
                if (cur > 1) {
                    if (type === 'main') changePage(cur - 1);
                    else changeSearchPage(cur - 1);
                }
            });
            paginationContainer.appendChild(prev);

            const start = Math.max(1, cur - 2);
            const end = Math.min(last, cur + 2);
            for (let i = start; i <= end; i++) {
                const b = document.createElement('button');
                b.className = `page-btn ${i === cur ? 'active' : ''}`;
                b.textContent = i;
                b.addEventListener('click', () => {
                    if (type === 'main') changePage(i);
                    else changeSearchPage(i);
                });
                paginationContainer.appendChild(b);
            }

            const next = document.createElement('button');
            next.className = `page-btn ${cur === last ? 'disabled' : ''}`;
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.addEventListener('click', () => { 
                if (cur < last) {
                    if (type === 'main') changePage(cur + 1);
                    else changeSearchPage(cur + 1);
                }
            });
            paginationContainer.appendChild(next);
        }

        function changePage(page) {
            currentPage = page;
            fetchAnime(currentFilter, currentPage, currentSearch);
            window.scrollTo({ top: animeGrid.offsetTop - 100, behavior: 'smooth' });
        }

        /* ---------------- Tilt effect ---------------- */
        function initTilt() {
            document.querySelectorAll('.tilt').forEach(el => {
                el.addEventListener('mousemove', e => {
                    const r = el.getBoundingClientRect();
                    const x = (e.clientX - r.left) / r.width - 0.5;
                    const y = (e.clientY - r.top) / r.height - 0.5;
                    el.style.transform = `perspective(900px) rotateX(${(-y * 6)}deg) rotateY(${x * 8}deg) translateZ(6px)`;
                });
                el.addEventListener('mouseleave', () => el.style.transform = 'translateZ(0)');
            });
        }

        /* ---------------- Modal ---------------- */
        async function openModal(anime) {
            activeAnime = anime;
            
            // Set tab to overview
            switchTab('overview');
            
            // Basic info
            modalTitle.textContent = anime.title;
            modalPoster.src = anime.images?.jpg?.large_image_url || anime.images?.webp?.large_image_url || '';
            modalPoster.onerror = function() {
                this.src = 'https://via.placeholder.com/300x400/8a2be2/ffffff?text=No+Image';
            };
            
            modalSynopsis.textContent = anime.synopsis || 'No synopsis available.';
            modalRating.textContent = anime.score || 'N/A';
            modalEpisodes.textContent = anime.episodes || 'Unknown';
            modalStatus.textContent = anime.status || 'Unknown';
            modalType.textContent = anime.type || 'Unknown';
            modalDuration.textContent = anime.duration || 'Unknown';
            modalAired.textContent = anime.aired?.string || 'Unknown';
            
            // Season info
            if (anime.season && anime.year) {
                modalSeason.textContent = `${anime.season.charAt(0).toUpperCase() + anime.season.slice(1)} ${anime.year}`;
            } else {
                modalSeason.textContent = 'Unknown';
            }
            
            // Genres
            modalGenres.innerHTML = '';
            if (anime.genres && anime.genres.length > 0) {
                anime.genres.forEach(genre => {
                    const genreBadge = document.createElement('span');
                    genreBadge.textContent = genre.name;
                    genreBadge.style.cssText = 'padding:4px 8px;background:rgba(138,43,226,0.2);border-radius:4px;font-size:0.8rem;';
                    modalGenres.appendChild(genreBadge);
                });
            } else {
                modalGenres.innerHTML = '<span style="color:var(--muted);">No genres listed</span>';
            }
            
            // Studios
            modalStudios.textContent = anime.studios?.map(s => s.name).join(', ') || 'Unknown';
            
            // Additional info
            modalBackground.textContent = anime.background || 'No background information available.';
            modalProducers.textContent = anime.producers?.map(p => p.name).join(', ') || 'Unknown';
            modalLicensors.textContent = anime.licensors?.map(l => l.name).join(', ') || 'Unknown';
            modalSource.textContent = anime.source || 'Unknown';
            modalPremiered.textContent = anime.season ? `${anime.season.charAt(0).toUpperCase() + anime.season.slice(1)} ${anime.year || ''}`.trim() : 'Unknown';
            modalBroadcastTime.textContent = anime.broadcast?.string || 'Unknown';
            modalAgeRating.textContent = anime.rating || 'Unknown';
            
            // Stats
            modalRank.textContent = `#${anime.rank || 'N/A'}`;
            modalPopularity.textContent = `#${anime.popularity || 'N/A'}`;
            modalMembers.textContent = formatNumber(anime.members || 0);
            modalFavorites.textContent = formatNumber(anime.favorites || 0);
            
            // Watch button - FIXED: More visible
            watchBtn.onclick = () => {
                const q = encodeURIComponent(anime.title);
                window.open(`https://hianime.to/search?keyword=${q}`, '_blank');
            };
            
            // Add to List button - FIXED: More visible
            addToListBtn.onclick = () => {
                openAddToListModal(anime);
            };
            
            // Load cast data
            await loadCast(anime.mal_id);
            
            // Load related anime
            await loadRelatedAnime(anime.mal_id);
            
            // Setup review form
            setupReviewForm();
            renderReviews(anime.mal_id, currentReviewCategory);
            reviewFormExpanded.style.display = 'none';
            openReviewFormBtn.style.display = 'inline-flex';
            
            modal.classList.add('active');
        }

        function switchTab(tabName) {
            // Update tabs
            modalTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update content
            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Tab click handlers
        modalTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        /* ---------------- Cast Section (All Characters) ---------------- */
        async function loadCast(animeId) {
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/characters`);
                const data = await res.json();
                castGrid.innerHTML = '';
                
                if (data.data && data.data.length > 0) {
                    // Show ALL characters (removed the .slice(0, 12) limit)
                    data.data.forEach(character => {
                        const castCard = document.createElement('div');
                        castCard.className = 'cast-card';
                        castCard.innerHTML = `
                            <img src="${character.character.images.jpg.image_url}" 
                                 alt="${character.character.name}" 
                                 class="cast-img"
                                 onerror="this.src='https://via.placeholder.com/80x80/8a2be2/ffffff?text=?'" />
                            <div class="cast-name">${escapeHtml(character.character.name)}</div>
                            <div class="cast-role">${escapeHtml(character.role)}</div>
                        `;
                        
                        // Add click event to show character details
                        castCard.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showCharacterDetails(character.character);
                        });
                        
                        castGrid.appendChild(castCard);
                    });
                } else {
                    castGrid.innerHTML = '<p style="color:var(--muted);grid-column:1/-1;text-align:center;">No cast information available</p>';
                }
            } catch (error) {
                console.error('Failed to load cast:', error);
                castGrid.innerHTML = '<p style="color:var(--muted);grid-column:1/-1;text-align:center;">Failed to load cast</p>';
            }
        }

        /* ---------------- Load Related Anime - FIXED: Smooth transition ---------------- */
        async function loadRelatedAnime(animeId) {
            try {
                // First hide the section
                relatedAnimeSection.style.display = 'none';
                relatedAnimeGrid.innerHTML = '';
                
                // Fetch anime details with relations
                const response = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/full`);
                const data = await response.json();
                
                if (data.data && data.data.relations && data.data.relations.length > 0) {
                    // Filter for specific relation types we want to show
                    const wantedRelations = ['Sequel', 'Prequel', 'Alternative version', 'Spin-off', 'Summary', 'Adaptation', 'Side story', 'Other', 'Parent story', 'Alternative setting', 'Full story'];
                    
                    // Get all related anime entries
                    let allRelated = [];
                    
                    data.data.relations.forEach(relation => {
                        if (wantedRelations.includes(relation.relation)) {
                            relation.entry.forEach(entry => {
                                if (entry.type === 'anime') {
                                    allRelated.push({
                                        mal_id: entry.mal_id,
                                        title: entry.name,
                                        relation: relation.relation
                                    });
                                }
                            });
                        }
                    });
                    
                    // If we have related anime, fetch their details
                    if (allRelated.length > 0) {
                        // Limit to 8 related anime
                        allRelated = allRelated.slice(0, 8);
                        
                        // Show loading in the grid
                        relatedAnimeGrid.innerHTML = `
                            <div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:20px;">
                                <div class="loader" style="width:30px;height:30px;border:3px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px;"></div>
                                Loading related anime...
                            </div>
                        `;
                        relatedAnimeSection.style.display = 'block';
                        
                        // Fetch details for each related anime
                        const relatedPromises = allRelated.map(async (related) => {
                            try {
                                const res = await fetch(`https://api.jikan.moe/v4/anime/${related.mal_id}`);
                                const animeData = await res.json();
                                return {
                                    ...related,
                                    data: animeData.data
                                };
                            } catch (error) {
                                console.error(`Failed to fetch anime ${related.mal_id}:`, error);
                                return related;
                            }
                        });
                        
                        const relatedWithDetails = await Promise.all(relatedPromises);
                        
                        // Render the related anime
                        renderRelatedAnime(relatedWithDetails);
                    }
                }
            } catch (error) {
                console.error('Failed to load related anime:', error);
                // Hide the section if there's an error
                relatedAnimeSection.style.display = 'none';
            }
        }

        function renderRelatedAnime(relatedAnimeList) {
            relatedAnimeGrid.innerHTML = '';
            
            if (!relatedAnimeList || relatedAnimeList.length === 0) {
                relatedAnimeSection.style.display = 'none';
                return;
            }
            
            // Filter out any entries without data
            const validRelated = relatedAnimeList.filter(item => item.data);
            
            if (validRelated.length === 0) {
                relatedAnimeSection.style.display = 'none';
                return;
            }
            
            validRelated.forEach(related => {
                const anime = related.data;
                const card = document.createElement('div');
                card.className = 'related-anime-card';
                
                const imageUrl = anime.images?.jpg?.small_image_url || anime.images?.webp?.small_image_url || 'https://via.placeholder.com/150x120/8a2be2/ffffff?text=Anime';
                
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${anime.title}" 
                         onerror="this.src='https://via.placeholder.com/150x120/8a2be2/ffffff?text=Anime'">
                    <div class="related-anime-info">
                        <div class="related-anime-title">${escapeHtml(anime.title.length > 40 ? anime.title.substring(0, 40) + '...' : anime.title)}</div>
                        <div class="related-anime-type">${anime.type || 'TV'}</div>
                        <div class="related-anime-relation">${related.relation}</div>
                    </div>
                `;
                
                // FIXED: Smooth transition without redirecting to home page
                card.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Add loading state to modal
                    modalTitle.textContent = 'Loading...';
                    modalSynopsis.textContent = 'Loading anime details...';
                    modalPoster.src = '';
                    
                    // Keep the modal open and just update the content
                    try {
                        // Fetch the anime details
                        const response = await fetch(`https://api.jikan.moe/v4/anime/${anime.mal_id}`);
                        const animeData = await response.json();
                        
                        if (animeData.data) {
                            // Update the modal with new anime data
                            openModal(animeData.data);
                        }
                    } catch (error) {
                        console.error('Failed to load anime details:', error);
                        alert('Failed to load anime details. Please try again.');
                    }
                });
                
                relatedAnimeGrid.appendChild(card);
            });
            
            // Show the section
            relatedAnimeSection.style.display = 'block';
        }

        /* ---------------- Character Details Modal ---------------- */
        async function showCharacterDetails(character) {
            // Show loading state
            characterContent.innerHTML = `
                <div class="character-loading">
                    <div class="spinner"></div>
                    <div>Loading character details...</div>
                </div>
            `;
            
            characterModal.classList.add('active');
            
            try {
                // Check cache first
                const characterId = character.mal_id;
                
                if (characterCache[characterId]) {
                    renderCharacterDetails(characterCache[characterId]);
                    return;
                }
                
                // Fetch character details from Jikan API
                const response = await fetch(`https://api.jikan.moe/v4/characters/${characterId}/full`);
                const data = await response.json();
                
                if (data.data) {
                    // Cache the character data
                    characterCache[characterId] = data.data;
                    renderCharacterDetails(data.data);
                } else {
                    throw new Error('No character data found');
                }
            } catch (error) {
                console.error('Failed to load character details:', error);
                // Fallback to basic character info
                renderCharacterDetails({
                    name: character.name,
                    images: character.images,
                    about: 'Character details could not be loaded. Please try again later.',
                    favorites: character.favorites || 0,
                    nicknames: [],
                    name_kanji: null
                });
            }
        }

        function renderCharacterDetails(characterData) {
            // Extract character details
            const about = characterData.about || 'No description available.';
            const nicknames = characterData.nicknames || [];
            const nameKanji = characterData.name_kanji || 'N/A';
            const favorites = characterData.favorites || 0;
            const image = characterData.images?.jpg?.image_url || 'https://via.placeholder.com/200x250/8a2be2/ffffff?text=Character';
            
            // Extract additional details if available
            const details = {};
            
            // Try to extract age from about text (common pattern)
            let ageMatch = about.match(/\b(\d{1,3})\s*(?:years? old|yo|year-old)\b/i);
            if (ageMatch) details.age = ageMatch[1];
            
            // Try to extract birthday from about text
            let birthdayMatch = about.match(/\b(?:born on|birthday|birth date)[:\s]*([A-Za-z]+\s+\d{1,2}(?:,\s*\d{4})?)\b/i);
            if (birthdayMatch) details.birthday = birthdayMatch[1];
            
            // Try to extract height from about text
            let heightMatch = about.match(/\b(\d{2,3}\s*cm|\d'\d{1,2}"?)\b/i);
            if (heightMatch) details.height = heightMatch[1];
            
            characterContent.innerHTML = `
                <h2 style="color:var(--neon);margin-bottom:20px;text-align:center;">${escapeHtml(characterData.name)}</h2>
                <div class="character-content">
                    <div>
                        <img src="${image}" alt="${characterData.name}" 
                             onerror="this.src='https://via.placeholder.com/200x250/8a2be2/ffffff?text=Character'">
                    </div>
                    <div class="character-info">
                        <h3 style="color:var(--accent);margin-bottom:12px;">Character Details</h3>
                        <p style="color:var(--muted);line-height:1.6;margin-bottom:20px;">${escapeHtml(about.substring(0, 500))}${about.length > 500 ? '...' : ''}</p>
                        
                        <div class="character-details-grid">
                            ${details.age ? `
                            <div class="character-detail-item">
                                <div class="label">Age</div>
                                <div class="value">${details.age}</div>
                            </div>` : ''}
                            
                            ${details.birthday ? `
                            <div class="character-detail-item">
                                <div class="label">Birthday</div>
                                <div class="value">${details.birthday}</div>
                            </div>` : ''}
                            
                            <div class="character-detail-item">
                                <div class="label">Japanese Name</div>
                                <div class="value">${escapeHtml(nameKanji)}</div>
                            </div>
                            
                            ${details.height ? `
                            <div class="character-detail-item">
                                <div class="label">Height</div>
                                <div class="value">${details.height}</div>
                            </div>` : ''}
                            
                            ${nicknames.length > 0 ? `
                            <div class="character-detail-item">
                                <div class="label">Nicknames</div>
                                <div class="value">${escapeHtml(nicknames.slice(0, 3).join(', '))}${nicknames.length > 3 ? '...' : ''}</div>
                            </div>` : ''}
                            
                            <div class="character-detail-item">
                                <div class="label">Favorites</div>
                                <div class="value">${formatNumber(favorites)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:24px;text-align:center;text-color:white;">
                            <button class="btn" id="add-to-favorites-btn" style = "color:white">
                                <i class="fas fa-heart"></i> Add to Favorites
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
                     document.getElementById('add-to-favorites-btn')?.addEventListener('click', async () => {
        const favorite = {
                id: characterData.mal_id, // Jikan API uses mal_id
                name: characterData.name,
                image_url: characterData.images?.jpg?.image_url,
                about: characterData.about,
                source: 'anime',
                added_date: Date.now()
        };

        const token = localStorage.getItem('token');
        if (token) {
            try {
                const res = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ item_id: String(favorite.id), item_type: 'anime', meta: favorite })
                });
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Failed to add favorite'); return; }
                let favs = JSON.parse(localStorage.getItem('ev_favorite_characters')) || [];
                if (!favs.some(f => String(f.id) === String(favorite.id))) {
                    favs.unshift(favorite);
                    localStorage.setItem('ev_favorite_characters', JSON.stringify(favs));
                }
                alert(`${characterData.name} added to favorites!`);
                return;
            } catch (e) {
                console.error('Failed to add favorite', e);
                alert('Network error while adding favorite');
                return;
            }
        }

        let favorites = JSON.parse(localStorage.getItem('ev_favorite_characters')) || [];
        if (!favorites.some(f => f.id === favorite.id)) {
                favorites.unshift(favorite);
                localStorage.setItem('ev_favorite_characters', JSON.stringify(favorites));
                alert(`${characterData.name} added to favorites!`);
        } else {
                alert(`${characterData.name} is already in your favorites.`);
        }
});
        }

        // Close character modal
        closeCharModalBtn.addEventListener('click', () => {
            characterModal.classList.remove('active');
        });

        characterModal.addEventListener('click', (e) => {
            if (e.target === characterModal) {
                characterModal.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && characterModal.classList.contains('active')) {
                characterModal.classList.remove('active');
            }
        });

        /* ---------------- Add to List Modal - UPDATED with review features ---------------- */
        function openAddToListModal(anime) {
            listAnimeTitle.textContent = anime.title;
            listNotes.value = '';
            listRating = 0;
            
            // Reset selection
            listOptions.forEach(option => option.classList.remove('active'));
            listOptions[0].classList.add('active');
            selectedListOption = 'watching';
            
            // Reset rating stars
            listRatingStars.forEach(star => star.classList.remove('active'));
            listRatingText.textContent = 'No rating';
            
            addToListModal.classList.add('active');
        }

        // List option selection
        listOptions.forEach(option => {
            option.addEventListener('click', () => {
                listOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedListOption = option.dataset.listType;
            });
        });

        // Rating stars in add-to-list modal
        listRatingStars.forEach(star => {
            star.addEventListener('click', () => {
                const value = parseInt(star.dataset.value);
                listRating = value;
                
                // Update star display
                listRatingStars.forEach((s, index) => {
                    if (index < value) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
                
                // Update rating text
                const ratingTexts = ['No rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                listRatingText.textContent = `${ratingTexts[value]} (${value}/5)`;
            });
        });

        // Close add to list modal
        closeListModalBtn.addEventListener('click', () => {
            addToListModal.classList.remove('active');
        });

        cancelAddToListBtn.addEventListener('click', () => {
            addToListModal.classList.remove('active');
        });

        confirmAddToListBtn.addEventListener('click', () => {
            if (activeAnime) {
                const notes = listNotes.value.trim();
                addAnimeToList(activeAnime, selectedListOption, notes, listRating);
                addToListModal.classList.remove('active');
                alert(`${activeAnime.title} added to your ${selectedListOption} list!`);
            }
        });

        addToListModal.addEventListener('click', (e) => {
            if (e.target === addToListModal) {
                addToListModal.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && addToListModal.classList.contains('active')) {
                addToListModal.classList.remove('active');
            }
        });

        /* ---------------- Enhanced Review Functions ---------------- */
        function setupReviewForm() {
            // Clear previous stars
            ['overall-rating', 'story-rating', 'animation-rating', 'characters-rating', 'sound-rating', 'enjoyment-rating'].forEach(id => {
                const container = document.getElementById(id);
                container.innerHTML = '';
                for (let i = 1; i <= 10; i++) {
                    const star = document.createElement('span');
                    star.className = 'rating-star';
                    star.innerHTML = 'â˜…';
                    star.dataset.value = i;
                    star.addEventListener('click', () => {
                        const stars = container.querySelectorAll('.rating-star');
                        stars.forEach((s, index) => {
                            s.classList.toggle('active', index < i);
                        });
                    });
                    container.appendChild(star);
                }
            });

            // Review options
            reviewOptions.forEach(option => {
                option.addEventListener('click', () => {
                    reviewOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });

            // Review categories
            reviewCategories.forEach(category => {
                category.addEventListener('click', () => {
                    reviewCategories.forEach(cat => cat.classList.remove('active'));
                    category.classList.add('active');
                    currentReviewCategory = category.dataset.category;
                    if (activeAnime) {
                        renderReviews(activeAnime.mal_id, currentReviewCategory);
                    }
                });
            });

            // Clear form
            reviewName.value = '';
            reviewTitle.value = '';
            reviewText.value = '';
            spoilerCheckbox.checked = false;
        }

        closeModalBtn.addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active') });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modal.classList.remove('active') });

        // Advanced search open/close handlers
        (function() {
            const advBtn = document.getElementById('filter-btn');
            const backBtn = document.getElementById('back-to-main');
            // If elements exist, wire them to show/hide the advanced search panel
            if (advBtn) {
                advBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (typeof searchPage !== 'undefined' && searchPage) {
                        // Hide main content and show advanced search
                        mainContent.style.display = 'none';
                        searchPage.classList.add('active');
                        searchPage.style.display = 'block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            }

            if (backBtn) {
                backBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (typeof searchPage !== 'undefined' && searchPage) {
                        searchPage.classList.remove('active');
                        searchPage.style.display = 'none';
                        mainContent.style.display = 'block';
                        window.scrollTo({ top: mainContent.offsetTop - 80, behavior: 'smooth' });
                    }
                });
            }
        })();

        /* ---------------- Reviews Storage ---------------- */
        function reviewsKey(id) { return `ev_reviews_${id}`; }
        function getReviews(id) { 
            try { 
                return JSON.parse(localStorage.getItem(reviewsKey(id)) || '[]');
            } catch (e) { 
                return []; 
            } 
        }
        
        function saveReviews(id, arr) { 
            localStorage.setItem(reviewsKey(id), JSON.stringify(arr)); 
        }
        
        function updateReviewStats(reviews) {
            if (!reviews || reviews.length === 0) {
                avgRatingEl.textContent = 'â€”';
                totalReviewsEl.textContent = '0';
                positiveReviewsEl.textContent = '0%';
                helpfulReviewsEl.textContent = '0';
                return;
            }
            
            // Calculate average rating
            const ratings = reviews.filter(r => r.overallRating).map(r => r.overallRating);
            const avgRating = ratings.length > 0 ? 
                (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 'â€”';
            avgRatingEl.textContent = avgRating;
            
            // Total reviews
            totalReviewsEl.textContent = reviews.length;
            
            // Positive reviews percentage
            const positiveCount = reviews.filter(r => r.recommendation === 'recommended').length;
            const positivePercentage = ((positiveCount / reviews.length) * 100).toFixed(0);
            positiveReviewsEl.textContent = `${positivePercentage}%`;
            
            // Helpful reviews (reviews with detailed text)
            const helpfulCount = reviews.filter(r => r.text && r.text.length > 100).length;
            helpfulReviewsEl.textContent = helpfulCount;
        }

        function renderReviews(id, category = 'all') {
            let arr = getReviews(id);
            
            // Update stats
            updateReviewStats(arr);
            
            // Filter by category
            let filteredReviews = [...arr];
            switch (category) {
                case 'positive':
                    filteredReviews = arr.filter(r => r.recommendation === 'recommended');
                    break;
                case 'negative':
                    filteredReviews = arr.filter(r => r.recommendation === 'not-recommended');
                    break;
                case 'recent':
                    filteredReviews = [...arr].sort((a, b) => b.ts - a.ts);
                    break;
                case 'helpful':
                    filteredReviews = arr.filter(r => r.helpfulVotes > 0).sort((a, b) => (b.helpfulVotes || 0) - (a.helpfulVotes || 0));
                    break;
                case 'detailed':
                    filteredReviews = arr.filter(r => r.text && r.text.length > 200);
                    break;
                default:
                    // 'all' - show all reviews, most recent first
                    filteredReviews = [...arr].sort((a, b) => b.ts - a.ts);
            }
            
            reviewsList.innerHTML = '';
            if (!filteredReviews.length) {
                let message = 'No reviews yet. Be the first to review!';
                if (category !== 'all') {
                    message = `No ${category} reviews found.`;
                }
                reviewsList.innerHTML = `<p style="color:var(--muted);text-align:center;padding:40px 20px;">${message}</p>`;
                return;
            }
            
            const frag = document.createDocumentFragment();
            filteredReviews.forEach(r => {
                const d = document.createElement('div');
                d.className = 'review-item';
                
                // Calculate average of all ratings
                const ratings = [r.overallRating, r.storyRating, r.animationRating, r.charactersRating, r.soundRating, r.enjoymentRating].filter(v => v);
                const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : null;
                
                let ratingsHtml = '';
                if (ratings.length > 0) {
                    ratingsHtml = `<div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                        ${avgRating ? `<span style="color:gold;font-weight:bold;display:flex;align-items:center;gap:4px;"><i class="fas fa-star"></i> ${avgRating}/10</span>` : ''}
                        ${r.overallRating ? `<span style="color:var(--muted);font-size:0.9rem;">Overall: ${r.overallRating}/10</span>` : ''}
                        ${r.storyRating ? `<span style="color:var(--muted);font-size:0.9rem;">Story: ${r.storyRating}/10</span>` : ''}
                        ${r.animationRating ? `<span style="color:var(--muted);font-size:0.9rem;">Animation: ${r.animationRating}/10</span>` : ''}
                        ${r.charactersRating ? `<span style="color:var(--muted);font-size:0.9rem;">Characters: ${r.charactersRating}/10</span>` : ''}
                        ${r.soundRating ? `<span style="color:var(--muted);font-size:0.9rem;">Sound: ${r.soundRating}/10</span>` : ''}
                        ${r.enjoymentRating ? `<span style="color:var(--muted);font-size:0.9rem;">Enjoyment: ${r.enjoymentRating}/10</span>` : ''}
                    </div>`;
                }
                
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div>
                            <strong>${escapeHtml(r.name || 'Anonymous')}</strong>
                            ${r.title ? `<div style="color:#fff;font-size:1.1rem;margin-top:4px;">${escapeHtml(r.title)}</div>` : ''}
                        </div>
                        ${r.recommendation ? `<span style="padding:6px 12px;border-radius:20px;background:${r.recommendation === 'recommended' ? 'rgba(76,175,80,0.2)' : r.recommendation === 'not-recommended' ? 'rgba(244,67,54,0.2)' : 'rgba(255,193,7,0.2)'};color:${r.recommendation === 'recommended' ? '#4caf50' : r.recommendation === 'not-recommended' ? '#f44336' : '#ffc107'};font-size:0.8rem;">${r.recommendation === 'recommended' ? 'âœ“ Recommended' : r.recommendation === 'not-recommended' ? 'Not Recommended' : 'Mixed Feelings'}</span>` : ''}
                    </div>
                    ${r.spoiler ? `<div style="background:rgba(255,107,107,0.1);padding:8px 12px;border-radius:6px;margin-bottom:12px;color:var(--accent);font-size:0.9rem;"><i class="fas fa-exclamation-triangle"></i> Contains Spoilers</div>` : ''}
                    ${ratingsHtml}
                    <div style="color:var(--muted);line-height:1.5">${escapeHtml(r.text)}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
                        <div style="color:var(--muted);font-size:0.75rem">â€” ${new Date(r.ts).toLocaleString()}</div>
                        <div style="display:flex;gap:8px;">
                            <button class="list-item-action-btn helpful-btn" data-id="${r.ts}">
                                <i class="fas fa-thumbs-up"></i> Helpful (${r.helpfulVotes || 0})
                            </button>
                        </div>
                    </div>`;
                frag.appendChild(d);
            });
            reviewsList.appendChild(frag);
            
            // Add helpful button functionality
            document.querySelectorAll('.helpful-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reviewId = this.dataset.id;
                    const reviews = getReviews(id);
                    const reviewIndex = reviews.findIndex(r => r.ts == reviewId);
                    
                    if (reviewIndex !== -1) {
                        if (!reviews[reviewIndex].helpfulVotes) {
                            reviews[reviewIndex].helpfulVotes = 0;
                        }
                        reviews[reviewIndex].helpfulVotes += 1;
                        saveReviews(id, reviews);
                        renderReviews(id, currentReviewCategory);
                    }
                });
            });
        }

        openReviewFormBtn.addEventListener('click', () => { 
            reviewFormExpanded.style.display = 'block'; 
            openReviewFormBtn.style.display = 'none'; 
        });

        reviewCancelBtn.addEventListener('click', () => { 
            reviewFormExpanded.style.display = 'none'; 
            openReviewFormBtn.style.display = 'inline-flex'; 
        });

      // --- NEW REVIEW SUBMISSION LOGIC ---
reviewSubmitBtn.addEventListener('click', () => {
    // 1. Check if user is logged in
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        alert("You must be logged in to write a review!");
        return;
    }

    // 2. Check if an anime is currently selected
    if (!activeAnime) return; 

    // 3. Get values from the form
    const text = reviewText.value.trim();
    
    // Calculate rating from the stars you clicked (we look for stars with class 'active')
    const getRatingCount = (id) => document.querySelectorAll(`#${id} .rating-star.active`).length;
    const overallRating = getRatingCount('overall-rating');

    // Simple validation
    if (!text && overallRating === 0) { 
        alert('Please provide a rating or write a review.'); 
        return; 
    }

    // 4. Create the Review Object
    // We add 'userId' so we know WHO wrote it.
    const newReview = {
        id: Date.now().toString(),            // Unique ID for the review
        userId: currentUser.id,               // YOUR User ID
        userName: currentUser.name || 'User', // Your Name
        itemId: activeAnime.mal_id,           // The ID of the Anime
        itemTitle: activeAnime.title,         // Title of the Anime
        category: 'anime',                    // Category
        rating: overallRating,
        text: text,
        spoiler: spoilerCheckbox.checked,
        date: new Date().toISOString()
    };

    const token = localStorage.getItem('token');
    if (token) {
        (async () => {
            try {
                const res = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ item_id: String(activeAnime.mal_id), item_type: 'anime', rating: overallRating, title: reviewTitle.value || null, body: text })
                });
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Failed to post review'); return; }
                try {
                    const r = await fetch(`/api/reviews?item_id=${encodeURIComponent(activeAnime.mal_id)}`);
                    if (r.ok) {
                        const list = await r.json();
                        const mapped = list.map(it => ({
                            id: it.id,
                            userId: it.user_id,
                            name: it.user_name || it.name || 'User',
                            itemId: it.item_id,
                            itemTitle: it.title || it.item_id,
                            category: it.item_type,
                            overallRating: it.rating,
                            text: it.body,
                            spoiler: false,
                            ts: Date.parse(it.created_at) || Date.now()
                        }));
                        saveReviews(activeAnime.mal_id, mapped);
                        renderReviews(activeAnime.mal_id, currentReviewCategory);
                    }
                } catch (e) { console.warn('Failed to refresh reviews from server', e); }

                document.getElementById('review-form-expanded').style.display = 'none';
                document.getElementById('open-review-form-btn').style.display = 'inline-flex';
                reviewText.value = '';
                reviewTitle.value = '';
                alert('Review published!');
            } catch (e) {
                console.error('Failed to post review', e);
                alert('Network error while posting review');
            }
        })();
        return;
    }

    // 5. Save to GLOBAL storage (guest fallback)
    const allReviews = JSON.parse(localStorage.getItem('ev_all_reviews')) || [];
    allReviews.unshift(newReview);
    localStorage.setItem('ev_all_reviews', JSON.stringify(allReviews));

    // 6. Update the UI on the current page immediately
    if(typeof renderReviews === 'function') {
        renderReviews(activeAnime.mal_id, currentReviewCategory); 
    }

    // 7. Reset and Close Form
    document.getElementById('review-form-expanded').style.display = 'none';
    document.getElementById('open-review-form-btn').style.display = 'inline-flex';
    reviewText.value = '';
    reviewTitle.value = '';
    alert('Review published! (stored locally)');
});

        /* ---------------- Advanced Search Page - UPDATED: Removed themes and demographics, added all genres ---------------- */
        async function fetchGenresFromJikan() {
            try {
                const response = await fetch('https://api.jikan.moe/v4/genres/anime');
                const data = await response.json();
                if (data.data) {
                    return data.data.map(genre => ({
                        id: genre.mal_id,
                        name: genre.name,
                        count: genre.count || Math.floor(Math.random() * 5000) + 100 // Use actual count or generate placeholder
                    }));
                }
                return [];
            } catch (error) {
                console.error('Failed to fetch genres:', error);
                // Return fallback genres if API fails
                return [
                    { id: 1, name: 'Action', count: 4769 },
                    { id: 2, name: 'Adventure', count: 4490 },
                    { id: 4, name: 'Comedy', count: 7781 },
                    { id: 8, name: 'Drama', count: 3116 },
                    { id: 10, name: 'Fantasy', count: 5998 },
                    { id: 14, name: 'Horror', count: 399 },
                    { id: 7, name: 'Mystery', count: 2015 },
                    { id: 22, name: 'Romance', count: 2221 },
                    { id: 24, name: 'Sci-Fi', count: 3523 },
                    { id: 36, name: 'Slice of Life', count: 1253 },
                    { id: 30, name: 'Sports', count: 824 },
                    { id: 37, name: 'Supernatural', count: 1498 },
                    { id: 9, name: 'Ecchi', count: 822 },
                    { id: 40, name: 'Psychological', count: 467 },
                    { id: 21, name: 'Samurai', count: 253 },
                    { id: 23, name: 'School', count: 2253 },
                    { id: 31, name: 'Super Power', count: 733 },
                    { id: 20, name: 'Parody', count: 805 },
                    { id: 32, name: 'Martial Arts', count: 761 },
                    { id: 13, name: 'Historical', count: 1297 }
                ];
            }
        }

        async function setupAdvancedSearchPage() {
            // Setup year dropdown
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1990; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // Fetch genres from Jikan API
            const genres = await fetchGenresFromJikan();
            
            // Setup genres - All genres from Jikan API
            genresFilter.innerHTML = '';
            genres.forEach(genre => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="genre-${genre.id}" value="${genre.id}">
                    <label for="genre-${genre.id}">${genre.name}</label>
                    <span class="count">${genre.count}</span>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        // Clear other active filters
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'genre';
                        currentSearchValue = genre.id;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                // Clicking on the label or div should toggle the checkbox
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                genresFilter.appendChild(option);
            });

            // Setup status
            filterData.status.forEach(status => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="status-${status.id}" value="${status.id}">
                    <label for="status-${status.id}">${status.name}</label>
                    <span class="count">${status.count}</span>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'status';
                        currentSearchValue = status.id;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                statusFilter.appendChild(option);
            });

            // Setup rating
            filterData.rating.forEach(rating => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="rating-${rating.id}" value="${rating.id}">
                    <label for="rating-${rating.id}">${rating.name}</label>
                    <span class="count">${rating.count}</span>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'rating';
                        currentSearchValue = rating.id;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                ratingFilter.appendChild(option);
            });

            // Setup type
            filterData.type.forEach(type => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="type-${type.id}" value="${type.id}">
                    <label for="type-${type.id}">${type.name}</label>
                    <span class="count">${type.count}</span>
                `;
                
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        clearActiveFilters();
                        checkbox.checked = true;
                        
                        currentSearchType = 'type';
                        currentSearchValue = type.id;
                        currentSearchPage = 1;
                        
                        performCategorySearch();
                    }
                });
                
                option.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                typeFilter.appendChild(option);
            });

            // Setup sort
            sortSelect.value = currentSearchSort;
            sortSelect.addEventListener('change', () => {
                currentSearchSort = sortSelect.value;
                if (currentSearchType && currentSearchValue) {
                    performCategorySearch();
                }
            });

            // Season and year selects
            seasonSelect.addEventListener('change', () => {
                if (seasonSelect.value && yearSelect.value) {
                    clearActiveFilters();
                    currentSearchType = 'season';
                    currentSearchValue = `${seasonSelect.value}_${yearSelect.value}`;
                    currentSearchPage = 1;
                    performCategorySearch();
                }
            });

            yearSelect.addEventListener('change', () => {
                if (seasonSelect.value && yearSelect.value) {
                    clearActiveFilters();
                    currentSearchType = 'season';
                    currentSearchValue = `${seasonSelect.value}_${yearSelect.value}`;
                    currentSearchPage = 1;
                    performCategorySearch();
                }
            });

            // Search input
            advSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = advSearchInput.value.trim();
                    if (query) {
                        clearActiveFilters();
                        currentSearchType = 'search';
                        currentSearchValue = query;
                        currentSearchPage = 1;
                        performCategorySearch();
                    }
                }
            });
        }

        function clearActiveFilters() {
            // Remove checked state from all filter checkboxes
            document.querySelectorAll('.filter-option input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        async function performCategorySearch() {
            if (!currentSearchType || !currentSearchValue) return;
            
            isLoading = true;
            searchResultsGrid.innerHTML = `
                <div class="loader" style="grid-column:1/-1;margin:60px auto;width:60px;height:60px;border:5px solid rgba(138,43,226,0.18);border-bottom-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite"></div>
            `;
            
            try {
                let url;
                
                // Build URL based on search type
                if (currentSearchType === 'search') {
                    url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(currentSearchValue)}&page=${currentSearchPage}&limit=24&order_by=${currentSearchSort}&sort=desc`;
                } else if (currentSearchType === 'genre') {
                    url = `https://api.jikan.moe/v4/anime?genres=${currentSearchValue}&page=${currentSearchPage}&limit=24&order_by=${currentSearchSort}&sort=desc`;
                } else if (currentSearchType === 'status') {
                    url = `https://api.jikan.moe/v4/anime?status=${currentSearchValue}&page=${currentSearchPage}&limit=24&order_by=${currentSearchSort}&sort=desc`;
                } else if (currentSearchType === 'rating') {
                    url = `https://api.jikan.moe/v4/anime?rating=${currentSearchValue}&page=${currentSearchPage}&limit=24&order_by=${currentSearchSort}&sort=desc`;
                } else if (currentSearchType === 'type') {
                    url = `https://api.jikan.moe/v4/anime?type=${currentSearchValue}&page=${currentSearchPage}&limit=24&order_by=${currentSearchSort}&sort=desc`;
                } else if (currentSearchType === 'season') {
                    const [season, year] = currentSearchValue.split('_');
                    url = `https://api.jikan.moe/v4/anime?season=${season}&season_year=${year}&page=${currentSearchPage}&limit=24&order_by=${currentSearchSort}&sort=desc`;
                }
                
                console.log('Fetching:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    renderSearchResults(data.data, data.pagination);
                } else {
                    searchResultsGrid.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <h3>No results found</h3>
                            <p>Try selecting a different category</p>
                        </div>
                    `;
                    searchPagination.innerHTML = '';
                    resultsCount.textContent = '0 results found';
                }
            } catch (error) {
                console.error('Search error:', error);
                searchResultsGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Search failed</h3>
                        <p>Please try again later</p>
                    </div>
                `;
                searchPagination.innerHTML = '';
                resultsCount.textContent = 'Search failed';
            } finally {
                isLoading = false;
            }
        }

        function renderSearchResults(results, pagination) {
            searchResultsGrid.innerHTML = '';
            
            if (!results || results.length === 0) {
                searchResultsGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>No results found</h3>
                        <p>Try selecting a different category</p>
                </div>
                `;
                resultsCount.textContent = '0 results found';
                return;
            }
            
            resultsCount.textContent = `${results.length} results found`;
            
            results.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'search-result-card';
                card.dataset.anime = JSON.stringify(anime);
                
                const poster = anime.images?.jpg?.large_image_url || anime.images?.webp?.large_image_url || '';
                const score = anime.score || 'N/A';
                const episodes = anime.episodes || '?';
                const year = anime.year || anime.aired?.prop?.from?.year || 'TBA';
                
                let desc = anime.synopsis || '';
                if (desc.length > 150) desc = desc.substring(0, 150) + '...';
                
                card.innerHTML = `
                    <img src="${poster}" alt="${anime.title}" class="search-result-img"
                         onerror="this.src='https://via.placeholder.com/300x200/8a2be2/ffffff?text=No+Image'">
                    <div class="search-result-info">
                        <div class="search-result-title">${escapeHtml(anime.title)}</div>
                        <div class="search-result-meta">
                            <span><i class="fas fa-star" style="color:gold;"></i> ${score}</span>
                            <span>${episodes} eps</span>
                            <span>${year}</span>
                        </div>
                        <div class="search-result-desc">${escapeHtml(desc)}</div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    const animeData = JSON.parse(card.dataset.anime);
                    openModal(animeData);
                });
                
                searchResultsGrid.appendChild(card);
            });
            
            if (pagination) {
                setupPagination(pagination, 'search');
            }
        }

        function changeSearchPage(page) {
            currentSearchPage = page;
            performCategorySearch();
            window.scrollTo({ top: searchResultsGrid.offsetTop - 100, behavior: 'smooth' });
        }

        /* ---------------- Page Navigation ---------------- */
        if (filterBtn) {
            filterBtn.addEventListener('click', () => {
                mainContent.style.display = 'none';
                myListSection.classList.remove('active');
                searchPage.classList.add('active');
                // Reset search state
                currentSearchType = null;
                currentSearchValue = null;
                currentSearchPage = 1;
                clearActiveFilters();
            });
        }

        backToMainBtn.addEventListener('click', () => {
            mainContent.style.display = 'block';
            myListSection.classList.remove('active');
            searchPage.classList.remove('active');
        });

        /* ---------------- My List Tab Navigation ---------------- */
        listTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                listTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                selectedListType = tab.dataset.listType;
                renderMyList(selectedListType);
            });
        });

        /* ---------------- Main Page Filters ---------------- */
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                currentFilter = e.currentTarget.dataset.filter;
                currentPage = 1;
                currentSearch = '';
                searchInput.value = '';
                fetchAnime(currentFilter, currentPage);
                window.scrollTo({ top: document.querySelector('.section').offsetTop - 80, behavior: 'smooth' });
            });
        });

        // Main page search
        searchInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') { 
                const q = searchInput.value.trim(); 
                if (!q) return; 
                currentSearch = q; 
                currentPage = 1; 
                fetchAnime('all', 1, q); 
            } 
        });

        /* ---------------- Initialize ---------------- */
        // Page init wrapped to surface runtime errors to UI
        try {
            console.log('anime page script loaded');
            (async function init() {
                loadHeroAndStrip();
                await setupAdvancedSearchPage();

                // CHECK FOR URL PARAMETERS
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q');

                if (query) {
                    searchInput.value = query;
                    currentSearch = query;
                    fetchAnime('all', 1, query);
                    setTimeout(() => {
                        window.scrollTo({ top: document.getElementById('anime-grid').offsetTop - 100, behavior: 'smooth' });
                    }, 500);
                } else {
                    fetchAnime('all', 1);
                }

                renderMyList(selectedListType);
                setTimeout(() => { loadHeroAndStrip(); }, 1200);
            })();
        } catch (err) {
            console.error('Initialization error (anime):', err);
            const g = document.getElementById('anime-grid');
            if (g) g.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--muted)">Initialization error: ${err?.message || err}</p>`;
        }

    </script>
    <script src="auth.js"></script>
        <script>
        (function(){
            const FADE_MS = 260;
            document.addEventListener('DOMContentLoaded', ()=> setTimeout(()=> document.body.classList.add('page-visible'), 20));
            document.addEventListener('click', function(e){
                const a = e.target.closest('a');
                if(!a) return;
                const href = a.getAttribute('href');
                if(!href || href.startsWith('http') || href.startsWith('#') || a.target === '_blank' || a.classList.contains('no-transition')) return;
                e.preventDefault();
                document.body.classList.remove('page-visible');
                setTimeout(()=> { window.location = href; }, FADE_MS);
            }, true);
        })();
        </script>
    </body>

</html>